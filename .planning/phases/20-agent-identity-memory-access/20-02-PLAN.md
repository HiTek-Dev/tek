---
phase: 20-agent-identity-memory-access
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/llm/registry.ts
  - packages/gateway/src/ws/handlers.ts
autonomous: true
requirements:
  - P20-PROVIDER
  - P20-AGENTS

must_haves:
  truths:
    - "Desktop chat does not crash with 'No such provider: anthropic' when provider key is missing"
    - "Clear error message tells user which provider is missing and how to configure it"
    - "isProviderAvailable() helper function validates provider registration before streaming"
  artifacts:
    - path: "packages/gateway/src/llm/registry.ts"
      provides: "isProviderAvailable helper for pre-stream validation"
      exports: ["isProviderAvailable"]
    - path: "packages/gateway/src/ws/handlers.ts"
      provides: "Provider validation guard before LLM streaming"
      contains: "PROVIDER_NOT_CONFIGURED"
  key_links:
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "packages/gateway/src/llm/registry.ts"
      via: "import { isProviderAvailable } from registry"
      pattern: "isProviderAvailable"
---

<objective>
Add provider validation before LLM streaming to prevent cryptic "No such provider" errors, and add an `isProviderAvailable()` helper to the registry.

Purpose: When a user's config specifies a model with a provider prefix (e.g., "anthropic:claude-sonnet-4-5-20250929") but the provider's API key is not configured, the gateway crashes with "No such provider: anthropic". This should be a clear, actionable error message instead.

Output: Updated `registry.ts` with `isProviderAvailable()` helper, and updated `handlers.ts` with pre-stream provider validation that returns a structured error.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-agent-identity-memory-access/20-RESEARCH.md
@packages/gateway/src/llm/registry.ts
@packages/gateway/src/ws/handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isProviderAvailable helper and provider validation in handlers</name>
  <files>packages/gateway/src/llm/registry.ts, packages/gateway/src/ws/handlers.ts</files>
  <action>
**In `packages/gateway/src/llm/registry.ts`:**

Add a new exported function after `getAvailableProviders()`:

```typescript
/**
 * Check if a specific provider is available (has API key or is always-on like Ollama).
 */
export function isProviderAvailable(providerName: string): boolean {
  const available = getAvailableProviders();
  return available.includes(providerName);
}
```

**In `packages/gateway/src/ws/handlers.ts`:**

1. Add `isProviderAvailable` to the import from `../llm/registry.js` (it already imports `resolveModelId` and `getAvailableProviders` — add to that import line).

2. After the `model = resolveModelId(model);` line (around line 303) and BEFORE the routing decision block, add provider validation:

```typescript
// Validate that the resolved provider is actually registered
const providerPrefix = model.split(":")[0];
if (!isProviderAvailable(providerPrefix)) {
  const available = getAvailableProviders();
  transport.send({
    type: "error",
    requestId: msg.id,
    code: "PROVIDER_NOT_CONFIGURED",
    message: `Provider "${providerPrefix}" is not configured. Available providers: ${available.join(", ")}. Run: tek keys add ${providerPrefix}`,
  });
  return;
}
```

Make sure to add this AFTER `resolveModelId(model)` but BEFORE the `sessionManager.addMessage()` call, so we don't persist a user message for a request that will immediately fail. If `addMessage` is called before `resolveModelId`, move the validation right after `resolveModelId` and before the streaming attempt.

Check the actual line order in handlers.ts carefully. The validation must happen:
- AFTER model resolution (so we know the provider)
- BEFORE streaming begins (so we fail fast with a clear message)

The `transport.send` with type "error" must match the existing error message pattern used in handlers.ts. Check what error format is already used and match it. If "error" type doesn't exist in the schema, use the existing error sending pattern (e.g., `stream.start` with error info, or whatever pattern is already established).
  </action>
  <verify>
Run `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc --noEmit -p packages/gateway/tsconfig.json 2>&1 | head -30` — no errors. Also verify `grep -n "isProviderAvailable\|PROVIDER_NOT_CONFIGURED" packages/gateway/src/ws/handlers.ts packages/gateway/src/llm/registry.ts` shows the new code.
  </verify>
  <done>
When a user's configured model references a provider without an API key, the gateway returns a clear "PROVIDER_NOT_CONFIGURED" error with the list of available providers and instructions to add the missing key, instead of crashing with "No such provider".
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify desktop agents page and chat error display</name>
  <files>apps/desktop/src/pages/AgentsPage.tsx, apps/desktop/src/pages/ChatPage.tsx</files>
  <action>
This is a verification and minor polish task. Read both files and check:

**AgentsPage.tsx:**
1. Verify it has three views: list, create, and detail (per Phase 19 implementation)
2. Verify the list view shows "Default Agent" plus any user-created agents
3. Verify the create flow creates agent directory and seeds identity files
4. Verify the detail view has tabs for editing SOUL.md, IDENTITY.md, STYLE.md, USER.md
5. If any view is missing or broken, fix it. If all views work, no changes needed.

**ChatPage.tsx:**
1. Verify error messages from the gateway are displayed to the user in the chat UI
2. Check if there's error handling for WebSocket messages with type "error"
3. If error messages are not displayed (e.g., the PROVIDER_NOT_CONFIGURED error from Task 1 would be invisible), add error display logic. Check the `useChat` hook or message handler for error handling.
4. If error handling already exists, no changes needed.

For ChatPage/useChat error handling, look for how `stream.error` or error-type messages are handled. If the PROVIDER_NOT_CONFIGURED error format from Task 1 wouldn't be caught, add a handler that displays it as a system message in the chat.

**Important:** Only make changes if something is actually broken or missing. This task is primarily verification. Document findings in the summary.
  </action>
  <verify>
Read both files and confirm: (1) AgentsPage has list/create/detail views, (2) ChatPage or useChat handles error messages from gateway. Run `npx tsc --noEmit -p apps/desktop/tsconfig.json 2>&1 | head -20` if any changes were made.
  </verify>
  <done>
Desktop agents page renders correctly with list/create/detail views. Chat page displays provider errors to the user (or was already handling errors correctly).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/gateway/tsconfig.json` passes without errors
2. `isProviderAvailable()` is exported from registry.ts
3. handlers.ts validates provider before streaming and sends structured error
4. Desktop agents page has 3 views (list, create, detail) — verified by reading source
5. Desktop chat handles error messages from gateway — verified by reading source
</verification>

<success_criteria>
- Missing provider causes a clear error message (not a crash) in both CLI and desktop chat
- Error message includes the missing provider name, available providers, and fix instructions
- Desktop agents page has functional list, create, and detail views
- Desktop chat displays provider errors to the user
- TypeScript compilation succeeds for both gateway and desktop packages
</success_criteria>

<output>
After completion, create `.planning/phases/20-agent-identity-memory-access/20-02-SUMMARY.md`
</output>
