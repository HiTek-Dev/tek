---
phase: 17-desktop-frontend-tauri
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - apps/desktop/src/lib/discovery.ts
  - apps/desktop/src/lib/process.ts
  - apps/desktop/src/hooks/useGateway.ts
  - apps/desktop/src/stores/app-store.ts
  - apps/desktop/src/pages/DashboardPage.tsx
  - apps/desktop/src/components/GatewayStatus.tsx
  - apps/desktop/src/App.tsx
autonomous: true
requirements:
  - DESK-02

must_haves:
  truths:
    - "App discovers whether gateway is running by reading runtime.json"
    - "User can start the gateway from the Dashboard with a button click"
    - "User can stop the gateway from the Dashboard"
    - "Gateway status (running/stopped, port, PID, uptime) is displayed"
  artifacts:
    - path: "apps/desktop/src/lib/discovery.ts"
      provides: "Gateway discovery via Tauri FS plugin reading runtime.json"
    - path: "apps/desktop/src/lib/process.ts"
      provides: "Gateway start/stop via Tauri shell plugin"
    - path: "apps/desktop/src/hooks/useGateway.ts"
      provides: "React hook for gateway lifecycle state"
    - path: "apps/desktop/src/pages/DashboardPage.tsx"
      provides: "Dashboard with gateway status and controls"
  key_links:
    - from: "apps/desktop/src/lib/discovery.ts"
      to: "$HOME/.config/tek/runtime.json"
      via: "Tauri FS plugin readTextFile"
      pattern: "readTextFile.*runtime\\.json"
    - from: "apps/desktop/src/lib/process.ts"
      to: "tek gateway start"
      via: "Tauri shell plugin Command.create"
      pattern: "Command\\.create.*tek"
    - from: "apps/desktop/src/hooks/useGateway.ts"
      to: "apps/desktop/src/lib/discovery.ts"
      via: "Periodic polling for gateway status"
      pattern: "discoverGateway"
---

<objective>
Implement gateway discovery, lifecycle management (start/stop), and a Dashboard page showing real-time gateway status with action controls.

Purpose: Users need to see if their gateway is running and control it visually without CLI commands.
Output: DashboardPage with live gateway status indicator and start/stop buttons.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-desktop-frontend-tauri/17-RESEARCH.md
@.planning/phases/17-desktop-frontend-tauri/17-01-SUMMARY.md
@packages/cli/src/lib/discovery.ts
@packages/core/src/config/constants.ts
@packages/core/src/config/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gateway discovery and process management modules</name>
  <files>
    apps/desktop/src/lib/discovery.ts
    apps/desktop/src/lib/process.ts
    apps/desktop/src/stores/app-store.ts
  </files>
  <action>
    **src/lib/discovery.ts:** Adapt from `packages/cli/src/lib/discovery.ts`. Use Tauri FS plugin instead of Node.js fs.

    ```
    import { readTextFile, exists } from '@tauri-apps/plugin-fs';
    import { homeDir, join } from '@tauri-apps/api/path';
    ```

    Export `RuntimeInfo` interface: `{ pid: number; port: number; startedAt: string }`.

    Export `async function discoverGateway(): Promise<RuntimeInfo | null>` that:
    1. Gets home dir via `homeDir()`
    2. Constructs path: `${home}/.config/tek/runtime.json`
    3. Checks `exists(path)`
    4. If exists, reads with `readTextFile(path)`, parses JSON, returns RuntimeInfo
    5. Catches errors, returns null

    **src/lib/process.ts:** Gateway process management via Tauri shell plugin.

    ```
    import { Command } from '@tauri-apps/plugin-shell';
    ```

    Export `async function startGateway(): Promise<{ success: boolean; error?: string }>` that:
    1. Creates command: `Command.create('tek', ['gateway', 'start'])`
    2. Executes and checks exit code
    3. Returns success/error result

    Export `async function stopGateway(): Promise<{ success: boolean; error?: string }>` that:
    1. Creates command: `Command.create('tek', ['gateway', 'stop'])`
    2. Executes and checks exit code
    3. Returns success/error result

    **src/stores/app-store.ts:** Zustand store for global app state.

    ```
    import { create } from 'zustand';
    ```

    Store interface:
    - `gateway: { status: 'unknown' | 'running' | 'stopped'; port: number | null; pid: number | null; startedAt: string | null }`
    - `setGateway(info: RuntimeInfo | null): void` -- updates gateway state
    - `currentPage: string` -- for navigation state (move from App.tsx useState)
    - `setCurrentPage(page: string): void`
  </action>
  <verify>
    - `cat apps/desktop/src/lib/discovery.ts` uses Tauri FS plugin imports
    - `cat apps/desktop/src/lib/process.ts` uses Tauri shell plugin Command.create
    - `cat apps/desktop/src/stores/app-store.ts` exports a Zustand store
  </verify>
  <done>Discovery reads runtime.json via Tauri FS, process management uses shell plugin, Zustand store holds gateway state</done>
</task>

<task type="auto">
  <name>Task 2: Gateway status hook and Dashboard page UI</name>
  <files>
    apps/desktop/src/hooks/useGateway.ts
    apps/desktop/src/pages/DashboardPage.tsx
    apps/desktop/src/components/GatewayStatus.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
    **src/hooks/useGateway.ts:** React hook that polls gateway status.

    Export `function useGateway()` that:
    1. Reads `gateway` state from Zustand store
    2. On mount, calls `discoverGateway()` and updates store
    3. Sets up `setInterval(5000)` to re-check gateway status (poll every 5s)
    4. Cleans up interval on unmount
    5. Returns `{ status, port, pid, startedAt, start, stop, refresh }` where start/stop call process.ts functions then refresh

    **src/components/GatewayStatus.tsx:** Status indicator component.

    Props: gateway state from useGateway hook.
    Renders:
    - Green dot + "Running" or Red dot + "Stopped" status text
    - When running: port number, PID, uptime (calculated from startedAt)
    - Start button (shown when stopped, green bg)
    - Stop button (shown when running, red bg)
    - Loading state while start/stop is in progress

    Style with Tailwind: rounded card with bg-gray-800, p-6, status dot as inline colored circle.

    **src/pages/DashboardPage.tsx:** Replace stub with real content.

    Layout:
    - Header: "Dashboard" with brief subtitle
    - GatewayStatus component (prominent, top of page)
    - Quick actions section below (placeholder cards for "Open Chat", "Manage Agents", "Settings" -- these link to respective pages via store.setCurrentPage)

    **src/App.tsx:** Update to use Zustand store for currentPage instead of local useState. Wire up quick action links to navigate.
  </action>
  <verify>
    - `pnpm tauri dev` shows Dashboard with gateway status
    - When gateway is running, green indicator shows with port and PID
    - When gateway is stopped, red indicator with Start button appears
    - Start/Stop buttons trigger tek CLI commands via shell plugin
  </verify>
  <done>Dashboard shows live gateway status with start/stop controls, polling every 5 seconds</done>
</task>

</tasks>

<verification>
- Gateway discovery correctly reads ~/.config/tek/runtime.json via Tauri FS plugin
- Starting gateway from UI runs `tek gateway start` via shell plugin
- Stopping gateway from UI runs `tek gateway stop` via shell plugin
- Status updates within 5 seconds of gateway state change
- Dashboard displays port, PID, and uptime when running
</verification>

<success_criteria>
Dashboard page shows real-time gateway status (running/stopped) with port, PID, and uptime. Users can start and stop the gateway with button clicks. Status auto-refreshes every 5 seconds.
</success_criteria>

<output>
After completion, create `.planning/phases/17-desktop-frontend-tauri/17-02-SUMMARY.md`
</output>
