---
phase: 28-testing-foundation
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/llm/router.test.ts
  - packages/gateway/src/agent/approval-gate.test.ts
autonomous: true
requirements:
  - TEST-03
  - TEST-05

must_haves:
  truths:
    - "classifyComplexity returns high tier for complexity keywords like 'analyze', 'design', 'refactor'"
    - "classifyComplexity returns budget tier for simple greetings like 'hi', 'thanks' with short messages and low history"
    - "classifyComplexity returns standard tier as default fallback for unmatched messages"
    - "classifyComplexity returns high tier for messages over 2000 chars or history over 20"
    - "checkApproval returns false for auto tier, true for always tier"
    - "checkApproval returns true then false for session tier after recordSessionApproval"
    - "perTool overrides defaultTier in approval policy"
    - "wrapToolWithApproval adds _approvalTier to tool object"
  artifacts:
    - path: "packages/gateway/src/llm/router.test.ts"
      provides: "LLM router classifyComplexity and routeMessage tests"
      min_lines: 60
    - path: "packages/gateway/src/agent/approval-gate.test.ts"
      provides: "Approval gate policy tests"
      min_lines: 50
  key_links:
    - from: "packages/gateway/src/llm/router.test.ts"
      to: "packages/gateway/src/llm/router.ts"
      via: "import classifyComplexity, routeMessage"
      pattern: "import.*router"
    - from: "packages/gateway/src/agent/approval-gate.test.ts"
      to: "packages/gateway/src/agent/approval-gate.ts"
      via: "import checkApproval, createApprovalPolicy, recordSessionApproval, wrapToolWithApproval"
      pattern: "import.*approval-gate"
---

<objective>
Write unit tests for the LLM router (classifyComplexity, routeMessage) and approval gate (checkApproval, createApprovalPolicy, recordSessionApproval, wrapToolWithApproval).

Purpose: Cover the two pure-function subsystems that control model selection and tool approval -- both are critical decision points with well-defined I/O.
Output: Two co-located test files with branch coverage for all tiers and policy combinations.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-testing-foundation/28-RESEARCH.md
@packages/gateway/src/llm/router.ts
@packages/gateway/src/llm/router-rules.ts
@packages/gateway/src/llm/types.ts
@packages/gateway/src/agent/approval-gate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: LLM router classifyComplexity and routeMessage tests</name>
  <files>packages/gateway/src/llm/router.test.ts</files>
  <action>
Create `router.test.ts` co-located beside `router.ts`. Import `classifyComplexity`, `routeMessage`, `getAlternatives` from `./router.js`. Mock `./registry.js` using `vi.mock("./registry.js")` for `routeMessage` tests that call `getAvailableProviders`.

**classifyComplexity tests (no mocking needed -- pure function):**
1. **High tier keywords:** Test each keyword ("analyze", "design", "refactor", "plan", "architect", "compare", "evaluate"). Each should return `{ tier: "high", confidence: 1.0 }`.
2. **High tier by message length:** Message with >2000 chars, historyLength=0. Returns `{ tier: "high", confidence: 0.7 }`.
3. **High tier by history length:** Short message, historyLength=25. Returns `{ tier: "high", confidence: 0.7 }`.
4. **Budget tier keywords:** "hi" with message.length < 200 and historyLength < 5. Returns `{ tier: "budget", confidence: 1.0 }`. Also test "thanks", "hello", "yes".
5. **Budget NOT matched when message too long:** "hi " repeated 100 times (>200 chars) should NOT match budget -- falls to standard.
6. **Budget NOT matched when history too long:** "hi" with historyLength=10 should NOT match budget -- falls to standard.
7. **Standard default:** "tell me about cats" with historyLength=5. Returns `{ tier: "standard", confidence: 0.5 }`.
8. **Custom rules:** Pass custom rules array overriding defaults; verify custom rule is used.

**routeMessage tests (mock registry):**
9. **Preferred provider available:** Mock `getAvailableProviders` to return `["anthropic"]`. routeMessage("analyze this", 0) returns provider="anthropic" with tier="high".
10. **Preferred provider unavailable, fallback:** Mock `getAvailableProviders` to return `["openai"]` (not "anthropic"). Verify fallback logic returns available provider with reduced confidence.
11. **No provider available:** Mock `getAvailableProviders` to return `[]`. Verify it returns original decision (last resort).

**getAlternatives tests:**
12. **Returns non-selected tiers:** Given a decision with tier="standard", returns high and budget alternatives (if different model IDs).

**IMPORTANT:** The DEFAULT_RULES sort by priority ascending, so high (priority 1) is checked before standard (priority 2) before budget (priority 3). Budget only matches when message is short AND historyLength < 5 AND has a simple keyword. Use `.js` extension in all import paths.
  </action>
  <verify>Run `pnpm vitest run packages/gateway/src/llm/router.test.ts` -- all tests pass.</verify>
  <done>classifyComplexity correctly classifies high/budget/standard tiers for keyword, length, history, and default cases. routeMessage handles provider availability and fallback. getAlternatives returns non-selected options.</done>
</task>

<task type="auto">
  <name>Task 2: Approval gate policy tests</name>
  <files>packages/gateway/src/agent/approval-gate.test.ts</files>
  <action>
Create `approval-gate.test.ts` co-located beside `approval-gate.ts`. Import all 4 exported functions from `./approval-gate.js`. No mocking needed -- all functions are pure.

**createApprovalPolicy tests:**
1. **Default policy:** `createApprovalPolicy()` (no args) returns `{ defaultTier: "session", perTool: {}, sessionApprovals: Set(0) }`.
2. **Custom config:** `createApprovalPolicy({ defaultTier: "always", perTool: { shell: "auto" } })` returns correct policy.

**checkApproval tests:**
3. **Auto tier:** Create policy with `defaultTier: "auto"`. `checkApproval("any-tool", policy)` returns `false`.
4. **Always tier:** Create policy with `defaultTier: "always"`. `checkApproval("any-tool", policy)` returns `true`.
5. **Session tier -- first call:** Create policy with `defaultTier: "session"`. `checkApproval("shell", policy)` returns `true`.
6. **Session tier -- after approval:** After `recordSessionApproval("shell", policy)`, `checkApproval("shell", policy)` returns `false`.
7. **Session tier -- different tool still needs approval:** After approving "shell", `checkApproval("fetch", policy)` still returns `true`.
8. **perTool override:** Policy with `defaultTier: "session"` and `perTool: { shell: "auto" }`. `checkApproval("shell", policy)` returns `false`, `checkApproval("fetch", policy)` returns `true`.

**recordSessionApproval tests:**
9. **Adds to sessionApprovals set:** Record approval, verify `policy.sessionApprovals.has("shell")` is true.
10. **Idempotent:** Recording twice doesn't break anything.

**wrapToolWithApproval tests:**
11. **Adds _approvalTier:** `wrapToolWithApproval("shell", { execute: vi.fn() }, policy)` returns object with `_approvalTier` matching the tool's effective tier.
12. **Preserves original properties:** Wrapped tool still has `execute` property.
13. **Uses perTool tier:** With `perTool: { shell: "auto" }`, `_approvalTier` is "auto".
  </action>
  <verify>Run `pnpm vitest run packages/gateway/src/agent/approval-gate.test.ts` -- all tests pass.</verify>
  <done>All 4 exported functions tested: createApprovalPolicy defaults, checkApproval for all 3 tiers with perTool override, recordSessionApproval state tracking, wrapToolWithApproval metadata injection.</done>
</task>

</tasks>

<verification>
```bash
# Run both test files
pnpm vitest run packages/gateway/src/llm/router.test.ts packages/gateway/src/agent/approval-gate.test.ts

# Verify from repo root
pnpm test
```
Both test files discovered and passing. Zero test failures.
</verification>

<success_criteria>
- router.test.ts covers classifyComplexity for all tier triggers (keywords, length, history, default), routeMessage with provider fallback, getAlternatives
- approval-gate.test.ts covers all 4 exported functions with all tier permutations and perTool overrides
- `pnpm test` from repo root discovers and runs both files
</success_criteria>

<output>
After completion, create `.planning/phases/28-testing-foundation/28-02-SUMMARY.md`
</output>
