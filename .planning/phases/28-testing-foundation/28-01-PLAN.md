---
phase: 28-testing-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/ws/protocol.test.ts
  - packages/core/src/config/schema.test.ts
autonomous: true
requirements:
  - TEST-01
  - TEST-04

must_haves:
  truths:
    - "All 28 ClientMessage types round-trip through Zod parse without data loss"
    - "All 27 ServerMessage types round-trip through Zod parse without data loss"
    - "Invalid message types are rejected by ClientMessageSchema and ServerMessageSchema"
    - "AppConfigSchema round-trips a full config and applies defaults for omitted fields"
    - "MCPServerConfig refine rejects configs missing both command and url"
    - "Older config shapes (missing optional fields) parse successfully via defaults"
  artifacts:
    - path: "packages/gateway/src/ws/protocol.test.ts"
      provides: "WebSocket protocol Zod round-trip tests"
      min_lines: 80
    - path: "packages/core/src/config/schema.test.ts"
      provides: "Config schema round-trip and migration tests"
      min_lines: 50
  key_links:
    - from: "packages/gateway/src/ws/protocol.test.ts"
      to: "packages/gateway/src/ws/protocol.ts"
      via: "import ClientMessageSchema, ServerMessageSchema"
      pattern: "import.*protocol"
    - from: "packages/core/src/config/schema.test.ts"
      to: "packages/core/src/config/schema.ts"
      via: "import AppConfigSchema, MCPServerConfigSchema"
      pattern: "import.*schema"
---

<objective>
Write Zod schema round-trip tests for the WebSocket protocol (all ClientMessage and ServerMessage types) and the AppConfig schema (defaults, validation, older format migration).

Purpose: Establish schema-level regression coverage for the two most critical data boundaries -- the WS wire protocol and the user config file format.
Output: Two co-located test files with full type coverage.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-testing-foundation/28-RESEARCH.md
@packages/gateway/src/ws/protocol.ts
@packages/core/src/config/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: WebSocket protocol round-trip tests</name>
  <files>packages/gateway/src/ws/protocol.test.ts</files>
  <action>
Create `protocol.test.ts` co-located beside `protocol.ts`. Import `ClientMessageSchema` and `ServerMessageSchema` from `./protocol.js`.

**ClientMessage tests:**
- Create a `CLIENT_MESSAGE_FIXTURES` record with one valid fixture per discriminated union variant. Use the research file's Example 1 as the fixture reference (28 types: chat.send, context.inspect, usage.query, session.list, chat.route.confirm, memory.search, thread.create, thread.list, thread.update, prompt.set, prompt.list, claude-code.start, claude-code.abort, tool.approval.response, preflight.approval, terminal.snapshot, terminal.control.grant, terminal.control.revoke, workflow.trigger, workflow.approval, workflow.list, workflow.execution.list, schedule.create, schedule.update, schedule.delete, schedule.list, heartbeat.configure, soul.evolution.response).
- Use `Object.entries(CLIENT_MESSAGE_FIXTURES).forEach(([type, fixture]) => { it(...) })` to generate one test per type that calls `ClientMessageSchema.parse(fixture)` and asserts deep equality with the input.
- Add a rejection test: `ClientMessageSchema.parse({ type: "nonexistent", id: "1" })` must throw.
- Add a test that a message missing required `id` field throws.

**ServerMessage tests:**
- Read `protocol.ts` to enumerate all ServerMessage union variants. Create `SERVER_MESSAGE_FIXTURES` with one valid fixture per type.
- Same pattern: forEach loop, parse + deep equality check.
- Add rejection test for unknown server message type.

**IMPORTANT:** Read `protocol.ts` carefully to get exact required fields for each message type. The research fixtures are a starting point but may need adjustment for fields the Zod schema actually requires. Use `.js` extension in import path to match ESM conventions used throughout the codebase.
  </action>
  <verify>Run `pnpm vitest run packages/gateway/src/ws/protocol.test.ts` -- all tests pass, zero failures.</verify>
  <done>Every ClientMessage and ServerMessage variant has a passing round-trip test; invalid types are rejected.</done>
</task>

<task type="auto">
  <name>Task 2: Config schema round-trip and migration tests</name>
  <files>packages/core/src/config/schema.test.ts</files>
  <action>
Create `schema.test.ts` co-located beside `schema.ts`. Import `AppConfigSchema`, `MCPServerConfigSchema`, `ToolApprovalConfigSchema`, `AgentDefinitionSchema` from `./schema.js`.

**AppConfigSchema tests:**
1. **Full config round-trip:** Create a complete valid config object with all fields populated. `AppConfigSchema.parse(fullConfig)` must equal the input.
2. **Minimal config with defaults:** Parse `{ securityMode: "full-control", createdAt: new Date().toISOString() }`. Verify `apiEndpoint.port` defaults to 3271, `apiEndpoint.host` defaults to "127.0.0.1", `onboardingComplete` defaults to false.
3. **Missing required fields rejected:** `AppConfigSchema.parse({})` must throw (missing securityMode, createdAt).
4. **Invalid securityMode rejected:** `AppConfigSchema.parse({ securityMode: "invalid", createdAt: "..." })` must throw.

**MCPServerConfigSchema tests:**
5. **stdio config valid:** `{ command: "node", args: ["server.js"] }` parses OK.
6. **http config valid:** `{ url: "http://localhost:3000", transport: "http" }` parses OK.
7. **Missing both command and url rejected:** `{ args: ["foo"] }` must fail the `.refine()` check.

**ToolApprovalConfigSchema tests:**
8. **Defaults applied:** Parse `{}`. Verify `defaultTier` defaults to "session", `approvalTimeout` defaults to 60000.

**Migration simulation tests:**
9. **Older config shape (no agents field):** Parse a config without `agents` -- must succeed since `agents` is optional.
10. **Older config shape (no ollamaEndpoints):** Parse a config without `ollamaEndpoints` or `modelAliases` -- must succeed.
  </action>
  <verify>Run `pnpm vitest run packages/core/src/config/schema.test.ts` -- all tests pass, zero failures.</verify>
  <done>AppConfigSchema round-trips full configs, applies correct defaults, rejects invalid input, and accepts older config shapes missing optional fields.</done>
</task>

</tasks>

<verification>
```bash
# Run both test files
pnpm vitest run packages/gateway/src/ws/protocol.test.ts packages/core/src/config/schema.test.ts

# Verify from repo root
pnpm test
```
Both test files discovered and passing. Zero test failures.
</verification>

<success_criteria>
- protocol.test.ts covers all 28 ClientMessage types and all 27 ServerMessage types with round-trip assertions
- schema.test.ts covers full config, minimal config with defaults, required field validation, MCPServerConfig refine, and older format migration
- `pnpm test` from repo root discovers and runs both files
</success_criteria>

<output>
After completion, create `.planning/phases/28-testing-foundation/28-01-SUMMARY.md`
</output>
