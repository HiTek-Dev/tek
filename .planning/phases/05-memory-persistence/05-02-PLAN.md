---
phase: 05-memory-persistence
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/db/src/memory/daily-logger.ts
  - packages/db/src/memory/memory-curator.ts
  - packages/db/src/memory/soul-manager.ts
  - packages/db/src/memory/embeddings.ts
  - packages/db/src/memory/index.ts
  - packages/db/src/index.ts
  - packages/db/package.json
  - packages/gateway/package.json
autonomous: true

must_haves:
  truths:
    - "Daily log entries are appended to memory/YYYY-MM-DD.md files with timestamped session headers"
    - "Long-term memory file (MEMORY.md) can be read and updated with new facts/preferences"
    - "Soul document (SOUL.md) can be loaded and its Learned Preferences section updated"
    - "Text can be embedded using AI SDK embed/embedMany and stored as vectors in vec_memories"
    - "Today and yesterday daily logs can be loaded for context injection"
  artifacts:
    - path: "packages/db/src/memory/daily-logger.ts"
      provides: "Append-only daily log management with date-based file rotation"
      exports: ["appendDailyLog", "loadRecentLogs", "getTodayLogPath"]
    - path: "packages/db/src/memory/memory-curator.ts"
      provides: "Read and update MEMORY.md with structured sections"
      exports: ["loadLongTermMemory", "addMemoryEntry", "getMemoryPath"]
    - path: "packages/db/src/memory/soul-manager.ts"
      provides: "Load SOUL.md and evolve Learned Preferences section"
      exports: ["loadSoul", "evolveSoul", "getSoulPath"]
    - path: "packages/db/src/memory/embeddings.ts"
      provides: "AI SDK embedding wrapper with vec_memories storage and batch support"
      exports: ["embedAndStore", "embedMany", "generateEmbedding"]
  key_links:
    - from: "packages/db/src/memory/daily-logger.ts"
      to: "packages/db/memory-files/daily/"
      via: "appendFileSync with YYYY-MM-DD.md naming"
      pattern: "appendFileSync.*daily"
    - from: "packages/db/src/memory/embeddings.ts"
      to: "vec_memories table"
      via: "INSERT INTO vec_memories with Float32Array blob"
      pattern: "vec_memories.*content_embedding"
    - from: "packages/db/src/memory/embeddings.ts"
      to: "ai SDK embed"
      via: "import { embed, embedMany } from 'ai'"
      pattern: "embed.*openai\\.embedding"
---

<objective>
Implement the memory layer: daily log management, long-term memory curation, soul document management, and embedding generation/storage.

Purpose: Build the read/write operations for all three memory tiers (daily logs, curated MEMORY.md, vector embeddings) so the gateway can persist and recall information.
Output: Four modules in packages/db/src/memory/ providing daily logging, memory curation, soul management, and embedding operations.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-memory-persistence/05-RESEARCH.md
@.planning/phases/05-memory-persistence/05-01-SUMMARY.md

@packages/db/src/connection.ts
@packages/db/src/index.ts
@packages/db/memory-files/SOUL.md
@packages/db/memory-files/MEMORY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Daily logger, memory curator, and soul manager</name>
  <files>
    packages/db/src/memory/daily-logger.ts
    packages/db/src/memory/memory-curator.ts
    packages/db/src/memory/soul-manager.ts
    packages/db/src/memory/index.ts
    packages/db/src/index.ts
  </files>
  <action>
Create `packages/db/src/memory/` directory with four files:

**daily-logger.ts:**
- `MEMORY_DIR` constant: resolve to `packages/db/memory-files/daily/` using `import.meta.url` or `__dirname` equivalent (use `fileURLToPath` + `dirname` from `node:url`/`node:path`). Store the path relative to the package root so it works from any CWD.
- `getTodayLogPath(): string` — returns path to `YYYY-MM-DD.md` for today
- `getYesterdayLogPath(): string` — returns path for yesterday
- `appendDailyLog(content: string): void` — appends to today's file with `## YYYY-MM-DDTHH:mm:ssZ` session header. Use `appendFileSync`. Create file if it doesn't exist (mkdirSync recursive for safety).
- `loadRecentLogs(): string` — reads today + yesterday logs, joined with `---` separator. Returns empty string if neither exists. Use `existsSync` + `readFileSync`.

**memory-curator.ts:**
- `MEMORY_PATH` constant: resolve to `packages/db/memory-files/MEMORY.md`
- `getMemoryPath(): string` — returns MEMORY_PATH
- `loadLongTermMemory(): string` — reads MEMORY.md content. Returns empty string if file doesn't exist.
- `addMemoryEntry(section: 'User Facts' | 'Project Context' | 'Preferences' | 'Important Decisions', entry: string): void` — finds the `## {section}` header in MEMORY.md, appends `- {entry}` after it (before next section or `---`). Updates the `*Last updated:*` footer with current date.

**soul-manager.ts:**
- `SOUL_PATH` constant: resolve to `packages/db/memory-files/SOUL.md`
- `getSoulPath(): string` — returns SOUL_PATH
- `loadSoul(): string` — reads SOUL.md content. Returns empty string if file doesn't exist.
- `evolveSoul(preference: string): void` — appends `- {preference} (learned YYYY-MM-DD)` to the `## Learned Preferences` section of SOUL.md. Does NOT auto-evolve — this is called after user approval (per research recommendation).

**memory/index.ts:**
Barrel re-exports from all three modules.

**Update packages/db/src/index.ts:**
Add re-export: `export * from './memory/index.js';`
  </action>
  <verify>
`pnpm --filter @agentspace/db build` compiles without errors. Check that exported functions exist in the built declaration files.
  </verify>
  <done>
Daily logger appends timestamped entries to YYYY-MM-DD.md files. Memory curator reads/updates structured sections in MEMORY.md. Soul manager reads SOUL.md and can append learned preferences. All functions are synchronous, consistent with better-sqlite3 sync API pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Embedding generation and vector storage wrapper</name>
  <files>
    packages/db/src/memory/embeddings.ts
    packages/db/src/memory/index.ts
    packages/db/package.json
    packages/gateway/package.json
  </files>
  <action>
**Dependencies:**
The `ai` and `@ai-sdk/openai` packages are already in @agentspace/gateway. Since embedding operations need these, add them to @agentspace/db as well:
- Add `"ai": "^6.0.86"` and `"@ai-sdk/openai": "^3"` to packages/db/package.json dependencies.
- Run `pnpm install`.

**embeddings.ts:**
Create the embedding wrapper module:

```typescript
import { embed, embedMany } from 'ai';
import { openai } from '@ai-sdk/openai';
import { getDb } from '../connection.js';

const EMBEDDING_MODEL = 'text-embedding-3-small';
const EMBEDDING_DIMS = 1536;

// Generate a single embedding vector
export async function generateEmbedding(text: string): Promise<{ embedding: number[]; tokens: number }> {
  const { embedding, usage } = await embed({
    model: openai.embedding(EMBEDDING_MODEL),
    value: text,
  });
  return { embedding, tokens: usage.tokens };
}

// Generate embeddings for multiple texts (batch, more efficient)
export async function generateEmbeddings(texts: string[]): Promise<{ embeddings: number[][]; tokens: number }> {
  const { embeddings, usage } = await embedMany({
    model: openai.embedding(EMBEDDING_MODEL),
    values: texts,
  });
  return { embeddings, tokens: usage.tokens };
}

// Store an embedding in vec_memories linked to a memory record
export function storeEmbedding(memoryId: number, embedding: number[]): void {
  const db = getDb();
  const blob = new Uint8Array(new Float32Array(embedding).buffer);
  // Use raw SQL for virtual table (Drizzle doesn't support vec0 virtual tables)
  const sqlite = (db as any).$client;  // Access underlying better-sqlite3 instance
  sqlite.prepare('INSERT INTO vec_memories (memory_id, content_embedding) VALUES (?, ?)').run(memoryId, blob);
}

// Combined: embed text, insert memory record, store vector
export async function embedAndStore(content: string, opts: {
  threadId?: string;
  memoryType: 'fact' | 'preference' | 'decision' | 'summary';
  source?: string;
}): Promise<{ memoryId: number; tokens: number }> {
  const { embedding, tokens } = await generateEmbedding(content);
  const db = getDb();

  // Insert memory metadata
  const result = db.insert(memories).values({
    threadId: opts.threadId ?? null,
    content,
    memoryType: opts.memoryType,
    source: opts.source ?? 'conversation',
    createdAt: new Date().toISOString(),
  }).returning({ id: memories.id }).get();

  // Store vector
  storeEmbedding(result.id, embedding);

  return { memoryId: result.id, tokens };
}
```

Import `memories` from the schema. Access the raw better-sqlite3 instance via `(db as any).$client` for vec0 virtual table operations (Drizzle ORM doesn't have native support for sqlite-vec virtual tables).

**Update memory/index.ts:** Add re-exports from embeddings.ts.
  </action>
  <verify>
`pnpm --filter @agentspace/db build` compiles without errors. Verify that embedAndStore, generateEmbedding, generateEmbeddings, storeEmbedding are exported in the built declaration files.
  </verify>
  <done>
Embedding module wraps AI SDK embed/embedMany with text-embedding-3-small (1536 dims). embedAndStore combines memory record insertion + vector storage in a single call. storeEmbedding converts Float32Array to Uint8Array blob for sqlite-vec. All vector operations use the raw better-sqlite3 client for vec0 compatibility.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @agentspace/db build` passes
2. Daily logger creates date-named .md files with timestamped headers
3. Memory curator can append entries to specific MEMORY.md sections
4. Soul manager can append learned preferences to SOUL.md
5. Embedding module exports generateEmbedding, embedAndStore, storeEmbedding
6. All memory/* exports available from @agentspace/db barrel
</verification>

<success_criteria>
- Daily log operations (append, load recent) work with date-based file rotation
- MEMORY.md and SOUL.md can be read and updated programmatically
- Embedding generation wraps AI SDK with consistent model (text-embedding-3-small, 1536 dims)
- Vector storage converts embeddings to blob format and inserts into vec_memories
- Combined embedAndStore creates memory record + vector in single operation
</success_criteria>

<output>
After completion, create `.planning/phases/05-memory-persistence/05-02-SUMMARY.md`
</output>
