---
phase: 05-memory-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/package.json
  - packages/db/src/connection.ts
  - packages/db/src/schema/threads.ts
  - packages/db/src/schema/memories.ts
  - packages/db/src/schema/global-prompts.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/index.ts
  - packages/db/memory-files/SOUL.md
  - packages/db/memory-files/MEMORY.md
  - packages/db/memory-files/daily/.gitkeep
autonomous: true

must_haves:
  truths:
    - "sqlite-vec extension loads successfully on database initialization"
    - "threads, memories, and global_prompts tables exist in SQLite"
    - "SOUL.md and MEMORY.md template files exist in memory-files directory"
    - "vec_memories virtual table is created with 1536-dimension cosine distance"
  artifacts:
    - path: "packages/db/src/schema/threads.ts"
      provides: "Drizzle schema for conversation threads with per-thread system prompts"
      exports: ["threads"]
    - path: "packages/db/src/schema/memories.ts"
      provides: "Drizzle schema for memory metadata (content, type, thread association)"
      exports: ["memories"]
    - path: "packages/db/src/schema/global-prompts.ts"
      provides: "Drizzle schema for global system prompts with priority ordering"
      exports: ["globalPrompts"]
    - path: "packages/db/memory-files/SOUL.md"
      provides: "Initial soul document template defining agent personality"
    - path: "packages/db/memory-files/MEMORY.md"
      provides: "Initial curated long-term memory file"
  key_links:
    - from: "packages/db/src/connection.ts"
      to: "sqlite-vec"
      via: "sqliteVec.load(sqlite) in getDb()"
      pattern: "sqliteVec\\.load"
    - from: "packages/db/src/connection.ts"
      to: "vec_memories virtual table"
      via: "CREATE VIRTUAL TABLE vec_memories USING vec0"
      pattern: "vec_memories.*vec0"
    - from: "packages/db/src/schema/index.ts"
      to: "threads, memories, globalPrompts"
      via: "barrel re-exports"
      pattern: "export.*threads|memories|globalPrompts"
---

<objective>
Add database schemas, sqlite-vec vector extension, and memory file scaffolding for Phase 5 memory system.

Purpose: Establish the persistence foundation (tables, vector store, file structure) that all memory components build on.
Output: New Drizzle schemas (threads, memories, global_prompts), sqlite-vec loaded in connection.ts, vec_memories virtual table, SOUL.md and MEMORY.md template files.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-memory-persistence/05-RESEARCH.md

@packages/db/src/connection.ts
@packages/db/src/schema/index.ts
@packages/db/src/index.ts
@packages/db/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Drizzle schemas for threads, memories, and global prompts</name>
  <files>
    packages/db/src/schema/threads.ts
    packages/db/src/schema/memories.ts
    packages/db/src/schema/global-prompts.ts
    packages/db/src/schema/index.ts
    packages/db/src/index.ts
  </files>
  <action>
Create three new Drizzle schema files following the existing pattern in sessions.ts/messages.ts:

**threads.ts:**
```
threads table: id (text PK), title (text not null), systemPrompt (text, nullable), archived (integer boolean default false), createdAt (text not null), lastActiveAt (text not null)
```
Note: This replaces the existing sessions concept for Phase 5+ conversation management. Keep existing sessions table intact for backward compatibility.

**memories.ts:**
```
memories table: id (integer PK autoincrement), threadId (text, nullable — null means global memory), content (text not null), memoryType (text not null — values: 'fact', 'preference', 'decision', 'summary'), source (text — e.g. 'daily_log', 'user_input', 'conversation'), createdAt (text not null)
```
This is the metadata table that joins with vec_memories for semantic search.

**global-prompts.ts:**
```
globalPrompts table: id (integer PK autoincrement), name (text not null), content (text not null), isActive (integer boolean default true), priority (integer default 0), createdAt (text not null)
```
Higher priority = loaded first in system prompt assembly.

Update schema/index.ts to re-export all three new schemas. Update db/src/index.ts to re-export the new schema symbols.
  </action>
  <verify>
Run `pnpm --filter @agentspace/db build` — TypeScript compiles without errors. Verify the new exports exist by checking the built .d.ts files include threads, memories, globalPrompts.
  </verify>
  <done>
Three Drizzle schema files exist with correct column types. Schema barrel exports all five tables (auditLog, sessions, messages, usageRecords, threads, memories, globalPrompts). Package index re-exports new schemas.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate sqlite-vec and create vector table and memory file scaffolding</name>
  <files>
    packages/db/package.json
    packages/db/src/connection.ts
    packages/db/memory-files/SOUL.md
    packages/db/memory-files/MEMORY.md
    packages/db/memory-files/daily/.gitkeep
  </files>
  <action>
**Install sqlite-vec:**
Add `sqlite-vec` to dependencies in packages/db/package.json. Run `pnpm install` from monorepo root.

**Update connection.ts:**
Import sqlite-vec: `import * as sqliteVec from 'sqlite-vec';`

In getDb(), after `sqlite.pragma("journal_mode = WAL")` and before the existing `sqlite.exec(...)` block:
1. Load the extension: `sqliteVec.load(sqlite);`
2. Add to the existing `sqlite.exec()` block the new table CREATE statements for threads, memories, global_prompts (matching the Drizzle schemas from Task 1).
3. Add the vec_memories virtual table:
```sql
CREATE VIRTUAL TABLE IF NOT EXISTS vec_memories USING vec0(
  memory_id INTEGER PRIMARY KEY,
  content_embedding FLOAT[1536] distance_metric=cosine
);
```

The memory_id column references memories.id via application-level join (sqlite-vec virtual tables don't support foreign keys).

**Memory files:**
Create `packages/db/memory-files/SOUL.md` with initial template:
```markdown
# Agent Identity

## Core Values
- Operate as a thoughtful partner, not a servile assistant
- Maintain transparency about limitations and uncertainties
- Emphasize honesty over sycophancy

## Communication Style
- Concise and direct when users need quick answers
- Detailed and exploratory when users seek understanding
- Uses technical precision without unnecessary jargon

## Learned Preferences
(Updated as the agent learns user preferences)

## Boundaries
- Never fabricate information when uncertain
- Always cite sources for factual claims
- Respect user privacy and security boundaries
```

Create `packages/db/memory-files/MEMORY.md` with initial template:
```markdown
# Long-Term Memory

## User Facts
(Durable facts about the user)

## Project Context
(Key project decisions and context)

## Preferences
(User preferences learned over time)

## Important Decisions
(Significant decisions made in past conversations)

---
*Last updated: (auto-updated by memory curator)*
```

Create `packages/db/memory-files/daily/.gitkeep` (empty file to preserve directory in git).
  </action>
  <verify>
1. Run `pnpm install` from monorepo root — sqlite-vec installs without errors.
2. Run `pnpm --filter @agentspace/db build` — compiles without errors.
3. Create a quick test: `node -e "const Database = require('better-sqlite3'); const sqliteVec = require('sqlite-vec'); const db = new Database(':memory:'); sqliteVec.load(db); console.log(db.prepare('select vec_version()').pluck().get());"` — prints sqlite-vec version.
4. Verify memory-files/SOUL.md, MEMORY.md, and daily/.gitkeep exist.
  </verify>
  <done>
sqlite-vec loads in getDb() singleton. vec_memories virtual table with FLOAT[1536] cosine distance is created alongside other tables. SOUL.md and MEMORY.md templates exist in memory-files/. daily/ directory exists with .gitkeep.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @agentspace/db build` passes
2. All 7 tables created in getDb(): audit_log, sessions, messages, usage_records, threads, memories, global_prompts + vec_memories virtual table
3. sqlite-vec version query returns a version string
4. Schema barrel exports all tables
5. Memory files directory structure exists: memory-files/{SOUL.md, MEMORY.md, daily/.gitkeep}
</verification>

<success_criteria>
- sqlite-vec extension loads successfully in database initialization
- Three new Drizzle schemas (threads, memories, globalPrompts) exist and compile
- vec_memories virtual table created with 1536-dim cosine distance
- SOUL.md and MEMORY.md templates exist with meaningful initial content
- Existing tables (audit_log, sessions, messages, usage_records) remain functional
</success_criteria>

<output>
After completion, create `.planning/phases/05-memory-persistence/05-01-SUMMARY.md`
</output>
