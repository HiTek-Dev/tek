---
phase: 23-agent-tools-error-recovery
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/vault/providers.ts
  - packages/gateway/src/skills/brave-search.ts
  - packages/gateway/src/skills/index.ts
  - packages/gateway/src/agent/tool-registry.ts
  - packages/gateway/src/ws/handlers.ts
autonomous: true
requirements:
  - TOOLS-BRAVE
  - TOOLS-KEYWIRING

user_setup:
  - service: brave
    why: "Web search via Brave Search API (free tier: 2000 queries/month)"
    env_vars:
      - name: brave API key
        source: "https://brave.com/search/api/ -> Get API Key -> copy key"

must_haves:
  truths:
    - "Agent can search the web via Brave Search when API key is configured"
    - "tek keys add brave stores the Brave API key in vault"
    - "Tavily API key is wired to tool registry when configured"
    - "Brave Search tool appears in tool list when key is set"
  artifacts:
    - path: "packages/gateway/src/skills/brave-search.ts"
      provides: "Brave Search API tool"
      contains: "createBraveSearchTool"
    - path: "packages/cli/src/vault/providers.ts"
      provides: "brave and tavily as valid providers"
      contains: "brave"
    - path: "packages/gateway/src/ws/handlers.ts"
      provides: "Brave and Tavily API keys wired to buildToolRegistry"
      contains: "braveApiKey"
  key_links:
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "packages/gateway/src/agent/tool-registry.ts"
      via: "braveApiKey and tavilyApiKey passed to buildToolRegistry"
      pattern: "braveApiKey.*getKey"
    - from: "packages/gateway/src/agent/tool-registry.ts"
      to: "packages/gateway/src/skills/brave-search.ts"
      via: "conditional registration when key exists"
      pattern: "braveApiKey.*createBraveSearchTool"
---

<objective>
Add Brave Search API skill and fix missing API key wiring for search tools.

Purpose: The agent currently has no working web search because (a) Tavily key is not wired from vault to the tool registry, and (b) Brave Search (free tier, 2000 queries/month) is not available as an alternative. This plan adds Brave Search as a built-in skill and fixes the key wiring gap for both Tavily and Brave.

Output: Working Brave Search tool, "brave" and "tavily" as valid vault providers, and API keys properly wired to the tool registry.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-agent-tools-error-recovery/23-RESEARCH.md
@packages/cli/src/vault/providers.ts
@packages/gateway/src/agent/tool-registry.ts
@packages/gateway/src/skills/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Brave Search skill and add brave/tavily as vault providers</name>
  <files>
    packages/gateway/src/skills/brave-search.ts
    packages/gateway/src/skills/index.ts
    packages/cli/src/vault/providers.ts
  </files>
  <action>
Create packages/gateway/src/skills/brave-search.ts:
1. Import `tool` from "ai" and `z` from "zod"
2. Export `createBraveSearchTool(apiKey: string)` that returns a tool:
   - description: "Search the web using Brave Search for current information. Returns titles, URLs, and descriptions."
   - inputSchema: `{ query: z.string(), count: z.number().optional().default(5) }`
   - execute: GET to `https://api.search.brave.com/res/v1/web/search` with `X-Subscription-Token` header
   - Parse response: extract `data.web.results` array, map to `{ title, url, description }`
   - On HTTP error: return `{ error: "Brave search failed: {status}" }` (not throw -- return error as result so AI can handle it)
   - Clamp count to max 20

In packages/gateway/src/skills/index.ts:
1. Add `export { createBraveSearchTool } from "./brave-search.js";`

In packages/cli/src/vault/providers.ts:
1. Add "brave" and "tavily" to the PROVIDERS array (after "telegram")
2. Add entries to PROVIDER_KEY_PREFIXES: `brave: null, tavily: "tvly-"` (Tavily keys start with tvly-)
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/gateway/tsconfig.json && npx tsc --noEmit -p packages/cli/tsconfig.json` -- both should compile. Grep for "brave" in providers.ts and "createBraveSearchTool" in index.ts.
  </verify>
  <done>
Brave Search tool exists with proper API call pattern. "brave" and "tavily" are recognized vault providers for `tek keys add brave` and `tek keys add tavily`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Brave/Tavily API keys to tool registry</name>
  <files>
    packages/gateway/src/agent/tool-registry.ts
    packages/gateway/src/ws/handlers.ts
  </files>
  <action>
In packages/gateway/src/agent/tool-registry.ts:
1. Add `braveApiKey?: string` to the ToolRegistryOptions interface
2. Import `createBraveSearchTool` from `../skills/index.js`
3. In buildToolRegistry, after the existing tavilyApiKey web_search block, add Brave Search registration:
   ```typescript
   if (options.braveApiKey) {
     const braveSearch = createBraveSearchTool(options.braveApiKey);
     const braveSearchName = "brave_search";
     tools[braveSearchName] = approvalPolicy
       ? wrapToolWithApproval(braveSearchName, braveSearch as unknown as Record<string, unknown>, approvalPolicy)
       : braveSearch;
     // Search is read-only: use "auto" tier
     if (approvalPolicy) {
       approvalPolicy.perTool[braveSearchName] = "auto";
     }
     systemSkillCount++;
   }
   ```

In packages/gateway/src/ws/handlers.ts:
1. Find the `buildToolRegistry({...})` call (around line 360)
2. Add the missing API key fields:
   - `tavilyApiKey: getKey("tavily") ?? undefined,`
   - `braveApiKey: getKey("brave") ?? undefined,`
   These go alongside the existing `openaiApiKey` and `veniceApiKey` lines.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` -- should compile. Grep handlers.ts for "tavilyApiKey" and "braveApiKey" to confirm both are wired. Grep tool-registry.ts for "brave_search" to confirm registration.
  </verify>
  <done>
Brave Search and Tavily API keys are read from vault and passed to tool registry. Both web search tools appear in the agent's tool list when their respective API keys are configured. Search tools use "auto" approval tier (read-only).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/gateway/tsconfig.json` passes
2. `npx tsc --noEmit -p packages/cli/tsconfig.json` passes
3. `tek keys add brave` works (provider recognized)
4. brave_search tool registered conditionally on API key
5. tavilyApiKey wired in handlers.ts (was missing before)
</verification>

<success_criteria>
- Brave Search tool makes proper API calls and returns formatted results
- Both brave and tavily are valid vault providers
- API keys for tavily and brave are wired from vault to tool registry
- Search tools use auto approval tier (read-only, no user prompt needed)
- TypeScript compiles without errors across both packages
</success_criteria>

<output>
After completion, create `.planning/phases/23-agent-tools-error-recovery/23-03-SUMMARY.md`
</output>
