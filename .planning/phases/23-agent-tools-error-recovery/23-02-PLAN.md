---
phase: 23-agent-tools-error-recovery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/context/inspector.ts
autonomous: true
requirements:
  - TOOLS-SYSPROMPT
  - TOOLS-MEMORY

must_haves:
  truths:
    - "Context inspector shows full identity context (SOUL.md, USER.md, etc.) with real byte counts"
    - "Memory section in /context shows loaded memory content when memories exist"
    - "System prompt section shows >500 bytes when identity files have content"
  artifacts:
    - path: "packages/gateway/src/context/inspector.ts"
      provides: "Real context inspection using MemoryManager and ThreadManager"
      contains: "MemoryManager"
  key_links:
    - from: "packages/gateway/src/context/inspector.ts"
      to: "packages/gateway/src/memory/memory-manager.ts"
      via: "getMemoryContext import and call"
      pattern: "getMemoryContext"
    - from: "packages/gateway/src/context/inspector.ts"
      to: "packages/gateway/src/memory/thread-manager.ts"
      via: "buildSystemPrompt import and call"
      pattern: "buildSystemPrompt"
---

<objective>
Rewrite the context inspector to use real assembler logic instead of Phase 3 stubs.

Purpose: The /context command currently shows 31 bytes for system prompt (hardcoded "You are a helpful AI assistant.") and 0 bytes for memory because inspectContext was never updated past Phase 3 stubs. The real assembler loads SOUL.md, USER.md, IDENTITY.md, STYLE.md, and memory via MemoryManager -- the inspector must do the same.

Output: Context inspector that mirrors the real assembler output, showing accurate byte/token/cost for all identity and memory sections.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-agent-tools-error-recovery/23-RESEARCH.md
@packages/gateway/src/context/inspector.ts
@packages/gateway/src/context/assembler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite inspectContext to use MemoryManager and ThreadManager</name>
  <files>
    packages/gateway/src/context/inspector.ts
  </files>
  <action>
Rewrite inspectContext to mirror the assembler logic. The function signature should accept an optional agentId parameter (matching assembler.ts):

```typescript
export function inspectContext(
  sessionMessages: MessageRow[],
  model: string,
  agentId?: string,
): { sections: ContextSection[]; totals: { byteCount: number; tokenEstimate: number; costEstimate: number } }
```

Implementation:
1. Import MemoryManager from `../memory/memory-manager.js` and ThreadManager from `../memory/thread-manager.js`
2. Use lazy-init singleton pattern matching assembler.ts (module-level variables, getter functions)
3. Load the thread system prompt via `threadManager.buildSystemPrompt()` with fallback to DEFAULT_SYSTEM_PROMPT
4. Load memory context via `memoryManager.getMemoryContext(agentId)` -- returns soul, identity, style, user, agents, longTermMemory, recentLogs
5. Build sections matching assembler.ts EXACTLY:
   - system_prompt (from ThreadManager)
   - soul (from memoryCtx.soul)
   - identity (from memoryCtx.identity)
   - style (from memoryCtx.style)
   - user_context (from memoryCtx.user)
   - agents (from memoryCtx.agents)
   - long_term_memory (from memoryCtx.longTermMemory)
   - recent_activity (from memoryCtx.recentLogs)
   - history (from sessionMessages)
   - skills (discover and format from config, same try/catch pattern as assembler)
   - tools (empty string -- tool descriptions aren't available at inspection time)
6. Remove the hardcoded SYSTEM_PROMPT constant and the Phase 3 stub sections
7. Keep the existing measureSection helper and totals computation

Also update the handler that calls inspectContext (in handlers.ts) to pass agentId. Search for `inspectContext` usage in handlers.ts and add the agentId parameter from the connection state.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` -- should compile. Grep for "MemoryManager" in inspector.ts to confirm it's imported and used. Grep for the old stub string "stub for Phase" to confirm stubs are removed.
  </verify>
  <done>
Context inspector loads real identity files and memory via MemoryManager/ThreadManager. /context command shows accurate byte counts for all sections (system prompt >500 bytes when identity files exist, memory >0 bytes when daily logs exist).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/gateway/tsconfig.json` passes
2. No references to "stub for Phase" remain in inspector.ts
3. MemoryManager.getMemoryContext() is called in inspector.ts
4. inspectContext accepts agentId parameter
</verification>

<success_criteria>
- /context shows system_prompt with full identity content (>500 bytes with populated SOUL.md)
- /context shows memory sections with real content (>0 bytes when memories exist)
- Section names match assembler exactly: soul, identity, style, user_context, agents, long_term_memory, recent_activity
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-agent-tools-error-recovery/23-02-SUMMARY.md`
</output>
