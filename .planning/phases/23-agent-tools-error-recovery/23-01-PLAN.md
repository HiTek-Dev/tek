---
phase: 23-agent-tools-error-recovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/tools/filesystem.ts
  - packages/gateway/src/tools/shell.ts
  - packages/gateway/src/agent/tool-loop.ts
  - packages/gateway/src/ws/protocol.ts
autonomous: true
requirements:
  - TOOLS-PATH
  - TOOLS-ERROR
  - TOOLS-FREEZE

must_haves:
  truths:
    - "File tools resolve relative paths against agent workspace directory"
    - "Shell tool uses workspace as default cwd"
    - "Tool errors are relayed to client as tool.error WS messages"
    - "Agent never freezes silently after a tool failure"
  artifacts:
    - path: "packages/gateway/src/tools/filesystem.ts"
      provides: "Path-resolved filesystem tools"
      contains: "resolveAgentPath"
    - path: "packages/gateway/src/tools/shell.ts"
      provides: "Workspace-aware shell tool"
      contains: "resolveAgentPath"
    - path: "packages/gateway/src/agent/tool-loop.ts"
      provides: "Tool error relay to client"
      contains: "tool-error"
    - path: "packages/gateway/src/ws/protocol.ts"
      provides: "ToolErrorNotify schema"
      contains: "tool.error"
  key_links:
    - from: "packages/gateway/src/tools/filesystem.ts"
      to: "workspaceDir parameter"
      via: "resolveAgentPath before checkWorkspace"
      pattern: "resolveAgentPath"
    - from: "packages/gateway/src/agent/tool-loop.ts"
      to: "transport.send"
      via: "tool-error case in fullStream switch"
      pattern: "case.*tool-error"
---

<objective>
Fix broken tool workspace paths and add tool error reporting to prevent agent freezes.

Purpose: Tools currently pass LLM-hallucinated paths (e.g. /home/user/) straight through without resolution, causing ENOENT errors. Tool errors are silently swallowed because the fullStream handler has no `tool-error` case, causing the agent to freeze. These are the two highest-impact bugs from sandbox testing.

Output: Workspace-aware filesystem/shell tools and client-visible tool error messages.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-agent-tools-error-recovery/23-RESEARCH.md
@packages/gateway/src/tools/filesystem.ts
@packages/gateway/src/tools/shell.ts
@packages/gateway/src/agent/tool-loop.ts
@packages/gateway/src/ws/protocol.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace path resolution to filesystem and shell tools</name>
  <files>
    packages/gateway/src/tools/filesystem.ts
    packages/gateway/src/tools/shell.ts
  </files>
  <action>
In filesystem.ts:
1. Import `resolve` and `isAbsolute` from `node:path`
2. Add a `resolveAgentPath` helper function:
   - If path is absolute, return as-is (checkWorkspace will enforce security)
   - If relative and workspaceDir provided, return `resolve(workspaceDir, path)`
   - If relative and no workspaceDir, return `resolve(path)` (resolves against cwd)
3. In read_file execute: call `resolveAgentPath(path, workspaceDir)` BEFORE `checkWorkspace`
4. In write_file execute: same pattern
5. In list_files execute: apply to directory arg
6. Update tool descriptions to say "Paths are relative to your workspace directory" so the LLM knows to use relative paths

In shell.ts:
1. Import `resolve` and `isAbsolute` from `node:path`
2. Add same `resolveAgentPath` helper (or import a shared one -- keep it local since it's 3 lines)
3. When cwd is provided and relative, resolve against workspaceDir
4. When no cwd provided at all, default to workspaceDir (even in full-control mode -- it's a sensible default, not a restriction)
5. Update tool description to mention workspace directory context
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` -- should compile with no errors. Grep for `resolveAgentPath` in both files to confirm the helper exists and is called before every checkWorkspace.
  </verify>
  <done>
All filesystem tool execute functions resolve relative paths against workspaceDir before passing to checkWorkspace. Shell tool defaults cwd to workspaceDir. Tool descriptions mention workspace-relative paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tool-error handling to agent loop and WS protocol</name>
  <files>
    packages/gateway/src/agent/tool-loop.ts
    packages/gateway/src/ws/protocol.ts
  </files>
  <action>
In protocol.ts:
1. Add a `ToolErrorNotifySchema` Zod schema:
   ```
   type: z.literal("tool.error"),
   requestId: z.string(),
   toolCallId: z.string(),
   toolName: z.string(),
   error: z.string(),
   ```
2. Add `ToolErrorNotifySchema` to the `ServerMessageSchema` discriminated union array
3. Export the type: `export type ToolErrorNotify = z.infer<typeof ToolErrorNotifySchema>;`

In tool-loop.ts:
1. Add a `case "tool-error"` to the fullStream switch statement, placed after the existing `tool-result` case:
   ```typescript
   case "tool-error": {
     const toolCallId = part.toolCallId;
     const toolName = String(part.toolName);
     const errorMessage = part.error instanceof Error
       ? part.error.message
       : String(part.error);

     logger.warn(`Tool execution error [${toolName}]: ${errorMessage}`);

     transport.send({
       type: "tool.error",
       requestId,
       toolCallId,
       toolName,
       error: errorMessage,
     });
     break;
   }
   ```
2. Ensure the `default` case logs unexpected part types at info level (currently it silently ignores -- add `logger.info` for debugging)
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` -- should compile. Grep for `tool-error` in tool-loop.ts and `tool.error` in protocol.ts to confirm both are present.
  </verify>
  <done>
Tool errors from AI SDK are caught in the fullStream handler and relayed to the client as `tool.error` WS messages. The agent loop no longer silently drops tool execution failures.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/gateway/tsconfig.json` passes
2. `resolveAgentPath` function exists in filesystem.ts and shell.ts
3. `tool-error` case exists in tool-loop.ts fullStream switch
4. `ToolErrorNotifySchema` exists in protocol.ts and is in the ServerMessage union
</verification>

<success_criteria>
- File tool paths are resolved relative to workspace before security checks
- Shell tool defaults cwd to workspace directory
- Tool errors produce client-visible WS messages instead of being swallowed
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-agent-tools-error-recovery/23-01-SUMMARY.md`
</output>
