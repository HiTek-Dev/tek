---
phase: 06-agent-capabilities
plan: 04
type: execute
wave: 3
depends_on: ["06-03"]
files_modified:
  - packages/gateway/src/agent/preflight.ts
  - packages/gateway/src/agent/index.ts
  - packages/gateway/src/ws/handlers.ts
  - packages/cli/src/components/ToolApprovalPrompt.tsx
  - packages/cli/src/components/PreflightChecklist.tsx
  - packages/cli/src/lib/gateway-client.ts
  - packages/cli/src/hooks/useChat.ts
  - packages/cli/src/hooks/useSlashCommands.ts
  - packages/cli/src/components/Chat.tsx
autonomous: true

must_haves:
  truths:
    - "Before complex tasks, agent generates a pre-flight checklist with steps, costs, permissions, and risks"
    - "User can review and approve or reject the pre-flight checklist before execution"
    - "Tool calls display inline in the CLI with tool name, input, and output"
    - "Tool approval requests show an interactive prompt in the CLI for approve/deny"
    - "User can run /tools to list available tools and /approve to set approval preferences"
  artifacts:
    - path: "packages/gateway/src/agent/preflight.ts"
      provides: "Pre-flight checklist generation via generateObject"
      exports: ["generatePreflight", "shouldTriggerPreflight"]
    - path: "packages/cli/src/components/ToolApprovalPrompt.tsx"
      provides: "Interactive approval prompt for tool calls"
      exports: ["ToolApprovalPrompt"]
    - path: "packages/cli/src/components/PreflightChecklist.tsx"
      provides: "Pre-flight checklist review component"
      exports: ["PreflightChecklist"]
    - path: "packages/cli/src/lib/gateway-client.ts"
      provides: "Message factories for tool.approval.response and preflight.approval"
      contains: "createToolApprovalResponse"
  key_links:
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "packages/gateway/src/agent/preflight.ts"
      via: "generatePreflight called before agent loop for complex tasks"
      pattern: "generatePreflight"
    - from: "packages/cli/src/hooks/useChat.ts"
      to: "packages/cli/src/components/ToolApprovalPrompt.tsx"
      via: "tool.approval.request triggers approval prompt state"
      pattern: "tool\\.approval\\.request"
    - from: "packages/cli/src/components/Chat.tsx"
      to: "packages/cli/src/components/PreflightChecklist.tsx"
      via: "preflight.checklist triggers checklist display"
      pattern: "PreflightChecklist"
---

<objective>
Build the pre-flight checklist generator and the CLI components for tool call rendering, approval prompts, and checklist review.

Purpose: Completes the user-facing experience: users see tool activity inline, can approve/deny tool calls interactively, review pre-flight checklists before complex tasks, and manage tools via slash commands.
Output: Pre-flight generator, ToolApprovalPrompt, PreflightChecklist, extended useChat hook, /tools and /approve slash commands.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-capabilities/06-RESEARCH.md
@.planning/phases/06-agent-capabilities/06-03-SUMMARY.md

@packages/gateway/src/ws/protocol.ts
@packages/gateway/src/ws/handlers.ts
@packages/gateway/src/agent/index.ts
@packages/cli/src/lib/gateway-client.ts
@packages/cli/src/hooks/useChat.ts
@packages/cli/src/hooks/useSlashCommands.ts
@packages/cli/src/components/Chat.tsx
@packages/cli/src/components/MessageBubble.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pre-flight checklist generator and wire into handlers</name>
  <files>
    packages/gateway/src/agent/preflight.ts
    packages/gateway/src/agent/index.ts
    packages/gateway/src/ws/handlers.ts
  </files>
  <action>
1. Create `packages/gateway/src/agent/preflight.ts`:
   - `PreflightChecklistSchema` using Zod: z.object with `steps` (array of { description: string, toolName?: string, risk: "low"|"medium"|"high", needsApproval: boolean }), `estimatedCost` ({ inputTokens, outputTokens, estimatedUSD }), `requiredPermissions` (string array), `warnings` (string array).
   - `shouldTriggerPreflight(userMessage: string, availableTools: Record<string, any>)` returning boolean:
     - Heuristic: returns true if message is > 200 chars, or contains keywords like "refactor", "delete", "deploy", "install", "migrate", "update all", "fix all".
     - Also returns true if availableTools has > 5 tools (complex environment).
     - Returns false for simple questions, short messages.
   - `generatePreflight(model, userMessage, availableTools)` async function:
     - Uses `generateObject` from AI SDK with the PreflightChecklistSchema.
     - Prompt: "Analyze this user request and create an execution plan. List the steps the agent will likely take, which tools it will use, estimated token cost, required permissions, and any warnings or risks."
     - Include tool descriptions in the prompt.
     - Return the parsed checklist object.

2. Re-export from `packages/gateway/src/agent/index.ts`.

3. Update `packages/gateway/src/ws/handlers.ts`:
   - In `handleChatSend`, after building tool registry and before `runAgentLoop`:
     - Call `shouldTriggerPreflight(msg.content, tools)`.
     - If true: call `generatePreflight(model, msg.content, tools)`, send `preflight.checklist` server message via WS, store pending preflight in connState, and return (wait for `preflight.approval` response).
   - Add `handlePreflightApproval(socket, msg, connState)`:
     - If approved: proceed with `runAgentLoop` using stored context.
     - If rejected: send error message "Preflight rejected by user" and clean up.
     - If editedSteps provided: apply step skips and proceed.
   - Wire `preflight.approval` dispatch in server.ts (update the stub from Plan 03).
  </action>
  <verify>
    `pnpm --filter @agentspace/gateway build` passes. `shouldTriggerPreflight` and `generatePreflight` are exported. handleChatSend sends preflight.checklist for complex messages.
  </verify>
  <done>Pre-flight checklist is generated via LLM for complex tasks, sent to client for review, and execution proceeds only after approval.</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI tool rendering, approval prompt, and slash commands</name>
  <files>
    packages/cli/src/components/ToolApprovalPrompt.tsx
    packages/cli/src/components/PreflightChecklist.tsx
    packages/cli/src/lib/gateway-client.ts
    packages/cli/src/hooks/useChat.ts
    packages/cli/src/hooks/useSlashCommands.ts
    packages/cli/src/components/Chat.tsx
  </files>
  <action>
1. Update `packages/cli/src/lib/gateway-client.ts`:
   - Add `createToolApprovalResponse(toolCallId: string, approved: boolean, sessionApprove?: boolean)` factory returning ClientMessage with type "tool.approval.response".
   - Add `createPreflightApprovalResponse(requestId: string, approved: boolean, editedSteps?)` factory returning ClientMessage with type "preflight.approval".

2. Update `packages/cli/src/hooks/useChat.ts`:
   - Add state: `pendingApproval: { toolCallId: string, toolName: string, args: unknown } | null`.
   - Add state: `pendingPreflight: { requestId: string, steps: any[], estimatedCost: any, requiredPermissions: string[], warnings: string[] } | null`.
   - Add state: `toolCalls: Array<{ toolCallId: string, toolName: string, args: unknown, result?: unknown, status: "pending" | "complete" | "error" }>` for tracking active tool calls.
   - Handle new server message types in the WebSocket onmessage handler:
     - `tool.call`: add to toolCalls array with status "pending", also add a ToolCallMessage to messages.
     - `tool.result`: update matching toolCall to "complete", update the ToolCallMessage output.
     - `tool.approval.request`: set pendingApproval state (causes ToolApprovalPrompt to render).
     - `preflight.checklist`: set pendingPreflight state (causes PreflightChecklist to render).
   - Add `approveToolCall(approved, sessionApprove?)`: sends tool.approval.response, clears pendingApproval.
   - Add `approvePreflight(approved, editedSteps?)`: sends preflight.approval, clears pendingPreflight.

3. Create `packages/cli/src/components/ToolApprovalPrompt.tsx`:
   - Ink component showing:
     - Yellow border box with "Tool Approval Required" header.
     - Tool name in bold blue, args displayed as JSON.
     - Two options: [Y] Approve, [N] Deny, [S] Approve for session.
     - Listens for keypress: 'y' → approve, 'n' → deny, 's' → approve with sessionApprove=true.
   - Props: `{ toolName, toolCallId, args, onResponse: (approved, sessionApprove?) => void }`.

4. Create `packages/cli/src/components/PreflightChecklist.tsx`:
   - Ink component showing:
     - "Pre-flight Checklist" header in bold yellow.
     - Numbered list of steps with risk indicators (green=low, yellow=medium, red=high).
     - Estimated cost in formatted USD.
     - Required permissions list.
     - Warnings in red.
     - [Y] Approve and execute, [N] Cancel.
   - Props: `{ checklist, onResponse: (approved) => void }`.

5. Update `packages/cli/src/hooks/useSlashCommands.ts`:
   - Add `/tools` command: returns a message listing available tool names (from a new `tools.list` WS message, or just display static info about the tool system).
   - Add `/approve <toolName> <tier>` command: sends a message to set approval tier for a specific tool. For MVP, this can just update local state and display confirmation.

6. Update `packages/cli/src/components/Chat.tsx`:
   - Import and render `ToolApprovalPrompt` when `pendingApproval` is set (instead of InputBar).
   - Import and render `PreflightChecklist` when `pendingPreflight` is set (instead of InputBar).
   - Pass approval/preflight handlers from useChat to the components.
  </action>
  <verify>
    `pnpm --filter @agentspace/cli build` passes. ToolApprovalPrompt and PreflightChecklist components exist. useChat handles tool.call, tool.result, tool.approval.request, preflight.checklist messages. /tools and /approve slash commands registered.
  </verify>
  <done>CLI displays tool calls inline, shows interactive approval prompts for tool execution, displays pre-flight checklists for complex tasks, and supports /tools and /approve slash commands.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds across all packages
- `packages/gateway/src/agent/preflight.ts` exports generatePreflight and shouldTriggerPreflight
- `packages/cli/src/components/ToolApprovalPrompt.tsx` exists and renders approval prompt
- `packages/cli/src/components/PreflightChecklist.tsx` exists and renders checklist
- `packages/cli/src/hooks/useChat.ts` handles all new server message types
- `packages/cli/src/hooks/useSlashCommands.ts` has /tools and /approve commands
- `packages/cli/src/lib/gateway-client.ts` has createToolApprovalResponse and createPreflightApprovalResponse factories
</verification>

<success_criteria>
Complete user-facing tool experience: tool calls display inline in the CLI conversation flow, approval prompts appear interactively with keyboard shortcuts for approve/deny/session-approve, pre-flight checklists show before complex tasks with cost/risk breakdown, and users can manage tools via slash commands. All Phase 6 success criteria are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-capabilities/06-04-SUMMARY.md`
</output>
