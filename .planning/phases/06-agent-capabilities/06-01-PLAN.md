---
phase: 06-agent-capabilities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/config/schema.ts
  - packages/core/src/config/index.ts
  - packages/core/src/index.ts
  - packages/gateway/src/mcp/config.ts
  - packages/gateway/src/mcp/client-manager.ts
  - packages/gateway/src/mcp/index.ts
  - packages/gateway/src/tools/filesystem.ts
  - packages/gateway/src/tools/shell.ts
  - packages/gateway/src/tools/index.ts
  - packages/gateway/src/agent/tool-registry.ts
  - packages/gateway/src/agent/approval-gate.ts
  - packages/gateway/src/agent/index.ts
  - packages/gateway/src/index.ts
autonomous: true

must_haves:
  truths:
    - "MCP servers defined in config can be lazily connected via MCPClientManager"
    - "Built-in filesystem tools respect security mode (limited-control restricts to workspace)"
    - "Shell execution tool runs commands with timeout and cwd restriction"
    - "Tool registry merges MCP tools and built-in tools into a single set"
    - "Approval gate evaluates per-tool approval tiers (auto, session, always)"
  artifacts:
    - path: "packages/core/src/config/schema.ts"
      provides: "MCPServerConfig, ToolApprovalConfig schemas in AppConfigSchema"
      contains: "mcpServers"
    - path: "packages/gateway/src/mcp/client-manager.ts"
      provides: "MCPClientManager class with lazy connect and closeAll"
      exports: ["MCPClientManager"]
    - path: "packages/gateway/src/tools/filesystem.ts"
      provides: "read_file, write_file, list_files AI SDK tools"
      exports: ["createFilesystemTools"]
    - path: "packages/gateway/src/tools/shell.ts"
      provides: "execute_command AI SDK tool with execa"
      exports: ["createShellTool"]
    - path: "packages/gateway/src/agent/tool-registry.ts"
      provides: "buildToolRegistry merging MCP + built-in tools"
      exports: ["buildToolRegistry"]
    - path: "packages/gateway/src/agent/approval-gate.ts"
      provides: "ApprovalPolicy type and wrapToolWithApproval function"
      exports: ["wrapToolWithApproval", "ApprovalPolicy"]
  key_links:
    - from: "packages/gateway/src/tools/filesystem.ts"
      to: "packages/core/src/config/security.ts"
      via: "isPathWithinWorkspace import"
      pattern: "isPathWithinWorkspace"
    - from: "packages/gateway/src/agent/tool-registry.ts"
      to: "packages/gateway/src/mcp/client-manager.ts"
      via: "MCPClientManager.getTools()"
      pattern: "mcpManager\\.getTools"
    - from: "packages/gateway/src/agent/approval-gate.ts"
      to: "packages/gateway/src/agent/tool-registry.ts"
      via: "wrapToolWithApproval applied in buildToolRegistry"
      pattern: "wrapToolWithApproval"
---

<objective>
Create the tool infrastructure layer: MCP client management, built-in filesystem/shell tools, unified tool registry, and approval gate logic.

Purpose: Provides the foundational tool system that all other Phase 6 plans build upon -- MCP server connections, native tools, and approval policy evaluation.
Output: MCP client manager, filesystem tools, shell tool, tool registry, approval gate, config schema extensions.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-agent-capabilities/06-RESEARCH.md

@packages/core/src/config/schema.ts
@packages/core/src/config/security.ts
@packages/gateway/src/llm/stream.ts
@packages/gateway/src/ws/handlers.ts
@packages/gateway/src/context/assembler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config schema and create MCP client manager</name>
  <files>
    packages/core/src/config/schema.ts
    packages/core/src/config/index.ts
    packages/core/src/index.ts
    packages/gateway/src/mcp/config.ts
    packages/gateway/src/mcp/client-manager.ts
    packages/gateway/src/mcp/index.ts
  </files>
  <action>
1. In `packages/core/src/config/schema.ts`, add to `AppConfigSchema`:
   - `MCPServerConfigSchema`: z.object with `command` (string, optional), `args` (string array, optional), `env` (record string, optional), `url` (string, optional), `transport` (enum stdio/http/sse, optional). At least one of command or url must be present.
   - `ToolApprovalConfigSchema`: z.object with `defaultTier` (enum auto/session/always, default "session"), `perTool` (record of tier enum, optional), `approvalTimeout` (number, default 60000).
   - Add `mcpServers: z.record(MCPServerConfigSchema).optional()`, `toolApproval: ToolApprovalConfigSchema.optional()`, `skillsDir: z.string().optional()` to AppConfigSchema.
   - Export MCPServerConfig and ToolApprovalConfig types.

2. Re-export new types from `packages/core/src/config/index.ts` and `packages/core/src/index.ts`.

3. Create `packages/gateway/src/mcp/config.ts`:
   - `loadMCPConfigs()` function that reads mcpServers from loaded AppConfig. Returns `Record<string, MCPServerConfig>` (empty record if none configured).

4. Create `packages/gateway/src/mcp/client-manager.ts`:
   - `MCPClientManager` class following singleton pattern consistent with SessionManager/UsageTracker.
   - Private `clients: Map<string, Awaited<ReturnType<typeof createMCPClient>>>`.
   - `async getTools(serverName, config)`: lazy-connect via `createMCPClient` from `@ai-sdk/mcp`, cache in map, return `client.tools()`.
   - For stdio transport: use `StdioClientTransport` from `@modelcontextprotocol/sdk/client/stdio.js` with config.command, config.args, config.env.
   - For http/sse transport: use `{ type, url }` object transport.
   - `async closeAll()`: close all clients and clear map. Register on `process.on("exit")` and `process.on("SIGTERM")` in constructor.
   - Error handling: log failures but don't throw (other tools still work).

5. Create `packages/gateway/src/mcp/index.ts` barrel export.

Install new dependencies first: `pnpm --filter @agentspace/gateway add @ai-sdk/mcp @modelcontextprotocol/sdk execa`
  </action>
  <verify>
    `pnpm --filter @agentspace/core build` and `pnpm --filter @agentspace/gateway build` both pass without errors.
  </verify>
  <done>Config schema has mcpServers/toolApproval/skillsDir fields. MCPClientManager can lazy-connect to stdio and HTTP MCP servers.</done>
</task>

<task type="auto">
  <name>Task 2: Create built-in tools, tool registry, and approval gate</name>
  <files>
    packages/gateway/src/tools/filesystem.ts
    packages/gateway/src/tools/shell.ts
    packages/gateway/src/tools/index.ts
    packages/gateway/src/agent/tool-registry.ts
    packages/gateway/src/agent/approval-gate.ts
    packages/gateway/src/agent/index.ts
    packages/gateway/src/index.ts
  </files>
  <action>
1. Create `packages/gateway/src/tools/filesystem.ts`:
   - `createFilesystemTools(securityMode, workspaceDir?)` returning object with:
     - `read_file`: AI SDK `tool()` with inputSchema `z.object({ path: z.string() })`, `needsApproval: false` (reads are safe). Execute reads file with `readFile(path, "utf-8")`. In limited-control mode, check `isPathWithinWorkspace()` from @agentspace/core before reading. Truncate output at 100KB with message.
     - `write_file`: AI SDK `tool()` with inputSchema `z.object({ path: z.string(), content: z.string() })`, `needsApproval: true`. Execute writes file. Same workspace check. Return confirmation with byte count.
     - `list_files`: AI SDK `tool()` with inputSchema `z.object({ directory: z.string(), recursive: z.boolean().optional() })`, `needsApproval: false`. Execute uses `readdir`. Same workspace check.

2. Create `packages/gateway/src/tools/shell.ts`:
   - `createShellTool(securityMode, workspaceDir?)` returning AI SDK `tool()`:
     - inputSchema: `z.object({ command: z.string(), cwd: z.string().optional(), timeout: z.number().optional().default(30000) })`.
     - `needsApproval: true` (shell commands always need approval).
     - Execute: Use `execaCommand` from execa with `{ cwd: effectiveCwd, timeout, reject: false }`. In limited-control, force cwd to workspaceDir. Return `{ stdout, stderr, exitCode, failed }`. Truncate stdout/stderr at 50KB each.

3. Create `packages/gateway/src/tools/index.ts` barrel export.

4. Create `packages/gateway/src/agent/approval-gate.ts`:
   - `ApprovalTier` type: "auto" | "session" | "always".
   - `ApprovalPolicy` interface: `{ defaultTier: ApprovalTier, perTool: Record<string, ApprovalTier>, sessionApprovals: Set<string> }`.
   - `createApprovalPolicy(config?: ToolApprovalConfig)`: creates policy from config, defaulting to session tier.
   - `wrapToolWithApproval(name, originalTool, policy)`: returns tool with needsApproval set based on tier. For "auto" tier: false. For "session" tier: async function checking sessionApprovals set. For "always" tier: true.

5. Create `packages/gateway/src/agent/tool-registry.ts`:
   - `buildToolRegistry(options: { mcpManager, mcpConfigs, securityMode, workspaceDir?, approvalPolicy? })` returning `Promise<Record<string, any>>`:
     - Merge built-in tools (filesystem + shell) with MCP tools.
     - Namespace MCP tools as `serverName.toolName` to avoid collisions.
     - Apply approval policy wrappers if provided.
     - Log warnings for MCP connection failures but don't fail.

6. Create `packages/gateway/src/agent/index.ts` barrel export.
7. Re-export new modules from `packages/gateway/src/index.ts`.
  </action>
  <verify>
    `pnpm --filter @agentspace/gateway build` passes. Verify filesystem tools, shell tool, tool registry, and approval gate are all exported from gateway package.
  </verify>
  <done>Built-in filesystem (read/write/list) and shell tools exist with security mode enforcement. Tool registry merges MCP + built-in tools. Approval gate wraps tools with tiered approval.</done>
</task>

</tasks>

<verification>
- `pnpm build` succeeds across all packages
- `packages/core/src/config/schema.ts` contains mcpServers, toolApproval, skillsDir in AppConfigSchema
- `packages/gateway/src/mcp/client-manager.ts` exports MCPClientManager
- `packages/gateway/src/tools/filesystem.ts` exports createFilesystemTools
- `packages/gateway/src/tools/shell.ts` exports createShellTool
- `packages/gateway/src/agent/tool-registry.ts` exports buildToolRegistry
- `packages/gateway/src/agent/approval-gate.ts` exports wrapToolWithApproval and ApprovalPolicy
</verification>

<success_criteria>
Tool infrastructure is fully implemented: config schema extended, MCP client manager handles lazy connections, filesystem and shell tools enforce security boundaries, tool registry merges all tool sources, approval gate supports three-tier policy.
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-capabilities/06-01-SUMMARY.md`
</output>
