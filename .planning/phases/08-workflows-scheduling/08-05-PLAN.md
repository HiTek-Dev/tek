---
phase: 08-workflows-scheduling
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/ws/protocol.ts
  - packages/gateway/src/ws/handlers.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "handleHeartbeatConfigure calls cronScheduler.scheduleHeartbeat() with model, heartbeatPath, and onAlert callback"
    - "heartbeat.alert server message is sent to the WebSocket client when actionNeeded items exist"
    - "heartbeat.configure client message accepts a heartbeatPath field for the HEARTBEAT.md location"
  artifacts:
    - path: "packages/gateway/src/ws/handlers.ts"
      provides: "Wired handleHeartbeatConfigure calling scheduleHeartbeat with real onAlert"
      contains: "cronScheduler.scheduleHeartbeat"
    - path: "packages/gateway/src/ws/protocol.ts"
      provides: "heartbeatPath field on HeartbeatConfigureSchema"
      contains: "heartbeatPath"
  key_links:
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "packages/gateway/src/scheduler/scheduler.ts"
      via: "cronScheduler.scheduleHeartbeat() call"
      pattern: "cronScheduler\\.scheduleHeartbeat"
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "packages/gateway/src/ws/protocol.ts"
      via: "send() with heartbeat.alert message"
      pattern: 'type:\s*"heartbeat\.alert"'
---

<objective>
Wire the heartbeat WebSocket protocol handler to the real HeartbeatRunner implementation.

Purpose: Close the gap where `handleHeartbeatConfigure` registers a logging-only cron stub instead of calling `cronScheduler.scheduleHeartbeat()`. After this fix, heartbeat.configure messages from clients will start real HEARTBEAT.md-driven monitoring with AI-powered checks, and heartbeat.alert messages will be sent back to the client when action-needed items are detected.

Output: Two modified files completing the heartbeat protocol wiring.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflows-scheduling/08-03-SUMMARY.md
@.planning/phases/08-workflows-scheduling/08-04-SUMMARY.md
@packages/gateway/src/ws/handlers.ts
@packages/gateway/src/ws/protocol.ts
@packages/gateway/src/scheduler/scheduler.ts
@packages/gateway/src/scheduler/heartbeat.ts
@packages/gateway/src/workflow/executor.ts (lines 190-200, model registry pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heartbeatPath to protocol schema and wire handleHeartbeatConfigure to scheduleHeartbeat</name>
  <files>
    packages/gateway/src/ws/protocol.ts
    packages/gateway/src/ws/handlers.ts
  </files>
  <action>
**In `packages/gateway/src/ws/protocol.ts`:**

Add a `heartbeatPath` field to `HeartbeatConfigureSchema` (around line 158-165). This tells the gateway where the HEARTBEAT.md file lives:

```
heartbeatPath: z.string(),
```

Add it after the `id` field. This is a required field â€” the client must specify which HEARTBEAT.md to use.

**In `packages/gateway/src/ws/handlers.ts`:**

Replace the stub implementation in `handleHeartbeatConfigure` (lines 1182-1188) that currently does:
```ts
cronScheduler.schedule(config, async () => {
    logger.info(`Heartbeat ${scheduleId} fired (configured via WS)`);
});
```

With the real implementation that:

1. Obtains a model from the registry (same pattern as `executor.ts` line 192-197):
   ```ts
   const { getRegistry } = await import("../llm/registry.js");
   const registry = getRegistry();
   const model = registry.languageModel("anthropic:claude-sonnet-4-5-20250514" as never);
   ```

2. Gets tools from `connState.tools ?? {}`

3. Calls `cronScheduler.scheduleHeartbeat()` instead of `cronScheduler.schedule()`:
   ```ts
   cronScheduler.scheduleHeartbeat(
       config,
       msg.heartbeatPath,
       tools,
       model,
       (results) => {
           send(socket, {
               type: "heartbeat.alert",
               checks: results.map((r) => ({
                   description: r.description,
                   actionNeeded: r.actionNeeded,
                   details: r.details,
               })),
               timestamp: new Date().toISOString(),
           });
       },
   );
   ```

This wires the complete chain: client sends heartbeat.configure -> handler calls scheduleHeartbeat with real HeartbeatRunner -> cron fires -> HeartbeatRunner checks items with AI -> onAlert sends heartbeat.alert back to the WebSocket client.

Remove the old comment block (lines 1182-1185) about "for now, register as a generic schedule" since this is no longer a stub.
  </action>
  <verify>
1. `npx tsc --noEmit` in packages/gateway passes with no type errors
2. Grep confirms `cronScheduler.scheduleHeartbeat` appears in handlers.ts
3. Grep confirms `heartbeat.alert` is referenced in the send() call in handlers.ts
4. Grep confirms `heartbeatPath: z.string()` appears in protocol.ts HeartbeatConfigureSchema
  </verify>
  <done>
- handleHeartbeatConfigure calls cronScheduler.scheduleHeartbeat() with model from registry, tools from connState, heartbeatPath from msg, and onAlert callback that sends heartbeat.alert via WebSocket
- HeartbeatConfigureSchema includes heartbeatPath field
- heartbeat.alert server message is sent when HeartbeatRunner finds actionNeeded items
- No stub logger.info-only callback remains
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in packages/gateway (type-checks the full wiring)
2. `grep -n "cronScheduler.scheduleHeartbeat" packages/gateway/src/ws/handlers.ts` returns a match
3. `grep -n "heartbeat.alert" packages/gateway/src/ws/handlers.ts` returns a match in a send() call
4. `grep -n "heartbeatPath" packages/gateway/src/ws/protocol.ts` returns a match in HeartbeatConfigureSchema
5. `grep -n "cronScheduler.schedule(" packages/gateway/src/ws/handlers.ts` returns NO match (old stub removed)
</verification>

<success_criteria>
- The handleHeartbeatConfigure handler calls cronScheduler.scheduleHeartbeat() with a real model, tools, heartbeatPath, and onAlert callback
- The onAlert callback sends a heartbeat.alert message via the WebSocket connection
- The HeartbeatConfigureSchema includes a heartbeatPath field
- The old logging-only stub is fully replaced
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflows-scheduling/08-05-SUMMARY.md`
</output>
