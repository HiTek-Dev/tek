---
phase: 08-workflows-scheduling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/workflows.ts
  - packages/db/src/schema/schedules.ts
  - packages/db/src/schema/index.ts
  - packages/gateway/src/workflow/types.ts
  - packages/gateway/src/workflow/index.ts
  - packages/gateway/src/scheduler/types.ts
  - packages/gateway/src/scheduler/index.ts
  - packages/gateway/package.json
autonomous: true

must_haves:
  truths:
    - "Workflow definitions can be validated against a Zod schema covering steps, branching, and tool/model actions"
    - "Schedule configurations can be validated with cron expressions, active hours, and one-shot support"
    - "Workflow executions and schedules persist in SQLite across restarts"
  artifacts:
    - path: "packages/db/src/schema/workflows.ts"
      provides: "workflows and workflow_executions tables"
      contains: "sqliteTable"
    - path: "packages/db/src/schema/schedules.ts"
      provides: "schedules table"
      contains: "sqliteTable"
    - path: "packages/gateway/src/workflow/types.ts"
      provides: "WorkflowDefinition, StepDefinition, WorkflowExecution Zod schemas and types"
      exports: ["WorkflowDefinitionSchema", "StepDefinitionSchema"]
    - path: "packages/gateway/src/scheduler/types.ts"
      provides: "ScheduleConfig, HeartbeatConfig Zod schemas and types"
      exports: ["ScheduleConfigSchema", "HeartbeatConfigSchema"]
  key_links:
    - from: "packages/db/src/schema/index.ts"
      to: "packages/db/src/schema/workflows.ts"
      via: "barrel export"
      pattern: "export.*from.*workflows"
    - from: "packages/db/src/schema/index.ts"
      to: "packages/db/src/schema/schedules.ts"
      via: "barrel export"
      pattern: "export.*from.*schedules"
---

<objective>
Create the data foundation for workflows and scheduling: DB schemas for persistence, Zod schemas for validation, and TypeScript types for the workflow definition format. Install croner and yaml dependencies.

Purpose: All subsequent plans (engine, scheduler, protocol) depend on these shared types and persistence tables.
Output: DB tables (workflows, workflow_executions, schedules), Zod validation schemas, TypeScript types, installed dependencies.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-workflows-scheduling/08-RESEARCH.md

@packages/db/src/schema/index.ts
@packages/db/src/schema/sessions.ts
@packages/gateway/src/ws/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create DB schemas</name>
  <files>
    packages/gateway/package.json
    packages/db/src/schema/workflows.ts
    packages/db/src/schema/schedules.ts
    packages/db/src/schema/index.ts
  </files>
  <action>
1. Install dependencies in gateway package:
   `pnpm --filter @agentspace/gateway add croner yaml`

2. Create `packages/db/src/schema/workflows.ts` with two tables following existing pattern (see sessions.ts for reference):
   - `workflows` table: id (text PK), name (text notNull), description (text), definitionPath (text notNull, snake_case column: definition_path), createdAt (text notNull), updatedAt (text notNull)
   - `workflowExecutions` table: id (text PK), workflowId (text notNull, references workflows.id), status (text notNull — running|paused|completed|failed), currentStepId (text), stepResults (text — JSON string), triggeredBy (text notNull — manual|cron|heartbeat), startedAt (text notNull), pausedAt (text), completedAt (text), error (text)

3. Create `packages/db/src/schema/schedules.ts`:
   - `schedules` table: id (text PK), name (text notNull), cronExpression (text notNull, column: cron_expression), timezone (text), activeHoursStart (text, column: active_hours_start), activeHoursEnd (text, column: active_hours_end), activeHoursDays (text, column: active_hours_days — JSON array string), maxRuns (integer, column: max_runs), workflowId (text, references workflows.id), enabled (integer mode:"boolean" notNull default true), lastRunAt (text, column: last_run_at), createdAt (text notNull), updatedAt (text notNull)

4. Update `packages/db/src/schema/index.ts` to add barrel exports for both new schema files:
   - `export { workflows, workflowExecutions } from "./workflows.js";`
   - `export { schedules } from "./schedules.js";`

Use `import { sqliteTable, text, integer } from "drizzle-orm/sqlite-core";` matching existing schema files.
  </action>
  <verify>
`pnpm --filter @agentspace/db exec tsc --noEmit` passes.
`pnpm --filter @agentspace/gateway exec tsc --noEmit` passes (croner and yaml are importable).
  </verify>
  <done>Three new DB tables (workflows, workflowExecutions, schedules) exist with correct columns. croner and yaml are installed in gateway. Barrel exports updated.</done>
</task>

<task type="auto">
  <name>Task 2: Create workflow and schedule Zod schemas and types</name>
  <files>
    packages/gateway/src/workflow/types.ts
    packages/gateway/src/workflow/index.ts
    packages/gateway/src/scheduler/types.ts
    packages/gateway/src/scheduler/index.ts
  </files>
  <action>
1. Create `packages/gateway/src/workflow/types.ts` with Zod schemas:
   - `StepDefinitionSchema`: z.object with id (string), action (enum: "tool"|"model"|"noop"), tool (string optional), args (z.record(z.string(), z.unknown()) optional), prompt (string optional), outputSchema (z.record(z.string(), z.unknown()) optional), approvalRequired (boolean optional default false), onSuccess (string optional), onFailure (string optional), branches (array of { condition: string, goto: string } optional), timeout (number optional)
   - `WorkflowDefinitionSchema`: z.object with name (string), description (string optional), trigger (union of literal "manual" or string, optional default "manual"), steps (array of StepDefinitionSchema, min 1)
   - `StepResultSchema`: z.object with status (enum "success"|"failure"|"paused"), output (z.unknown()), completedAt (string optional)
   - `WorkflowExecutionStateSchema`: z.object with id (string), workflowId (string), status (enum "running"|"paused"|"completed"|"failed"), currentStepId (string optional), stepResults (z.record(z.string(), StepResultSchema)), startedAt (string), pausedAt (string optional), completedAt (string optional), error (string optional), triggeredBy (enum "manual"|"cron"|"heartbeat")
   - Export all inferred types: StepDefinition, WorkflowDefinition, StepResult, WorkflowExecutionState

   IMPORTANT: Use `z.record(z.string(), ...)` not `z.record(...)` — Zod 4 requires explicit key schema.

2. Create `packages/gateway/src/workflow/index.ts` as barrel:
   - `export * from "./types.js";`
   - (Engine exports will be added in plan 08-02)

3. Create `packages/gateway/src/scheduler/types.ts` with Zod schemas:
   - `ActiveHoursSchema`: z.object with start (string), end (string), daysOfWeek (z.array(z.number()) optional)
   - `ScheduleConfigSchema`: z.object with id (string), name (string), cronExpression (string), timezone (string optional), activeHours (ActiveHoursSchema optional), maxRuns (number optional), workflowId (string optional), enabled (boolean default true)
   - `HeartbeatConfigSchema`: z.object with interval (number default 30), timezone (string optional), activeHours (ActiveHoursSchema optional)
   - Export inferred types: ActiveHours, ScheduleConfig, HeartbeatConfig

4. Create `packages/gateway/src/scheduler/index.ts` as barrel:
   - `export * from "./types.js";`
   - (Scheduler/heartbeat exports will be added in plan 08-03)
  </action>
  <verify>
`pnpm --filter @agentspace/gateway exec tsc --noEmit` passes.
Grep for `WorkflowDefinitionSchema` and `ScheduleConfigSchema` in the new files confirms they exist.
  </verify>
  <done>Zod validation schemas exist for workflow definitions (steps, branching, tool/model actions), schedule configs (cron, active hours, one-shot), and heartbeat configs. All types are exported.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @agentspace/db exec tsc --noEmit` — DB schemas compile
2. `pnpm --filter @agentspace/gateway exec tsc --noEmit` — Gateway types compile with new deps
3. Both workflow/ and scheduler/ directories exist with types.ts and index.ts
4. DB schema barrel exports include workflows, workflowExecutions, schedules
</verification>

<success_criteria>
- Three new DB tables defined: workflows, workflowExecutions, schedules
- Zod schemas validate workflow definitions with steps, branching, tool/model actions
- Zod schemas validate schedule configs with cron expressions, active hours, one-shot
- croner and yaml installed in gateway package
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflows-scheduling/08-01-SUMMARY.md`
</output>
