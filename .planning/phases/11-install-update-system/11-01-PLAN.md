---
phase: 11-install-update-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/memory/soul-manager.ts
  - packages/db/src/memory/memory-curator.ts
  - packages/db/src/memory/daily-logger.ts
autonomous: true

must_haves:
  truths:
    - "Memory files (SOUL.md, MEMORY.md, daily logs) are read from and written to ~/.config/agentspace/memory/"
    - "First run auto-seeds template files from packages/db/memory-files/ to CONFIG_DIR/memory/ if not present"
    - "Existing dev-mode memory files at old location are auto-migrated to new location on first access"
  artifacts:
    - path: "packages/db/src/memory/soul-manager.ts"
      provides: "Soul manager reading from CONFIG_DIR/memory/SOUL.md"
      contains: "CONFIG_DIR"
    - path: "packages/db/src/memory/memory-curator.ts"
      provides: "Memory curator reading from CONFIG_DIR/memory/MEMORY.md"
      contains: "CONFIG_DIR"
    - path: "packages/db/src/memory/daily-logger.ts"
      provides: "Daily logger writing to CONFIG_DIR/memory/daily/"
      contains: "CONFIG_DIR"
  key_links:
    - from: "packages/db/src/memory/soul-manager.ts"
      to: "@agentspace/core CONFIG_DIR"
      via: "import { CONFIG_DIR } from @agentspace/core"
      pattern: "import.*CONFIG_DIR.*@agentspace/core"
    - from: "packages/db/src/memory/memory-curator.ts"
      to: "@agentspace/core CONFIG_DIR"
      via: "import { CONFIG_DIR } from @agentspace/core"
      pattern: "import.*CONFIG_DIR.*@agentspace/core"
    - from: "packages/db/src/memory/daily-logger.ts"
      to: "@agentspace/core CONFIG_DIR"
      via: "import { CONFIG_DIR } from @agentspace/core"
      pattern: "import.*CONFIG_DIR.*@agentspace/core"
---

<objective>
Relocate memory file resolution from `__dirname`-relative paths inside the package tree to `CONFIG_DIR`-relative paths in `~/.config/agentspace/memory/`. This is a prerequisite for the install/update system -- without this change, updating the installation would destroy user personality and memory data.

Purpose: Make memory files update-safe by storing them outside the code directory
Output: Three refactored memory modules that read/write from CONFIG_DIR, with auto-migration and first-run seeding
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/src/memory/soul-manager.ts
@packages/db/src/memory/memory-curator.ts
@packages/db/src/memory/daily-logger.ts
@packages/core/src/config/types.ts
@packages/db/memory-files/SOUL.md
@packages/db/memory-files/MEMORY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor memory file paths from __dirname to CONFIG_DIR</name>
  <files>
    packages/db/src/memory/soul-manager.ts
    packages/db/src/memory/memory-curator.ts
    packages/db/src/memory/daily-logger.ts
  </files>
  <action>
Refactor all three memory modules to resolve file paths from CONFIG_DIR instead of __dirname/import.meta.url.

For each file:
1. Remove the `__dirname` derivation (`dirname(fileURLToPath(import.meta.url))`) and the `fileURLToPath`/`dirname` imports
2. Add `import { CONFIG_DIR } from "@agentspace/core";`
3. Change path resolution:
   - soul-manager.ts: `const SOUL_PATH = join(CONFIG_DIR, "memory", "SOUL.md");`
   - memory-curator.ts: `const MEMORY_PATH = join(CONFIG_DIR, "memory", "MEMORY.md");`
   - daily-logger.ts: `const MEMORY_DIR = join(CONFIG_DIR, "memory", "daily");`
4. Use `join` from `node:path` (not `resolve`) since CONFIG_DIR is already absolute

Keep `packages/db/memory-files/` as template source files (not deleted). They serve as defaults for first-install seeding.
  </action>
  <verify>
Run `pnpm build` from the monorepo root. All three packages compile without errors. Grep for `import.meta.url` in the three memory files -- should return zero matches. Grep for `CONFIG_DIR` -- should return matches in all three files.
  </verify>
  <done>All three memory modules resolve paths via CONFIG_DIR. No references to __dirname or import.meta.url remain in these files.</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-migration and first-run seeding logic</name>
  <files>
    packages/db/src/memory/soul-manager.ts
    packages/db/src/memory/memory-curator.ts
    packages/db/src/memory/daily-logger.ts
  </files>
  <action>
Add initialization logic to each module that handles two scenarios:

**Scenario A: First install (no files at new location, no files at old location)**
- When `loadSoul()` / `loadLongTermMemory()` / `loadRecentLogs()` is called and the file doesn't exist at `CONFIG_DIR/memory/`:
  - Create `CONFIG_DIR/memory/` (and `daily/` subdirectory) via `mkdirSync({ recursive: true })`
  - Derive the template source path: `join(dirname(fileURLToPath(import.meta.url)), "../../memory-files/SOUL.md")` (keep import.meta.url ONLY for the template path derivation, used once during seeding)
  - If template file exists at source, copy it to the CONFIG_DIR location
  - If template doesn't exist either (deployed install), return empty string gracefully

**Scenario B: Dev-mode migration (files exist at old __dirname location but not at new CONFIG_DIR location)**
- Before reading, check if file exists at new location
- If not, check old location: `resolve(dirname(fileURLToPath(import.meta.url)), "../../memory-files/SOUL.md")`
- If file exists at old location but not new, copy it (migration)
- Log a deprecation message to stderr: `console.error("[agentspace] Migrated SOUL.md to ~/.config/agentspace/memory/")`

Implementation approach: Create a helper function `ensureMemoryFile(filename: string, templateSubpath: string): string` at the top of each file (or better: a shared `packages/db/src/memory/ensure-memory.ts` utility) that:
1. Checks if `join(CONFIG_DIR, "memory", filename)` exists
2. If not, checks template location `join(dirname(fileURLToPath(import.meta.url)), templateSubpath)`
3. If template exists, copies to CONFIG_DIR location and logs migration
4. Returns the CONFIG_DIR path regardless

Use this helper in each module's path initialization.

Note: Keep `import.meta.url` usage ONLY inside the shared `ensureMemoryFile` utility for locating templates. The main path constants should use CONFIG_DIR.
  </action>
  <verify>
Run `pnpm build` from the monorepo root -- compiles without errors. Manually verify the logic by:
1. Temporarily renaming `~/.config/agentspace/memory/` and running a quick test import of the module -- it should recreate the directory and seed from templates
2. Restore the directory after testing
  </verify>
  <done>First-run seeding copies template files to CONFIG_DIR/memory/. Dev-mode migration copies existing files from old location. Both scenarios handled gracefully without errors.</done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds across all packages
2. `grep -r "import.meta.url" packages/db/src/memory/` only appears in the shared ensure-memory utility (for template location), not in the main path constants
3. `grep -r "CONFIG_DIR" packages/db/src/memory/` shows matches in all three memory modules
4. The `packages/db/memory-files/` directory still exists with template SOUL.md and MEMORY.md (not deleted)
</verification>

<success_criteria>
Memory files are resolved from `~/.config/agentspace/memory/` instead of `packages/db/memory-files/`. The install/update system can safely replace the packages directory without destroying user personality, memory, or daily logs.
</success_criteria>

<output>
After completion, create `.planning/phases/11-install-update-system/11-01-SUMMARY.md`
</output>
