---
phase: 11-install-update-system
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - scripts/install.sh
  - scripts/update.sh
autonomous: true

must_haves:
  truths:
    - "User can run install.sh to deploy AgentSpace from source repo to any target directory"
    - "User can run update.sh to replace code at install directory without losing config, database, memory, or skills"
    - "Gateway is gracefully stopped before update and user is informed how to restart"
    - "Native modules (better-sqlite3, sqlite-vec, node-pty) work at install target because node_modules are copied from source"
  artifacts:
    - path: "scripts/install.sh"
      provides: "First-time installation script"
      contains: "rsync"
    - path: "scripts/update.sh"
      provides: "Update script that preserves user data"
      contains: "runtime.json"
  key_links:
    - from: "scripts/install.sh"
      to: "~/.config/agentspace/memory/"
      via: "Seeds template files on first install"
      pattern: "memory-files.*SOUL"
    - from: "scripts/update.sh"
      to: "~/.config/agentspace/runtime.json"
      via: "Reads PID and stops gateway before update"
      pattern: "runtime.json"
---

<objective>
Create install.sh and update.sh shell scripts that deploy AgentSpace from the source repo to a target directory. Install handles first-time setup including building, copying artifacts, syncing node_modules, seeding memory templates, creating bin symlinks, and writing a version marker. Update handles stopping the gateway, rebuilding, syncing delta changes, and updating the version marker -- all without touching user data in `~/.config/agentspace/`.

Purpose: Enable users to install and update AgentSpace independently from the development repo
Output: Two executable shell scripts in `scripts/` directory
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-install-update-system/11-RESEARCH.md
@package.json
@packages/core/src/config/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create install.sh script</name>
  <files>scripts/install.sh</files>
  <action>
Create `scripts/install.sh` with `#!/usr/bin/env bash` and `set -euo pipefail`.

**Arguments:** `INSTALL_DIR` as $1 (default: `$HOME/agentspace`)

**Steps the script performs:**
1. Derive `SOURCE_DIR` from script location: `$(cd "$(dirname "$0")/.." && pwd)`
2. Set `CONFIG_DIR="$HOME/.config/agentspace"`
3. Check Node.js >= 22: `node -e "if(parseInt(process.version.slice(1))<22){process.exit(1)}"` or fail with message
4. Build in source: `cd "$SOURCE_DIR" && pnpm install && pnpm build`
5. Create install dir: `mkdir -p "$INSTALL_DIR"`
6. rsync packages (excluding source files, dev artifacts, old memory-files):
   ```
   rsync -a --delete \
     --exclude='src/' \
     --exclude='*.tsbuildinfo' \
     --exclude='.turbo/' \
     --exclude='memory-files/' \
     --exclude='.env' \
     --exclude='tsconfig*.json' \
     --exclude='vitest.config.*' \
     --exclude='biome.json' \
     "$SOURCE_DIR/packages/" "$INSTALL_DIR/packages/"
   ```
7. Copy root files: `package.json`, `pnpm-lock.yaml`, `pnpm-workspace.yaml`
8. Sync root `node_modules/`:
   ```
   rsync -a --delete "$SOURCE_DIR/node_modules/" "$INSTALL_DIR/node_modules/"
   ```
9. Sync per-package `node_modules/` (loop over core, db, cli, gateway, telegram):
   ```
   for pkg in core db cli gateway telegram; do
     if [ -d "$SOURCE_DIR/packages/$pkg/node_modules" ]; then
       mkdir -p "$INSTALL_DIR/packages/$pkg/node_modules"
       rsync -a --delete \
         "$SOURCE_DIR/packages/$pkg/node_modules/" \
         "$INSTALL_DIR/packages/$pkg/node_modules/"
     fi
   done
   ```
10. Seed memory templates on first install:
    ```
    mkdir -p "$CONFIG_DIR/memory/daily"
    if [ ! -f "$CONFIG_DIR/memory/SOUL.md" ]; then
      cp "$SOURCE_DIR/packages/db/memory-files/SOUL.md" "$CONFIG_DIR/memory/"
      cp "$SOURCE_DIR/packages/db/memory-files/MEMORY.md" "$CONFIG_DIR/memory/"
      echo "Seeded default personality and memory files."
    fi
    ```
11. Create bin symlink:
    ```
    mkdir -p "$INSTALL_DIR/bin"
    ln -sf "../packages/cli/dist/index.js" "$INSTALL_DIR/bin/agentspace"
    chmod +x "$INSTALL_DIR/packages/cli/dist/index.js"
    ```
12. Write `.version` JSON file at install root with: version (from root package.json), sourceCommit (git rev-parse --short HEAD), installedAt (ISO date), updatedAt (same as installedAt), nodeVersion (node -v)
13. Print success message with PATH instruction: `export PATH="$INSTALL_DIR/bin:$PATH"`

Mark the file executable: `chmod +x scripts/install.sh`
  </action>
  <verify>
Run `bash -n scripts/install.sh` to syntax-check. Run `scripts/install.sh /tmp/agentspace-test` to verify a complete install. Check that `/tmp/agentspace-test/packages/cli/dist/index.js` exists, `/tmp/agentspace-test/.version` contains valid JSON, and `~/.config/agentspace/memory/SOUL.md` exists. Clean up with `rm -rf /tmp/agentspace-test`.
  </verify>
  <done>install.sh builds from source, deploys to target directory, seeds memory templates, creates bin symlink, and writes version marker. No user data in ~/.config/agentspace/ is modified if it already exists.</done>
</task>

<task type="auto">
  <name>Task 2: Create update.sh script</name>
  <files>scripts/update.sh</files>
  <action>
Create `scripts/update.sh` with `#!/usr/bin/env bash` and `set -euo pipefail`.

**Arguments:** `INSTALL_DIR` as $1 (default: `$HOME/agentspace`)

**Steps the script performs:**
1. Derive `SOURCE_DIR` from script location: `$(cd "$(dirname "$0")/.." && pwd)`
2. Set `CONFIG_DIR="$HOME/.config/agentspace"` and `RUNTIME="$CONFIG_DIR/runtime.json"`
3. Verify install directory exists: `[ -d "$INSTALL_DIR" ] || { echo "Error: $INSTALL_DIR does not exist. Run install.sh first."; exit 1; }`
4. Stop gateway if running:
   ```
   if [ -f "$RUNTIME" ]; then
     PID=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$RUNTIME','utf-8')).pid)" 2>/dev/null || echo "")
     if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
       echo "Stopping gateway (PID $PID)..."
       kill "$PID"
       for i in $(seq 1 10); do
         [ ! -f "$RUNTIME" ] && break
         sleep 0.5
       done
     fi
     rm -f "$RUNTIME"
   fi
   ```
5. Build fresh: `cd "$SOURCE_DIR" && pnpm install && pnpm build`
6. Sync packages (same rsync as install.sh -- identical exclude patterns)
7. Copy root files (same as install.sh)
8. Sync node_modules (same as install.sh)
9. Update `.version` file: same as install but set `updatedAt` to current time while preserving `installedAt` from existing `.version` if present
10. Print success message: "AgentSpace updated. Start with: node $INSTALL_DIR/packages/gateway/dist/index.js"

Mark the file executable: `chmod +x scripts/update.sh`

Note: update.sh does NOT seed memory templates (that's install-only). It does NOT touch `~/.config/agentspace/` at all except reading runtime.json for gateway shutdown.
  </action>
  <verify>
Run `bash -n scripts/update.sh` to syntax-check. Verify the script can detect and stop a mock gateway by creating a test runtime.json. Verify rsync exclude patterns match install.sh exactly (diff the two files).
  </verify>
  <done>update.sh stops the gateway, rebuilds from source, and syncs updated code to install directory. User data (config, database, memory, skills) is untouched.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/install.sh && bash -n scripts/update.sh` -- both pass syntax check
2. Both scripts are executable (`-x` permission)
3. rsync exclude patterns are identical between install.sh and update.sh
4. install.sh seeds memory templates; update.sh does not
5. update.sh checks for runtime.json and stops gateway before syncing
6. Both scripts write/update .version with sourceCommit and nodeVersion
</verification>

<success_criteria>
A user can run `scripts/install.sh ~/agentspace` to deploy AgentSpace, then later run `scripts/update.sh ~/agentspace` to update the code without losing any user data.
</success_criteria>

<output>
After completion, create `.planning/phases/11-install-update-system/11-02-SUMMARY.md`
</output>
