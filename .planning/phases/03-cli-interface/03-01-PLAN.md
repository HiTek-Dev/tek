---
phase: 03-cli-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/package.json
  - packages/cli/src/lib/discovery.ts
  - packages/cli/src/lib/gateway-client.ts
  - packages/cli/src/hooks/useWebSocket.ts
  - packages/cli/src/hooks/useChat.ts
  - packages/cli/src/commands/chat.ts
  - packages/cli/src/components/Chat.tsx
autonomous: true

must_haves:
  truths:
    - "CLI can discover a running gateway by reading runtime.json and verifying the process is alive"
    - "useWebSocket hook connects to gateway WebSocket, sends typed ClientMessage objects, and dispatches typed ServerMessage objects to callbacks"
    - "useChat hook manages chat state: messages array, streaming text accumulation, session tracking, model tracking, and usage totals"
    - "agentspace chat command launches an Ink-rendered Chat component connected to the discovered gateway"
  artifacts:
    - path: "packages/cli/src/lib/discovery.ts"
      provides: "Gateway auto-discovery via runtime.json"
      exports: ["discoverGateway"]
    - path: "packages/cli/src/lib/gateway-client.ts"
      provides: "Typed WebSocket message helpers and ChatMessage type"
      exports: ["createChatSendMessage", "createContextInspectMessage", "createUsageQueryMessage", "createSessionListMessage", "ChatMessage"]
    - path: "packages/cli/src/hooks/useWebSocket.ts"
      provides: "React hook for WebSocket connection lifecycle"
      exports: ["useWebSocket"]
    - path: "packages/cli/src/hooks/useChat.ts"
      provides: "React hook for chat state management"
      exports: ["useChat"]
    - path: "packages/cli/src/commands/chat.ts"
      provides: "Commander chat subcommand"
      exports: ["chatCommand"]
    - path: "packages/cli/src/components/Chat.tsx"
      provides: "Top-level Ink chat application shell"
      exports: ["Chat"]
  key_links:
    - from: "packages/cli/src/lib/discovery.ts"
      to: "@agentspace/core RUNTIME_PATH"
      via: "import { RUNTIME_PATH } from @agentspace/core"
      pattern: "RUNTIME_PATH"
    - from: "packages/cli/src/hooks/useWebSocket.ts"
      to: "ws library"
      via: "new WebSocket(url) in useEffect"
      pattern: "new WebSocket"
    - from: "packages/cli/src/hooks/useChat.ts"
      to: "packages/cli/src/hooks/useWebSocket.ts"
      via: "handleServerMessage dispatches by msg.type"
      pattern: "msg\\.type"
    - from: "packages/cli/src/commands/chat.ts"
      to: "packages/cli/src/lib/discovery.ts"
      via: "discoverGateway() call before render"
      pattern: "discoverGateway"
---

<objective>
Install new dependencies (marked, marked-terminal, cli-highlight, ws, nanoid, @types/ws), build the gateway discovery module, WebSocket hook, chat state hook, and a minimal Chat component shell that connects to the gateway and can send/receive messages.

Purpose: Establish the communication layer between CLI and gateway. All subsequent UI work (Plan 03-02) depends on this plumbing being solid.
Output: Working gateway discovery, typed WebSocket hook, chat state management hook, and a launchable `agentspace chat` command that renders a minimal Ink app.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cli-interface/03-RESEARCH.md
@packages/gateway/src/ws/protocol.ts
@packages/gateway/src/index.ts
@packages/core/src/config/types.ts
@packages/cli/src/index.ts
@packages/cli/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create gateway discovery + client helpers</name>
  <files>
    packages/cli/package.json
    packages/cli/src/lib/discovery.ts
    packages/cli/src/lib/gateway-client.ts
  </files>
  <action>
1. Install new dependencies:
   ```bash
   pnpm --filter @agentspace/cli add marked marked-terminal cli-highlight ws nanoid
   pnpm --filter @agentspace/cli add -D @types/ws
   ```
   Also add `@agentspace/gateway` as a workspace dependency for type imports:
   ```bash
   pnpm --filter @agentspace/cli add @agentspace/gateway@workspace:*
   ```

2. Create `packages/cli/src/lib/discovery.ts`:
   - Import `RUNTIME_PATH` from `@agentspace/core`
   - Import `readFileSync`, `existsSync` from `node:fs`
   - Define `RuntimeInfo` interface: `{ pid: number; port: number; startedAt: string }`
   - Export `discoverGateway(): RuntimeInfo | null`
     - If `RUNTIME_PATH` does not exist, return null
     - Read and JSON.parse the file
     - Verify the process is alive: `process.kill(data.pid, 0)` in a try/catch (signal 0 checks existence without killing)
     - If process is dead, return null
     - Return the parsed RuntimeInfo

3. Create `packages/cli/src/lib/gateway-client.ts`:
   - Import `nanoid` from `nanoid`
   - Import `ClientMessage` type from `@agentspace/gateway`
   - Define and export `ChatMessage` interface: `{ id: string; role: "user" | "assistant" | "system"; content: string; timestamp: string }`
   - Export helper functions that create typed ClientMessage objects:
     - `createChatSendMessage(content: string, opts?: { sessionId?: string; model?: string }): ClientMessage` — creates `{ type: "chat.send", id: nanoid(), content, ...opts }`
     - `createContextInspectMessage(sessionId: string): ClientMessage` — creates `{ type: "context.inspect", id: nanoid(), sessionId }`
     - `createUsageQueryMessage(sessionId?: string): ClientMessage` — creates `{ type: "usage.query", id: nanoid(), sessionId }`
     - `createSessionListMessage(): ClientMessage` — creates `{ type: "session.list", id: nanoid() }`
  </action>
  <verify>
    Run `pnpm --filter @agentspace/cli build` — compiles without errors. Check that `marked`, `marked-terminal`, `cli-highlight`, `ws`, `nanoid`, `@agentspace/gateway`, and `@types/ws` appear in package.json dependencies/devDependencies.
  </verify>
  <done>
    discovery.ts exports discoverGateway() that reads runtime.json and verifies PID liveness. gateway-client.ts exports typed message factory functions and ChatMessage type. All new deps installed. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useWebSocket hook, useChat hook, chat command, and Chat shell component</name>
  <files>
    packages/cli/src/hooks/useWebSocket.ts
    packages/cli/src/hooks/useChat.ts
    packages/cli/src/commands/chat.ts
    packages/cli/src/components/Chat.tsx
    packages/cli/src/index.ts
  </files>
  <action>
1. Create `packages/cli/src/hooks/useWebSocket.ts`:
   - Import `useEffect`, `useRef`, `useCallback`, `useState` from `react`
   - Import `WebSocket` from `ws`
   - Import `ServerMessage` type from `@agentspace/gateway`
   - Import `ClientMessage` type from `@agentspace/gateway`
   - Define `UseWebSocketOptions`: `{ url: string; onMessage: (msg: ServerMessage) => void; onError?: (err: Error) => void; onClose?: () => void }`
   - Export `useWebSocket(opts: UseWebSocketOptions): { send: (msg: ClientMessage) => void; connected: boolean }`
   - In useEffect (dep: [url]):
     - Create `new WebSocket(url)`
     - On `open`: `setConnected(true)`
     - On `message` (raw: Buffer): `JSON.parse(raw.toString())` then call `onMessage`
     - On `error`: call `onError` if provided
     - On `close`: `setConnected(false)`, call `onClose` if provided
     - Cleanup: `ws.close()`
   - `send` callback: `wsRef.current?.send(JSON.stringify(msg))`
   - Store `onMessage`, `onError`, `onClose` in refs to avoid stale closures

2. Create `packages/cli/src/hooks/useChat.ts`:
   - Import `useState`, `useCallback` from `react`
   - Import `ServerMessage` type from `@agentspace/gateway`
   - Import `ChatMessage` from `../lib/gateway-client.js`
   - Define `UseChatOptions`: `{ initialModel?: string; resumeSessionId?: string }`
   - Define `UseChatState`: `{ messages: ChatMessage[]; streamingText: string; sessionId: string | null; model: string; connected: boolean; usage: { totalTokens: number; totalCost: number } }`
   - Export `useChat(opts: UseChatOptions)` returning state + `handleServerMessage` + `addUserMessage` + `setConnected`
   - `handleServerMessage(msg: ServerMessage)`:
     - `session.created`: set sessionId from msg.sessionId
     - `chat.stream.start`: clear streamingText, update model
     - `chat.stream.delta`: append msg.delta to streamingText
     - `chat.stream.end`: push completed assistant ChatMessage to messages array (using accumulated streamingText), clear streamingText, update usage totals from msg.usage/msg.cost
     - `error`: push system ChatMessage with error content, clear streamingText
     - `session.list`: ignore for now (will handle in 03-02 slash commands)
     - `context.inspection`, `usage.report`: ignore for now
   - `addUserMessage(content: string)`: push new user ChatMessage to messages
   - Default model: `"claude-sonnet-4-5-20250929"` (from 02-03 decision)

3. Create `packages/cli/src/components/Chat.tsx`:
   - Minimal shell component for now — full UI components come in Plan 03-02
   - Import React, `Box`, `Text`, `Static` from `ink`
   - Import `TextInput` from `@inkjs/ui`
   - Import `useWebSocket` and `useChat` hooks
   - Import `createChatSendMessage` from gateway-client
   - Props: `{ wsUrl: string; initialModel?: string; resumeSessionId?: string }`
   - Use `useChat` for state, `useWebSocket` for connection
   - Pass `handleServerMessage` to useWebSocket's `onMessage`
   - On WebSocket connect/disconnect, call `setConnected`
   - Render:
     - `<Static items={messages}>` rendering each message as `<Box key={msg.id}><Text>{msg.role}: {msg.content}</Text></Box>`
     - If streamingText: `<Box><Text color="green">assistant: {streamingText}</Text></Box>`
     - Connection status: `<Text color={connected ? "green" : "red"}>{connected ? "Connected" : "Disconnected"}</Text>`
     - `<TextInput>` for user input — on submit, call `addUserMessage(value)` and `send(createChatSendMessage(value, { sessionId, model }))`
   - This is intentionally minimal. Plan 03-02 replaces these raw renderings with proper MessageBubble, StatusBar, etc.

4. Create `packages/cli/src/commands/chat.ts`:
   - Import `Command` from `commander`
   - Import React and `render` from `ink`
   - Import `discoverGateway` from `../lib/discovery.js`
   - Import `Chat` from `../components/Chat.js`
   - Export `chatCommand` as new Command("chat")
     - `.description("Start a chat session with your agent")`
     - `.option("-m, --model <model>", "Model to use")`
     - `.option("-s, --session <id>", "Resume an existing session")`
     - `.action(async (options) => { ... })`
   - In action:
     - Call `discoverGateway()`. If null, print error: "Gateway is not running. Start it with: node packages/gateway/dist/index.js" and `process.exit(1)`
     - Construct wsUrl: `ws://127.0.0.1:${gateway.port}/gateway`
     - Call `render(React.createElement(Chat, { wsUrl, initialModel: options.model, resumeSessionId: options.session }))`
     - `await waitUntilExit()`

5. Update `packages/cli/src/index.ts`:
   - Import `chatCommand` from `./commands/chat.js`
   - Add `program.addCommand(chatCommand)`
   - Update default action: if configured and gateway is discoverable, suggest `agentspace chat` instead of just showing help
  </action>
  <verify>
    Run `pnpm --filter @agentspace/cli build` — compiles without errors. Run `pnpm --filter @agentspace/cli exec agentspace chat --help` to verify the chat command is registered and shows --model and --session options.
  </verify>
  <done>
    useWebSocket hook manages WebSocket lifecycle with typed send/receive. useChat hook handles all server message types and manages chat state. Chat component renders a minimal but functional chat interface. `agentspace chat` command discovers gateway and launches the Ink app. `agentspace chat --help` shows available options. Build passes cleanly.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @agentspace/cli build` passes with zero errors
2. `agentspace chat --help` displays usage with --model and --session options
3. `agentspace chat` without a running gateway prints a clear error message and exits with code 1
4. All new files follow existing patterns: ESM-only, .js extensions in imports, barrel exports where appropriate
</verification>

<success_criteria>
- Gateway discovery reads runtime.json and verifies PID liveness
- WebSocket hook connects, sends, receives, and tracks connection state
- Chat hook accumulates streaming deltas and promotes to messages on stream.end
- `agentspace chat` command is registered and launchable
- All code compiles cleanly with TypeScript
</success_criteria>

<output>
After completion, create `.planning/phases/03-cli-interface/03-01-SUMMARY.md`
</output>
