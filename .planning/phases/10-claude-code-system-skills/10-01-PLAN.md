---
phase: 10-claude-code-system-skills
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/claude-code/types.ts
  - packages/gateway/src/claude-code/session-manager.ts
  - packages/gateway/src/claude-code/event-relay.ts
  - packages/gateway/src/claude-code/index.ts
autonomous: true

must_haves:
  truths:
    - "AgentSpace can spawn a Claude Code session and receive typed SDK events"
    - "Claude Code streaming output is relayed as ServerMessage events to the transport"
    - "Sessions can be aborted and have timeout-based cleanup for the hanging CLI bug"
  artifacts:
    - path: "packages/gateway/src/claude-code/types.ts"
      provides: "ClaudeCodeSession state types, SDK event to ServerMessage mapping types"
      exports: ["ClaudeCodeSession", "ClaudeCodeSessionStatus"]
    - path: "packages/gateway/src/claude-code/session-manager.ts"
      provides: "Session spawn, abort, tracking, and lifecycle management"
      exports: ["ClaudeCodeSessionManager"]
    - path: "packages/gateway/src/claude-code/event-relay.ts"
      provides: "Async generator consumer that maps SDK events to transport.send() calls"
      exports: ["consumeAndRelay"]
    - path: "packages/gateway/src/claude-code/index.ts"
      provides: "Barrel exports for claude-code module"
  key_links:
    - from: "packages/gateway/src/claude-code/session-manager.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "query() async generator"
      pattern: "import.*from.*claude-agent-sdk"
    - from: "packages/gateway/src/claude-code/event-relay.ts"
      to: "packages/gateway/src/transport.ts"
      via: "transport.send(ServerMessage)"
      pattern: "transport\\.send"
---

<objective>
Create the Claude Code session manager and event relay that can spawn Claude Code CLI sessions via the Agent SDK, consume the async generator of typed events, and relay streaming output to any AgentSpace transport.

Purpose: This is the foundational layer for all Claude Code integration (CCDE-01, CCDE-04). It enables AgentSpace to programmatically spawn Claude Code, track session state, and stream output in real-time.

Output: `packages/gateway/src/claude-code/` module with session manager, event relay, and types.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-claude-code-system-skills/10-RESEARCH.md
@packages/gateway/src/transport.ts
@packages/gateway/src/ws/protocol.ts
@packages/gateway/src/ws/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Claude Code types and session manager</name>
  <files>
    packages/gateway/src/claude-code/types.ts
    packages/gateway/src/claude-code/session-manager.ts
  </files>
  <action>
Create `packages/gateway/src/claude-code/types.ts`:
- Define `ClaudeCodeSessionStatus` type: `"spawning" | "running" | "waiting-approval" | "completed" | "error" | "aborted"`
- Define `ClaudeCodeSession` interface with: `id: string`, `status: ClaudeCodeSessionStatus`, `abortController: AbortController`, `prompt: string`, `cwd: string`, `createdAt: Date`, `completedAt?: Date`, `totalCostUsd?: number`
- Define `SpawnSessionOptions` interface with: `prompt: string`, `cwd: string`, `allowedTools?: string[]`, `permissionMode?: "default" | "acceptEdits" | "bypassPermissions"`, `maxTurns?: number`

Create `packages/gateway/src/claude-code/session-manager.ts`:
- Import `query` from `@anthropic-ai/claude-agent-sdk`
- Create `ClaudeCodeSessionManager` class with:
  - Private `sessions: Map<string, ClaudeCodeSession>` for tracking active sessions
  - `spawn(options: SpawnSessionOptions, transport: Transport, requestId: string, canUseTool?)` method that:
    1. Creates an AbortController
    2. Calls `query({ prompt, options: { cwd, abortController, includePartialMessages: true, permissionMode, allowedTools, canUseTool } })`
    3. Stores session in map with status "running"
    4. Kicks off event relay consumption (non-blocking, via `consumeAndRelay()`)
    5. Returns the session
  - `abort(sessionId: string)` method that calls `abortController.abort()` and updates status
  - `getSession(sessionId: string)` getter
  - `listSessions()` getter
  - `cleanup(sessionId: string)` that removes session from map
  - Implement a 30-second post-completion timeout: after receiving a "result" event, set a timer to abort if the generator hasn't returned (addresses Pitfall 1 from research: CLI hanging bug)
- Use `createLogger("claude-code")` for logging
- Session IDs generated via `crypto.randomUUID()`
  </action>
  <verify>
Run `npx tsc --noEmit` from `packages/gateway` -- types compile without errors. Verify session-manager imports from Agent SDK resolve.
  </verify>
  <done>ClaudeCodeSessionManager can spawn sessions via Agent SDK `query()`, track them by ID, abort them, and has a post-completion timeout safety mechanism.</done>
</task>

<task type="auto">
  <name>Task 2: Event relay and barrel exports</name>
  <files>
    packages/gateway/src/claude-code/event-relay.ts
    packages/gateway/src/claude-code/index.ts
  </files>
  <action>
Create `packages/gateway/src/claude-code/event-relay.ts`:
- Import types from Agent SDK (`SDKMessage` or equivalent typed events from the query generator)
- Export `consumeAndRelay(session: ClaudeCodeSession, queryInstance: AsyncGenerator, transport: Transport, requestId: string)` async function that:
  - Iterates `for await (const message of queryInstance)`
  - Handles `stream_event` type: extract content_block_delta text_delta and call `transport.send({ type: "chat.stream.delta", requestId, delta: text })` -- reuse existing `chat.stream.delta` ServerMessage type for streaming text (no new protocol type needed for MVP)
  - Handles `assistant` type: relay complete assistant messages with tool call info via `transport.send({ type: "tool.call", requestId, toolCallId, toolName, args })` for each tool_use block
  - Handles `result` type: send `transport.send({ type: "chat.stream.end", requestId, usage: { inputTokens, outputTokens, totalTokens }, cost: { inputCost: totalCostUsd, outputCost: 0, totalCost: totalCostUsd } })`, update session status to "completed", store cost
  - On generator error: update session status to "error", send `transport.send({ type: "error", requestId, code: "claude-code-error", message: errorMessage })`
  - Wrap entire loop in try/catch/finally for cleanup
- Note: Reuse existing ServerMessage types (`chat.stream.delta`, `chat.stream.end`, `tool.call`, `tool.result`, `error`) rather than creating new Claude Code-specific protocol messages. This lets existing CLI and Telegram UI render Claude Code output with zero changes.

Create `packages/gateway/src/claude-code/index.ts`:
- Barrel export: `ClaudeCodeSessionManager`, `consumeAndRelay`, and all types from types.ts
  </action>
  <verify>
Run `npx tsc --noEmit` from `packages/gateway` -- no type errors. Verify event-relay correctly maps SDK event types to existing ServerMessage types.
  </verify>
  <done>Event relay maps Claude Agent SDK events to existing ServerMessage types (chat.stream.delta, chat.stream.end, tool.call, error) enabling existing CLI and Telegram transports to render Claude Code output without modification.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in packages/gateway
2. All exports from `packages/gateway/src/claude-code/index.ts` resolve
3. ClaudeCodeSessionManager can be instantiated and has spawn/abort/getSession/listSessions methods
4. Event relay function signature accepts Transport and uses transport.send with existing ServerMessage types
</verification>

<success_criteria>
- Claude Code module exists at packages/gateway/src/claude-code/ with types, session-manager, event-relay, and barrel index
- Session manager wraps Agent SDK `query()` with lifecycle tracking and abort support
- Event relay maps SDK events to existing transport protocol (no new ServerMessage types needed)
- Post-completion timeout handles the known CLI hanging bug
</success_criteria>

<output>
After completion, create `.planning/phases/10-claude-code-system-skills/10-01-SUMMARY.md`
</output>
