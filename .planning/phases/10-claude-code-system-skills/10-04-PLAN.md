---
phase: 10-claude-code-system-skills
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/skills/google-workspace.ts
  - packages/gateway/src/skills/google-auth.ts
  - packages/gateway/src/skills/index.ts
  - packages/gateway/src/agent/tool-registry.ts
autonomous: true

user_setup:
  - service: google-cloud
    why: "Google Workspace API access requires OAuth 2.0 credentials"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
      - name: GOOGLE_REFRESH_TOKEN
        source: "Generated during first-time OAuth flow (stored by AgentSpace after initial auth)"
    dashboard_config:
      - task: "Create OAuth 2.0 credentials (Desktop app type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Enable Gmail, Drive, Calendar, and Docs APIs"
        location: "Google Cloud Console -> APIs & Services -> Library"

must_haves:
  truths:
    - "Agent can search and read Gmail messages"
    - "Agent can list and search Google Drive files"
    - "Agent can list and create Google Calendar events"
    - "Agent can read and create Google Docs"
    - "Google Workspace tools are available in the tool registry when credentials are configured"
  artifacts:
    - path: "packages/gateway/src/skills/google-auth.ts"
      provides: "OAuth2Client factory and token management"
      exports: ["createGoogleAuth", "GoogleAuthConfig"]
    - path: "packages/gateway/src/skills/google-workspace.ts"
      provides: "Google Workspace AI SDK tools (Gmail, Drive, Calendar, Docs)"
      exports: ["createGoogleWorkspaceTools"]
    - path: "packages/gateway/src/skills/index.ts"
      provides: "Updated barrel exports including Google Workspace"
  key_links:
    - from: "packages/gateway/src/skills/google-workspace.ts"
      to: "googleapis"
      via: "google.gmail/drive/calendar/docs API calls"
      pattern: "google\\.(gmail|drive|calendar|docs)"
    - from: "packages/gateway/src/agent/tool-registry.ts"
      to: "packages/gateway/src/skills/google-workspace.ts"
      via: "conditional registration when Google creds available"
      pattern: "createGoogleWorkspaceTools"
---

<objective>
Implement Google Workspace integration as a set of AI SDK tools covering Gmail, Drive, Calendar, and Docs. Includes OAuth 2.0 auth helper for personal accounts.

Purpose: Delivers SYST-06 (Google Workspace integration skill).

Output: Google auth helper and workspace tools registered in the tool registry.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-claude-code-system-skills/10-RESEARCH.md
@packages/gateway/src/agent/tool-registry.ts
@packages/gateway/src/skills/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Google OAuth helper and Workspace tools</name>
  <files>
    packages/gateway/src/skills/google-auth.ts
    packages/gateway/src/skills/google-workspace.ts
  </files>
  <action>
Install dependency: `pnpm add googleapis --filter @agentspace/gateway`

Create `packages/gateway/src/skills/google-auth.ts`:
- Import `google` from "googleapis"
- Export `GoogleAuthConfig` interface: `{ clientId: string, clientSecret: string, refreshToken: string }`
- Export `createGoogleAuth(config: GoogleAuthConfig)` that:
  1. Creates `new google.auth.OAuth2(clientId, clientSecret)`
  2. Sets credentials: `oauth2Client.setCredentials({ refresh_token: refreshToken })`
  3. Returns the `oauth2Client` (handles token refresh automatically)
- This uses OAuth 2.0 for personal accounts (not service accounts, per research Pitfall 4)

Create `packages/gateway/src/skills/google-workspace.ts`:
- Import `tool` from "ai", `z` from "zod", `google` from "googleapis"
- Export `createGoogleWorkspaceTools(auth: OAuth2Client)` returning `Record<string, unknown>` (tool map):

**gmail_search** tool:
  - Description: "Search Gmail messages by query"
  - Input: `{ query: z.string(), maxResults: z.number().optional().default(10) }`
  - Execute: Call `gmail.users.messages.list({ userId: "me", q: query, maxResults })`, then fetch metadata (Subject, From, Date) for each message via `gmail.users.messages.get()` with `format: "metadata"`. Return `{ messages: [{ id, subject, from, date, snippet }], total }`

**gmail_read** tool:
  - Description: "Read a specific Gmail message by ID"
  - Input: `{ messageId: z.string() }`
  - Execute: Call `gmail.users.messages.get({ userId: "me", id: messageId, format: "full" })`. Extract subject, from, to, date from headers, body from payload (prefer text/plain part). Return `{ subject, from, to, date, body }`

**drive_search** tool:
  - Description: "Search Google Drive files by query"
  - Input: `{ query: z.string(), maxResults: z.number().optional().default(10) }`
  - Execute: Call `drive.files.list({ q: query, pageSize: maxResults, fields: "files(id,name,mimeType,modifiedTime,webViewLink)" })`. Return `{ files: [{ id, name, mimeType, modifiedTime, webViewLink }] }`

**drive_read** tool:
  - Description: "Read content from a Google Drive file (text-based files only)"
  - Input: `{ fileId: z.string() }`
  - Execute: Call `drive.files.export({ fileId, mimeType: "text/plain" })` for Google Docs/Sheets, or `drive.files.get({ fileId, alt: "media" })` for other files. Return `{ content: textContent, name, mimeType }`

**calendar_list** tool:
  - Description: "List upcoming Google Calendar events"
  - Input: `{ maxResults: z.number().optional().default(10), timeMin: z.string().optional() }`
  - Execute: Call `calendar.events.list({ calendarId: "primary", maxResults, timeMin: timeMin ?? new Date().toISOString(), singleEvents: true, orderBy: "startTime" })`. Return `{ events: [{ id, summary, start, end, location, description }] }`

**calendar_create** tool:
  - Description: "Create a Google Calendar event"
  - Input: `{ summary: z.string(), startTime: z.string(), endTime: z.string(), description: z.string().optional(), location: z.string().optional() }`
  - Execute: Call `calendar.events.insert({ calendarId: "primary", requestBody: { summary, start: { dateTime: startTime }, end: { dateTime: endTime }, description, location } })`. Return `{ eventId, htmlLink }`

**docs_read** tool:
  - Description: "Read content of a Google Doc"
  - Input: `{ documentId: z.string() }`
  - Execute: Call `docs.documents.get({ documentId })`. Extract text from body.content elements. Return `{ title, content: plainText }`

**docs_create** tool:
  - Description: "Create a new Google Doc"
  - Input: `{ title: z.string(), content: z.string() }`
  - Execute: Call `docs.documents.create({ requestBody: { title } })` then `docs.documents.batchUpdate({ documentId, requestBody: { requests: [{ insertText: { location: { index: 1 }, text: content } }] } })`. Return `{ documentId, title, url }`

Each tool wraps its execute in try/catch, returning `{ error: message }` on failure (graceful degradation).
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/gateway. Verify all 8 Google Workspace tools compile with correct AI SDK tool signatures.
  </verify>
  <done>Eight Google Workspace tools (gmail_search, gmail_read, drive_search, drive_read, calendar_list, calendar_create, docs_read, docs_create) implemented as AI SDK tools using OAuth 2.0 for personal account access.</done>
</task>

<task type="auto">
  <name>Task 2: Register Google Workspace tools in tool registry</name>
  <files>
    packages/gateway/src/skills/index.ts
    packages/gateway/src/agent/tool-registry.ts
  </files>
  <action>
Update `packages/gateway/src/skills/index.ts`:
- Add exports: `createGoogleWorkspaceTools`, `createGoogleAuth`, `GoogleAuthConfig` from google-auth.ts and google-workspace.ts

Update `packages/gateway/src/agent/tool-registry.ts`:
- Add `ToolRegistryOptions` fields: `googleAuth?: { clientId: string, clientSecret: string, refreshToken: string }`
- After system skills registration (web_search, image_generate from plan 10-03), add step 6:
  - If `googleAuth` provided:
    1. Import `createGoogleAuth` and `createGoogleWorkspaceTools` from `../skills/index.js`
    2. Create auth client: `const auth = createGoogleAuth(googleAuth)`
    3. Create tools: `const gTools = createGoogleWorkspaceTools(auth)`
    4. Register each tool with `"google_"` prefix preserved from the function (gmail_search, gmail_read, etc.)
    5. Apply approval wrappers: "auto" for read operations (gmail_search, gmail_read, drive_search, drive_read, calendar_list, docs_read), "session" for write operations (calendar_create, docs_create)
  - Log count of Google Workspace tools registered

Update `packages/gateway/src/index.ts`:
- Add export for system skills: `export { createWebSearchTool, createImageGenTool, getPlaywrightMcpConfig, createGoogleWorkspaceTools, createGoogleAuth } from "./skills/index.js"`
  </action>
  <verify>
Run `npx tsc --noEmit` from packages/gateway. Verify tool-registry.ts conditionally registers Google tools when auth config is present. Verify index.ts exports new modules.
  </verify>
  <done>Google Workspace tools conditionally registered in tool registry when OAuth credentials are configured. Read ops use "auto" approval, write ops use "session" approval. Gateway barrel exports updated with all new modules.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in packages/gateway
2. Eight Google Workspace tools exist with correct AI SDK tool signatures
3. Tool registry conditionally includes Google tools when `googleAuth` is provided
4. OAuth 2.0 auth helper handles token refresh via googleapis built-in mechanism
5. Approval tiers correctly assigned: read=auto, write=session
</verification>

<success_criteria>
- Gmail search and read tools can query and retrieve email content
- Drive search and read tools can find and read files
- Calendar list and create tools can view and create events
- Docs read and create tools can access and create documents
- All tools registered in tool registry with appropriate approval tiers
- OAuth 2.0 token refresh handled automatically by googleapis
</success_criteria>

<output>
After completion, create `.planning/phases/10-claude-code-system-skills/10-04-SUMMARY.md`
</output>
