---
phase: 26-cli-visual-overhaul
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/lib/truncate.ts
  - packages/cli/src/components/MessageBubble.tsx
  - packages/cli/src/components/ToolPanel.tsx
  - packages/cli/src/components/MessageList.tsx
autonomous: true
requirements:
  - CLIV-02
  - CLIV-04
  - CLIV-06

must_haves:
  truths:
    - "Tool output longer than 20 lines is truncated with '... (N more lines)' indicator"
    - "Messages display dimmed HH:MM timestamps"
    - "Historical tool calls render as collapsed one-line summaries in Static (tool name + status icon)"
    - "Tool call summaries inside Static are stateless (no useState or useInput)"
  artifacts:
    - path: "packages/cli/src/lib/truncate.ts"
      provides: "Output truncation utility"
      exports: ["truncateOutput"]
    - path: "packages/cli/src/components/MessageBubble.tsx"
      provides: "Message rendering with timestamps and truncated tool output"
      contains: "formatTimestamp"
    - path: "packages/cli/src/components/ToolPanel.tsx"
      provides: "Collapsible tool panel for live render region"
      exports: ["ToolPanel"]
    - path: "packages/cli/src/components/MessageList.tsx"
      provides: "Static message list rendering collapsed tool summaries"
  key_links:
    - from: "packages/cli/src/components/MessageBubble.tsx"
      to: "packages/cli/src/lib/truncate.ts"
      via: "import truncateOutput"
      pattern: "import.*truncateOutput.*from.*truncate"
    - from: "packages/cli/src/components/MessageList.tsx"
      to: "packages/cli/src/components/MessageBubble.tsx"
      via: "renders MessageBubble inside Static"
      pattern: "MessageBubble"
---

<objective>
Add timestamps to messages, truncate long tool output, and create collapsible tool panels with collapsed summaries in Static and interactive expand/collapse in the live render region.

Purpose: Messages lack timestamps and tool output can flood the terminal. Collapsed tool panels give a clean Claude Code-style experience where tool calls show a one-line summary by default.

Output: `lib/truncate.ts` utility, enhanced `MessageBubble.tsx` with timestamps and truncation, new `ToolPanel.tsx` component, updated `MessageList.tsx`.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-cli-visual-overhaul/26-RESEARCH.md
@packages/cli/src/components/MessageBubble.tsx
@packages/cli/src/components/MessageList.tsx
@packages/cli/src/lib/gateway-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create truncation utility and enhance MessageBubble with timestamps and truncation</name>
  <files>
    packages/cli/src/lib/truncate.ts
    packages/cli/src/components/MessageBubble.tsx
  </files>
  <action>
1. Create `packages/cli/src/lib/truncate.ts`:
   - Export `truncateOutput(output: string, maxLines = 20): string`
   - Split output by `\n`, if `lines.length <= maxLines` return as-is
   - Otherwise: return first `maxLines` lines joined with `\n`, then append `\n... (${remaining} more lines)` where remaining = `lines.length - maxLines`

2. Update `packages/cli/src/components/MessageBubble.tsx`:

   a. Add `formatTimestamp` helper function:
      - Takes ISO string, returns `HH:MM` format
      - `const d = new Date(iso)` then zero-pad hours and minutes

   b. Add timestamps to ALL message types:
      - For each message case, wrap the header line in `<Box justifyContent="space-between" width="100%">`
      - Left side: existing header content (role indicator, tool name, etc.)
      - Right side: `<Text dimColor>{formatTimestamp(message.timestamp)}</Text>`
      - The outer `<Box>` of each message case needs `width="100%"` or use `<Box flexGrow={1}>` for the parent

   c. Add truncation to tool_call and bash_command output:
      - Import `truncateOutput` from `../lib/truncate.js`
      - For `tool_call` case: if `message.output` exists, display `truncateOutput(message.output, 20)` instead of raw `message.output`
      - For `bash_command` case: if `message.output` exists, display `truncateOutput(message.output, 20)` instead of raw `message.output`
      - The truncation indicator "... (N more lines)" should be rendered with `dimColor`

   d. Keep MessageBubble STATELESS — no `useState` or `useInput` (it renders inside `<Static>`)
  </action>
  <verify>
    - `packages/cli/src/lib/truncate.ts` exists and exports `truncateOutput`
    - `grep "formatTimestamp" packages/cli/src/components/MessageBubble.tsx` returns matches
    - `grep "truncateOutput" packages/cli/src/components/MessageBubble.tsx` returns matches
    - `grep -c "useState" packages/cli/src/components/MessageBubble.tsx` returns 0 (stateless)
    - `pnpm --filter @tek/cli build` succeeds
  </verify>
  <done>
    - truncateOutput utility created with configurable maxLines
    - All message types display dimmed HH:MM timestamps right-aligned
    - Tool call and bash command output truncated at 20 lines with indicator
    - MessageBubble remains stateless (safe for Static rendering)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ToolPanel component and update MessageList for collapsed tool summaries</name>
  <files>
    packages/cli/src/components/ToolPanel.tsx
    packages/cli/src/components/MessageList.tsx
  </files>
  <action>
1. Create `packages/cli/src/components/ToolPanel.tsx`:
   - Interactive collapsible component for the LIVE render region (outside Static)
   - Props: `{ toolName: string, status: 'pending' | 'complete' | 'error', input: string, output?: string, isFocused?: boolean }`
   - Use `useState(false)` for `expanded` state
   - Use `useInput` to toggle expanded on Enter key when `isFocused` is true
   - Collapsed view: single line with `▶ toolName ✓/✗/⋯` (status icon colored green/red/yellow)
   - Expanded view: collapsed header changes `▶` to `▼`, shows `input` dimmed and `output` (truncated via `truncateOutput`) below with 2-space left margin
   - Import `truncateOutput` from `../lib/truncate.js`

2. Update `packages/cli/src/components/MessageList.tsx`:
   - The Static list continues to render ALL messages including tool_call and bash_command types
   - MessageBubble already handles tool_call rendering with the new truncation (from Task 1)
   - No changes needed to how tool_call messages render in Static — they show as collapsed one-line summaries via the MessageBubble component (which shows tool name + truncated output)
   - The ToolPanel component will be wired into Chat.tsx's live region in Plan 04

   Note: The key architectural insight from research is that historical tool calls in Static are always "collapsed" (one-line summary via MessageBubble), while the ACTIVE tool call during streaming can use ToolPanel in the live region for expand/collapse interactivity. Plan 04 wires ToolPanel into Chat.tsx.
  </action>
  <verify>
    - `packages/cli/src/components/ToolPanel.tsx` exists and exports `ToolPanel`
    - `grep "useState" packages/cli/src/components/ToolPanel.tsx` returns matches (ToolPanel is for live region, state is fine)
    - `grep -c "useState" packages/cli/src/components/MessageList.tsx` returns 0 (MessageList stays stateless)
    - `pnpm --filter @tek/cli build` succeeds
  </verify>
  <done>
    - ToolPanel component created with expand/collapse via Enter key
    - ToolPanel uses truncateOutput for long tool output
    - MessageList unchanged — tool calls render via MessageBubble (stateless, truncated)
    - ToolPanel ready for Chat.tsx wiring in Plan 04
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @tek/cli build` completes without errors
- All message types in MessageBubble have timestamp rendering
- Tool output truncation works (grep for truncateOutput in MessageBubble)
- ToolPanel.tsx exists as a separate interactive component
- No stateful hooks (useState/useInput) inside components rendered within Static
</verification>

<success_criteria>
Messages display dimmed HH:MM timestamps. Tool output longer than 20 lines shows a truncation indicator. ToolPanel component provides interactive expand/collapse for the live render region. MessageBubble remains stateless for safe Static rendering.
</success_criteria>

<output>
After completion, create `.planning/phases/26-cli-visual-overhaul/26-03-SUMMARY.md`
</output>
