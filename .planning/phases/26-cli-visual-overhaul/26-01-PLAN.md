---
phase: 26-cli-visual-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/package.json
  - packages/cli/src/lib/shiki.ts
  - packages/cli/src/lib/markdown.ts
autonomous: true
requirements:
  - CLIV-01

must_haves:
  truths:
    - "Code blocks in assistant messages display syntax-highlighted output with language-appropriate coloring"
    - "Highlighting is synchronous — no [object Promise] or broken rendering in terminal"
    - "Unknown languages fall back to plain text without errors"
  artifacts:
    - path: "packages/cli/src/lib/shiki.ts"
      provides: "Synchronous shiki highlighter singleton and codeToAnsiSync function"
      exports: ["codeToAnsiSync"]
    - path: "packages/cli/src/lib/markdown.ts"
      provides: "Markdown renderer using shiki for code block highlighting"
      contains: "codeToAnsiSync"
  key_links:
    - from: "packages/cli/src/lib/markdown.ts"
      to: "packages/cli/src/lib/shiki.ts"
      via: "import codeToAnsiSync"
      pattern: "import.*codeToAnsiSync.*from.*shiki"
    - from: "packages/cli/src/lib/shiki.ts"
      to: "shiki/core"
      via: "createHighlighterCoreSync"
      pattern: "createHighlighterCoreSync"
---

<objective>
Integrate shiki syntax highlighting into the CLI markdown pipeline, replacing cli-highlight with VS Code-quality TextMate grammar highlighting.

Purpose: Code blocks in assistant responses currently have no syntax highlighting (cli-highlight is installed but the marked-terminal config doesn't use a custom highlight function). Shiki provides VS Code-quality highlighting with TextMate grammars.

Output: `lib/shiki.ts` singleton, updated `lib/markdown.ts`, cli-highlight removed from dependencies.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-cli-visual-overhaul/26-RESEARCH.md
@packages/cli/src/lib/markdown.ts
@packages/cli/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shiki sync highlighter and integrate into markdown pipeline</name>
  <files>
    packages/cli/package.json
    packages/cli/src/lib/shiki.ts
    packages/cli/src/lib/markdown.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   pnpm --filter @tek/cli add shiki@^3.22.0 ansis@^4.0.0
   pnpm --filter @tek/cli remove cli-highlight
   ```

2. Create `packages/cli/src/lib/shiki.ts`:
   - Import `createHighlighterCoreSync` from `shiki/core`
   - Import `createJavaScriptRegexEngine` from `shiki/engine/javascript`
   - Import `FontStyle` from `@shikijs/vscode-textmate`
   - Import `c` from `ansis`
   - Import individual language grammars as plain objects for sync init: typescript, javascript, json, bash, python, css, html, yaml, markdown, tsx, jsx (from `shiki/langs/xxx`)
   - Import `github-dark` theme from `shiki/themes/github-dark`
   - Create `highlighter` singleton using `createHighlighterCoreSync({ themes: [githubDark], langs: [...], engine: createJavaScriptRegexEngine() })`
   - Export `codeToAnsiSync(code: string, lang: string): string` function:
     - Get loaded languages via `highlighter.getLoadedLanguages()`
     - Fall back to `'text'` for unknown languages
     - Call `highlighter.codeToTokensBase(code, { lang: effectiveLang, theme: 'github-dark' })`
     - Get theme via `highlighter.getTheme('github-dark')`
     - Iterate tokens: apply `c.hex(color)` for color, `c.bold`/`c.italic`/`c.underline` for font styles using `FontStyle` bitflags
     - Join lines with newlines, trim trailing newline
     - Wrap in try/catch — on error, return the raw code string (graceful fallback)

3. Update `packages/cli/src/lib/markdown.ts`:
   - Add import: `import { codeToAnsiSync } from './shiki.js'`
   - Change `markedTerminal(...)` call to pass highlight option as second argument:
     ```typescript
     marked.use(
       markedTerminal(
         { width: process.stdout.columns || 80, tab: 2, reflowText: true },
         { highlight: (code: string, lang: string) => codeToAnsiSync(code, lang) },
       ),
     )
     ```
   - Remove any cli-highlight imports if present

4. Verify the build compiles: `pnpm --filter @tek/cli build`
  </action>
  <verify>
    - `pnpm --filter @tek/cli build` succeeds with no errors
    - `grep -r "cli-highlight" packages/cli/` returns no results
    - `packages/cli/src/lib/shiki.ts` exists and exports `codeToAnsiSync`
    - `packages/cli/src/lib/markdown.ts` imports from `./shiki.js` and passes highlight option
  </verify>
  <done>
    - shiki sync highlighter singleton created with 11 common languages
    - markdown pipeline uses shiki for code block highlighting
    - cli-highlight fully removed from dependencies and imports
    - Build passes cleanly
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @tek/cli build` completes without errors
- `grep "cli-highlight" packages/cli/package.json` returns empty (removed)
- `grep "codeToAnsiSync" packages/cli/src/lib/markdown.ts` returns the highlight integration line
</verification>

<success_criteria>
Code blocks in CLI assistant messages render with syntax-highlighted ANSI colors via shiki's synchronous TextMate grammar engine. The highlighting is fully synchronous within the marked-terminal pipeline. Unknown languages gracefully fall back to plain text.
</success_criteria>

<output>
After completion, create `.planning/phases/26-cli-visual-overhaul/26-01-SUMMARY.md`
</output>
