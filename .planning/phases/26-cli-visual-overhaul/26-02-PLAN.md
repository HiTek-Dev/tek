---
phase: 26-cli-visual-overhaul
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/hooks/useInputHistory.ts
  - packages/cli/src/components/InputBar.tsx
autonomous: true
requirements:
  - CLIV-03
  - CLIV-07

must_haves:
  truths:
    - "User can press up/down arrow to cycle through previous messages when input is empty"
    - "User can press Shift+Enter to insert a newline without submitting"
    - "User can press Enter to submit the message"
    - "Backspace deletes from end of buffer"
    - "Input is disabled during streaming"
  artifacts:
    - path: "packages/cli/src/hooks/useInputHistory.ts"
      provides: "Input history cycling hook with back/forward navigation"
      exports: ["useInputHistory"]
    - path: "packages/cli/src/components/InputBar.tsx"
      provides: "Custom multiline input with history support"
      exports: ["InputBar"]
  key_links:
    - from: "packages/cli/src/components/InputBar.tsx"
      to: "packages/cli/src/hooks/useInputHistory.ts"
      via: "useInputHistory hook"
      pattern: "useInputHistory"
    - from: "packages/cli/src/components/InputBar.tsx"
      to: "ink"
      via: "useInput hook for key detection"
      pattern: "useInput"
---

<objective>
Replace the single-line TextInput with a custom multiline input component supporting Shift+Enter for newlines, Enter to submit, and up/down arrow message history cycling.

Purpose: The current `@inkjs/ui` TextInput is single-line only with no multiline or history support. A custom input using Ink's `useInput` hook provides the Claude Code-style input experience.

Output: `useInputHistory` hook, rewritten `InputBar.tsx` with custom input handling.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-cli-visual-overhaul/26-RESEARCH.md
@packages/cli/src/components/InputBar.tsx
@packages/cli/src/components/Chat.tsx
@packages/cli/src/hooks/useChat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useInputHistory hook</name>
  <files>packages/cli/src/hooks/useInputHistory.ts</files>
  <action>
Create `packages/cli/src/hooks/useInputHistory.ts`:

- Maintain an array of sent messages (`history: string[]`) and a cursor index (`index: number`)
- Export `useInputHistory()` returning `{ push, back, forward, current }`:
  - `push(text: string)`: Append to history array, reset cursor to end (past last item)
  - `back(): string | undefined`: Move cursor backward (toward older messages). If at start, return undefined. Return the message at the new cursor position.
  - `forward(): string | undefined`: Move cursor forward (toward newer messages). If past the end, return undefined (signals "back to empty input"). Return the message at the new cursor position.
  - `current`: The message at the current cursor position, or undefined if cursor is past the end
- Use `useRef` for the history array and `useState` for the cursor index (cursor changes trigger re-render for the input display, but history array mutations don't need to)
- Cap history at 100 entries (drop oldest when exceeded)
  </action>
  <verify>
    - File exists at `packages/cli/src/hooks/useInputHistory.ts`
    - Exports `useInputHistory` function
    - Has `push`, `back`, `forward` methods in return type
  </verify>
  <done>
    - useInputHistory hook created with push/back/forward navigation
    - History capped at 100 entries
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite InputBar with custom multiline input and history</name>
  <files>packages/cli/src/components/InputBar.tsx</files>
  <action>
Rewrite `packages/cli/src/components/InputBar.tsx`:

1. Remove `@inkjs/ui` `TextInput` import
2. Import `useInput` from `ink`, `useState` from `react`, and `useInputHistory` from the new hook
3. Props remain the same: `{ onSubmit, isStreaming }`
4. Internal state: `text` (string buffer), managed via `useState`
5. Call `useInputHistory()` to get history methods
6. Use `useInput((input, key) => { ... }, { isActive: !isStreaming })`:

   Key handling logic:
   - `key.return && !key.shift` (Enter without Shift): Submit
     - Call `onSubmit(text.trim())` if text is non-empty
     - Push text to history via `history.push(text)`
     - Reset text to `''`
   - `key.return && key.shift` (Shift+Enter): Insert newline
     - Append `'\n'` to text
   - `key.upArrow` when `text === ''`: Cycle history backward
     - Call `history.back()`, if result exists set text to it
   - `key.downArrow` when `text === ''`: Cycle history forward
     - Call `history.forward()`, set text to result or `''`
   - `key.backspace` or `key.delete`: Remove last character
     - `setText(prev => prev.slice(0, -1))`
   - Regular character input (`input` is truthy, no ctrl/meta modifiers):
     - `setText(prev => prev + input)`

7. Render:
   - `<Box flexDirection="column">` wrapper
   - Prompt line: `<Text bold color="cyan">{"> "}</Text>`
   - If streaming: `<Text dimColor>streaming...</Text>`
   - Else: Display the text buffer. For multiline, split on `\n` and render each line. Show a blinking cursor indicator (use `<Text inverse> </Text>` at end of last line, or just `<Text>â–Œ</Text>`)
   - If text has multiple lines, show line count indicator dimmed

Note: This is an append-only input (no mid-text cursor movement). This covers 90%+ of chat input use cases per research. Left/right arrow cursor editing can be added later.
  </action>
  <verify>
    - `pnpm --filter @tek/cli build` succeeds
    - `grep -c "TextInput" packages/cli/src/components/InputBar.tsx` returns 0 (removed)
    - `grep "useInput" packages/cli/src/components/InputBar.tsx` confirms Ink useInput hook usage
    - `grep "useInputHistory" packages/cli/src/components/InputBar.tsx` confirms history integration
  </verify>
  <done>
    - InputBar uses custom multiline input via Ink useInput (not @inkjs/ui TextInput)
    - Shift+Enter inserts newline, Enter submits
    - Up/down arrow cycles history when input is empty
    - Backspace deletes from end
    - Input disabled during streaming
    - Build passes
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @tek/cli build` completes without errors
- `grep "useInputHistory" packages/cli/src/components/InputBar.tsx` returns a match
- `grep "useInput" packages/cli/src/components/InputBar.tsx` returns a match (Ink's useInput)
- No references to `@inkjs/ui` `TextInput` in InputBar.tsx
</verification>

<success_criteria>
User can type multiline messages using Shift+Enter for newlines and Enter to submit. Up/down arrow keys cycle through previously sent messages when the input buffer is empty. The custom input replaces the single-line @inkjs/ui TextInput entirely.
</success_criteria>

<output>
After completion, create `.planning/phases/26-cli-visual-overhaul/26-02-SUMMARY.md`
</output>
