---
phase: 33-todo-system-display-in-cli-and-desktop
plan: 03
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - apps/desktop/src/lib/gateway-client.ts
  - apps/desktop/src/hooks/useChat.ts
  - apps/desktop/src/components/TodoPanel.tsx
  - apps/desktop/src/views/ChatView.tsx
autonomous: true
requirements:
  - TODO-06
  - TODO-07

must_haves:
  truths:
    - "Desktop shows a compact todo panel with animated spinner for in-progress, green checkmark for completed, muted circle for pending tasks"
    - "Todo panel appears above the chat input in the main chat area"
    - "Todo state clears when a new streaming response starts"
    - "Progress count shows completed/total in the panel header"
  artifacts:
    - path: "apps/desktop/src/components/TodoPanel.tsx"
      provides: "React/Tailwind todo panel component with Lucide icons"
      exports: ["TodoPanel"]
      min_lines: 25
    - path: "apps/desktop/src/lib/gateway-client.ts"
      provides: "TodoUpdate server message type in ServerMessage union"
      contains: "todo.update"
    - path: "apps/desktop/src/hooks/useChat.ts"
      provides: "todo.update message handler and todos state"
      contains: "todo.update"
  key_links:
    - from: "apps/desktop/src/hooks/useChat.ts"
      to: "apps/desktop/src/views/ChatView.tsx"
      via: "todos state from useChat destructured and passed to TodoPanel"
      pattern: "todos"
    - from: "apps/desktop/src/components/TodoPanel.tsx"
      to: "lucide-react"
      via: "CheckCircle2, Circle, Loader2 icon imports"
      pattern: "CheckCircle2|Loader2|Circle"
---

<objective>
Add todo display to the desktop chat interface: extend gateway-client types with TodoUpdate, handle `todo.update` messages in useChat, create a TodoPanel React component, and integrate it into ChatView.

Purpose: Users see real-time task progress in the desktop app as the agent works through multi-step tasks, with animated spinners for active tasks and green checkmarks for completed ones.

Output: New TodoPanel.tsx component, updated gateway-client.ts, useChat.ts, and ChatView.tsx.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-todo-system-display-in-cli-and-desktop/33-RESEARCH.md
@.planning/phases/33-todo-system-display-in-cli-and-desktop/33-01-SUMMARY.md

@apps/desktop/src/lib/gateway-client.ts
@apps/desktop/src/hooks/useChat.ts
@apps/desktop/src/components/TodoPanel.tsx
@apps/desktop/src/views/ChatView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend desktop types, handle todo.update in useChat, and create TodoPanel</name>
  <files>
    apps/desktop/src/lib/gateway-client.ts
    apps/desktop/src/hooks/useChat.ts
    apps/desktop/src/components/TodoPanel.tsx
  </files>
  <action>
1. Update `apps/desktop/src/lib/gateway-client.ts`:
   - Add a `TodoUpdate` interface (after ErrorMessage, before the ServerMessage union):
     ```typescript
     export interface TodoUpdate {
       type: 'todo.update';
       requestId: string;
       todos: Array<{
         id: string;
         content: string;
         status: 'pending' | 'in_progress' | 'completed';
         activeForm?: string;
       }>;
     }
     ```
   - Add `TodoUpdate` to the `ServerMessage` union type:
     ```typescript
     export type ServerMessage =
       | ChatStreamStart
       | ChatStreamDelta
       | ChatStreamEnd
       | ChatStreamReasoning
       | ChatStreamSource
       | SessionCreated
       | SessionListResponse
       | ToolCallNotify
       | ToolResultNotify
       | ToolErrorNotify
       | ToolApprovalRequest
       | ErrorMessage
       | TodoUpdate;
     ```

2. Update `apps/desktop/src/hooks/useChat.ts`:
   - Add a `TodoItem` interface (or inline type) near the top:
     ```typescript
     interface TodoItem {
       id: string;
       content: string;
       status: 'pending' | 'in_progress' | 'completed';
       activeForm?: string;
     }
     ```
   - Add `todos` state: `const [todos, setTodos] = useState<TodoItem[]>([]);`
   - Add `todos` to the `UseChatReturn` interface
   - In the `handleMessage` switch, add case for `'todo.update'`:
     ```typescript
     case 'todo.update': {
       setTodos(msg.todos);
       break;
     }
     ```
   - In the `'chat.stream.start'` case, add `setTodos([]);` to clear stale todos when a new stream begins (alongside existing `setStreamingText('')` and `setStreamingReasoning('')` resets).
   - In the `'error'` case, add `setTodos([]);` to clear todos on error.
   - Do NOT clear todos in `chat.stream.end` -- keep them visible until the next request starts.
   - Add `todos` to the `clearMessages` callback: `setTodos([]);`
   - Add `todos` to the return object.

3. Create `apps/desktop/src/components/TodoPanel.tsx`:
   - Import `CheckCircle2`, `Circle`, `Loader2` from "lucide-react"
   - Define the component props interface inline:
     ```typescript
     interface TodoItem {
       id: string;
       content: string;
       status: 'pending' | 'in_progress' | 'completed';
       activeForm?: string;
     }
     ```
   - Export `TodoPanel({ todos }: { todos: TodoItem[] })` component
   - If `todos.length === 0`, return null
   - Calculate `completed = todos.filter(t => t.status === 'completed').length`
   - Render using Tailwind classes:
     ```tsx
     <div className="shrink-0 border-t px-4 py-2 space-y-1">
       <div className="text-xs text-muted-foreground">
         Tasks ({completed}/{todos.length})
       </div>
       {todos.map((todo) => (
         <div key={todo.id} className="flex items-center gap-2 text-sm">
           {todo.status === 'completed' && (
             <CheckCircle2 className="size-3.5 text-green-500 shrink-0" />
           )}
           {todo.status === 'in_progress' && (
             <Loader2 className="size-3.5 text-blue-500 animate-spin shrink-0" />
           )}
           {todo.status === 'pending' && (
             <Circle className="size-3.5 text-muted-foreground shrink-0" />
           )}
           <span className={todo.status === 'completed' ? 'line-through text-muted-foreground' : ''}>
             {todo.status === 'in_progress' ? (todo.activeForm || todo.content) : todo.content}
           </span>
         </div>
       ))}
     </div>
     ```
   - The `shrink-0` on the outer div prevents the panel from being compressed by the flex layout. The `border-t` provides visual separation from the message list above.
  </action>
  <verify>
    Run `npx tsc --noEmit -p apps/desktop/tsconfig.app.json` (or the desktop tsconfig) to verify types compile.
    Grep gateway-client.ts for "todo.update" to confirm type exists.
    Grep useChat.ts for "todo.update" and "setTodos" to confirm handler.
    Verify TodoPanel.tsx exists and exports TodoPanel.
  </verify>
  <done>
    gateway-client.ts has TodoUpdate type in ServerMessage union.
    useChat hook handles todo.update messages and clears todos on stream start.
    TodoPanel component renders task list with Lucide icons and Tailwind styling.
    todos state exposed from useChat return value.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TodoPanel into desktop ChatView layout</name>
  <files>
    apps/desktop/src/views/ChatView.tsx
  </files>
  <action>
1. Update `apps/desktop/src/views/ChatView.tsx`:
   - Import `TodoPanel` from `"@/components/TodoPanel"`
   - Destructure `todos` from the `useChat()` return value (alongside existing `messages`, `streamingText`, etc.)
   - Add the TodoPanel between the usage/cost footer and the ChatInput. Specifically, in the main chat area's flex column, insert after the usage/cost footer block:
     ```tsx
     {/* Todo progress panel */}
     <TodoPanel todos={todos} />
     ```
     This positions it above the ChatInput and below the usage footer. If no todos are active, TodoPanel returns null and takes no space.
   - The TodoPanel has `shrink-0` so it won't be compressed by the flex layout, and `border-t` for visual separation. This matches the usage footer pattern.
  </action>
  <verify>
    Run `npx tsc --noEmit -p apps/desktop/tsconfig.app.json` to verify types compile.
    Grep ChatView.tsx for "TodoPanel" to confirm import and usage.
    Verify the TodoPanel is positioned between the usage footer and ChatInput in the JSX.
  </verify>
  <done>
    TodoPanel integrated into ChatView layout between usage footer and chat input.
    Desktop app compiles without errors.
    Empty todos render nothing (no layout disruption).
  </done>
</task>

</tasks>

<verification>
1. Desktop TypeScript compiles without errors
2. TodoPanel.tsx exists and exports TodoPanel component with Lucide icons
3. gateway-client.ts includes TodoUpdate in ServerMessage union
4. useChat.ts handles todo.update and exposes todos state
5. ChatView.tsx renders TodoPanel between usage footer and ChatInput
6. Todos clear on chat.stream.start (verified by grep for setTodos in stream.start case)
</verification>

<success_criteria>
- Desktop compiles without errors
- TodoPanel component created with Loader2 spinner, CheckCircle2, Circle icons
- useChat handles todo.update and clears on stream start
- TodoPanel positioned correctly in ChatView layout
- Empty todos render nothing (no layout disruption)
- animate-spin class on Loader2 for smooth in-progress animation
</success_criteria>

<output>
After completion, create `.planning/phases/33-todo-system-display-in-cli-and-desktop/33-03-SUMMARY.md`
</output>
