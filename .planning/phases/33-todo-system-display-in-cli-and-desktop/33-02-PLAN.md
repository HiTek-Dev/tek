---
phase: 33-todo-system-display-in-cli-and-desktop
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - packages/cli/src/hooks/useChat.ts
  - packages/cli/src/components/TodoPanel.tsx
  - packages/cli/src/components/Chat.tsx
autonomous: true
requirements:
  - TODO-05
  - TODO-07

must_haves:
  truths:
    - "CLI shows a compact todo panel with spinner for in-progress, checkmark for completed, circle for pending tasks"
    - "Todo panel appears between streaming response and input bar when todos are active"
    - "Todo state clears when a new streaming response starts"
    - "Progress count shows completed/total in the panel header"
  artifacts:
    - path: "packages/cli/src/components/TodoPanel.tsx"
      provides: "Compact Ink todo list component"
      exports: ["TodoPanel"]
      min_lines: 25
    - path: "packages/cli/src/hooks/useChat.ts"
      provides: "todo.update message handler and todos state"
      contains: "todo.update"
  key_links:
    - from: "packages/cli/src/hooks/useChat.ts"
      to: "packages/cli/src/components/Chat.tsx"
      via: "todos state prop passed to TodoPanel"
      pattern: "todos"
    - from: "packages/cli/src/components/TodoPanel.tsx"
      to: "@inkjs/ui"
      via: "Spinner component import"
      pattern: "Spinner"
---

<objective>
Add todo display to the CLI chat interface: handle `todo.update` messages in the useChat hook, create a TodoPanel Ink component, and integrate it into the Chat layout.

Purpose: Users see real-time task progress in the CLI as the agent works through multi-step tasks, with spinners for active tasks and checkmarks for completed ones.

Output: New TodoPanel.tsx component, updated useChat.ts and Chat.tsx.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-todo-system-display-in-cli-and-desktop/33-RESEARCH.md
@.planning/phases/33-todo-system-display-in-cli-and-desktop/33-01-SUMMARY.md

@packages/cli/src/hooks/useChat.ts
@packages/cli/src/components/Chat.tsx
@packages/cli/src/lib/gateway-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Handle todo.update in CLI useChat and create TodoPanel component</name>
  <files>
    packages/cli/src/hooks/useChat.ts
    packages/cli/src/components/TodoPanel.tsx
  </files>
  <action>
1. Update `packages/cli/src/hooks/useChat.ts`:
   - Add a TodoItem interface at the top (after PendingPreflight):
     ```typescript
     export interface TodoItem {
       id: string;
       content: string;
       status: "pending" | "in_progress" | "completed";
       activeForm?: string;
     }
     ```
   - Add `todos` state: `const [todos, setTodos] = useState<TodoItem[]>([]);`
   - In `handleServerMessage` switch, add case for `todo.update`:
     ```typescript
     case "todo.update": {
       setTodos((msg as any).todos);
       break;
     }
     ```
     Note: Cast to `any` because the CLI imports `ServerMessage` from `@tek/gateway` which will now include `TodoUpdate` after Plan 01. If the type import already covers it, use direct access: `msg.todos`.
   - In the `chat.stream.start` case, add `setTodos([]);` to clear stale todos when a new stream begins (alongside the existing `setStreamingText("")` and `setStreamingReasoning("")` resets).
   - In the `chat.stream.end` case, do NOT clear todos -- keep them visible until the next request starts (per research recommendation).
   - In the `error` case, add `setTodos([]);` to clear todos on error.
   - Add `todos` to the return object of `useChat()`.

2. Create `packages/cli/src/components/TodoPanel.tsx`:
   - Import React, Box, Text from "ink", and Spinner from "@inkjs/ui"
   - Import `type TodoItem` from "../hooks/useChat.js"
   - Export `TodoPanel` component accepting `{ todos: TodoItem[] }` props
   - If `todos.length === 0`, return null
   - Calculate `completed = todos.filter(t => t.status === "completed").length`
   - Render:
     ```
     <Box flexDirection="column" marginTop={1}>
       <Text dimColor>Tasks ({completed}/{todos.length})</Text>
       {todos.map((todo) => (
         <Box key={todo.id} gap={1}>
           {todo.status === "completed" && <Text color="green">+</Text>}
           {todo.status === "in_progress" && <Spinner label="" />}
           {todo.status === "pending" && <Text dimColor>o</Text>}
           <Text dimColor={todo.status === "completed"} strikethrough={todo.status === "completed"}>
             {todo.status === "in_progress" ? (todo.activeForm || todo.content) : todo.content}
           </Text>
         </Box>
       ))}
     </Box>
     ```
   - Use the `Spinner` from `@inkjs/ui` (already in deps, used in StreamingResponse). The spinner renders inline with no label -- the text is rendered separately for proper styling control.
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/cli/tsconfig.json` to verify types compile.
    Grep useChat.ts for "todo.update" to confirm handler exists.
    Grep useChat.ts for "setTodos" to confirm state management.
    Verify TodoPanel.tsx exists and exports TodoPanel.
  </verify>
  <done>
    useChat hook handles todo.update messages and clears todos on stream start.
    TodoPanel component renders task list with correct status indicators.
    todos state exposed from useChat return value.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TodoPanel into CLI Chat layout</name>
  <files>
    packages/cli/src/components/Chat.tsx
  </files>
  <action>
1. Update `packages/cli/src/components/Chat.tsx`:
   - Import `TodoPanel` from `"./TodoPanel.js"`
   - Destructure `todos` from the `useChat()` return value (alongside existing `messages`, `streamingText`, etc.)
   - Add the TodoPanel between the StreamingResponse section and the ToolPanel/InputBar section. Specifically, after the streaming block:
     ```tsx
     {isStreaming && (
       <StreamingResponse text={streamingText} reasoningText={streamingReasoning} model={model} />
     )}
     ```
     Add:
     ```tsx
     <TodoPanel todos={todos} />
     ```
   - The TodoPanel renders nothing when todos is empty, so it's safe to always include it. Place it AFTER StreamingResponse and BEFORE the ToolPanel conditional. This positions it between the streaming output and the input area.
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/cli/tsconfig.json` to verify types compile.
    Grep Chat.tsx for "TodoPanel" to confirm import and usage.
    Verify the TodoPanel is positioned after StreamingResponse in the JSX.
  </verify>
  <done>
    TodoPanel integrated into Chat layout between streaming response and tool panel / input bar.
    CLI compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/cli/tsconfig.json` passes
2. TodoPanel.tsx exists and exports TodoPanel component
3. useChat.ts handles todo.update messages and exposes todos state
4. Chat.tsx renders TodoPanel between StreamingResponse and ToolPanel
5. Todos clear on chat.stream.start (verified by grep for setTodos in stream.start case)
</verification>

<success_criteria>
- CLI compiles without errors
- TodoPanel component created with spinner/checkmark/circle indicators
- useChat handles todo.update and clears on stream start
- TodoPanel positioned correctly in Chat layout
- Empty todos render nothing (no layout disruption)
</success_criteria>

<output>
After completion, create `.planning/phases/33-todo-system-display-in-cli-and-desktop/33-02-SUMMARY.md`
</output>
