---
phase: 33-todo-system-display-in-cli-and-desktop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/tools/todo.ts
  - packages/gateway/src/tools/index.ts
  - packages/gateway/src/ws/protocol.ts
  - packages/gateway/src/ws/connection.ts
  - packages/gateway/src/agent/tool-registry.ts
  - packages/gateway/src/ws/handlers.ts
  - packages/gateway/src/context/assembler.ts
autonomous: true
requirements:
  - TODO-01
  - TODO-02
  - TODO-03
  - TODO-04
  - TODO-07

must_haves:
  truths:
    - "Gateway exposes a todo_write tool that agents can call to track task progress"
    - "When todo_write is called, a todo.update WS message is sent to the connected client"
    - "Todo tool is auto-approved (no approval gate) and registered alongside existing tools"
    - "System prompt instructs agents to use todo_write for complex multi-step tasks"
    - "Todo state stored in ConnectionState is cleared on each new chat.stream.start"
  artifacts:
    - path: "packages/gateway/src/tools/todo.ts"
      provides: "createTodoWriteTool factory function"
      exports: ["createTodoWriteTool", "TodoItem"]
    - path: "packages/gateway/src/ws/protocol.ts"
      provides: "TodoUpdate server message schema"
      contains: "todo.update"
    - path: "packages/gateway/src/ws/connection.ts"
      provides: "activeTodos field on ConnectionState"
      contains: "activeTodos"
  key_links:
    - from: "packages/gateway/src/tools/todo.ts"
      to: "packages/gateway/src/ws/handlers.ts"
      via: "onUpdate callback wired in handleChatSend"
      pattern: "createTodoWriteTool"
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "transport.send"
      via: "todo.update message relay"
      pattern: "todo\\.update"
    - from: "packages/gateway/src/agent/tool-registry.ts"
      to: "packages/gateway/src/tools/todo.ts"
      via: "import and register in buildToolRegistry"
      pattern: "todo_write"
---

<objective>
Create the gateway-side todo tracking system: tool definition, WS protocol extension, connection state, tool registry wiring, handler relay, and system prompt instruction.

Purpose: Enables agents to call `todo_write` during execution, with state changes relayed to connected clients via `todo.update` WS messages. This is the foundation that CLI and Desktop plans build on.

Output: New `todo.ts` tool file, updated protocol/connection/registry/handlers/assembler files.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-todo-system-display-in-cli-and-desktop/33-RESEARCH.md

@packages/gateway/src/tools/todo.ts
@packages/gateway/src/tools/index.ts
@packages/gateway/src/ws/protocol.ts
@packages/gateway/src/ws/connection.ts
@packages/gateway/src/agent/tool-registry.ts
@packages/gateway/src/ws/handlers.ts
@packages/gateway/src/context/assembler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create todo_write tool and extend WS protocol</name>
  <files>
    packages/gateway/src/tools/todo.ts
    packages/gateway/src/tools/index.ts
    packages/gateway/src/ws/protocol.ts
    packages/gateway/src/ws/connection.ts
  </files>
  <action>
1. Create `packages/gateway/src/tools/todo.ts`:
   - Import `tool` from "ai" and `z` from "zod"
   - Define `TodoItemSchema` with z.object: `id` (string), `content` (string), `status` (z.enum ["pending", "in_progress", "completed"]), `activeForm` (string, optional, describe as "Present-continuous text shown during in_progress, e.g. 'Fixing bug'")
   - Export `type TodoItem = z.infer<typeof TodoItemSchema>`
   - Export `createTodoWriteTool(onUpdate: (todos: TodoItem[]) => void)` that returns `tool({...})`:
     - description: "Create or update a todo list to track task progress. Replace the entire list each call. Use for multi-step tasks to show progress."
     - parameters: z.object({ todos: z.array(TodoItemSchema).describe("The complete todo list") })
     - execute: calls `onUpdate(todos)`, returns summary string like `"Updated todos: ${completed}/${total} complete"`

2. Update `packages/gateway/src/tools/index.ts`:
   - Add `export { createTodoWriteTool } from "./todo.js";`
   - Add `export type { TodoItem } from "./todo.js";`

3. Update `packages/gateway/src/ws/protocol.ts`:
   - Add `TodoUpdateSchema` as a new z.object with fields: `type: z.literal("todo.update")`, `requestId: z.string()`, `todos: z.array(z.object({ id: z.string(), content: z.string(), status: z.enum(["pending", "in_progress", "completed"]), activeForm: z.string().optional() }))`
   - Add `TodoUpdateSchema` to the `ServerMessageSchema` discriminated union array
   - Add `export type TodoUpdate = z.infer<typeof TodoUpdateSchema>;` to the type exports

4. Update `packages/gateway/src/ws/connection.ts`:
   - Import `type TodoItem` from `"../tools/todo.js"`
   - Add `activeTodos: TodoItem[];` field to `ConnectionState` interface
   - Initialize `activeTodos: []` in `initConnection()`
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` to verify all types compile.
    Grep protocol.ts for "todo.update" to confirm schema is in the union.
    Grep connection.ts for "activeTodos" to confirm field exists.
  </verify>
  <done>
    todo.ts exports createTodoWriteTool and TodoItem type.
    protocol.ts has TodoUpdate in ServerMessageSchema union.
    ConnectionState has activeTodos field initialized to empty array.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire todo tool into registry, handlers, and system prompt</name>
  <files>
    packages/gateway/src/agent/tool-registry.ts
    packages/gateway/src/ws/handlers.ts
    packages/gateway/src/context/assembler.ts
  </files>
  <action>
1. Update `packages/gateway/src/agent/tool-registry.ts`:
   - Add `ToolRegistryOptions` new optional field: `onTodoUpdate?: (todos: import("../tools/todo.js").TodoItem[]) => void`
   - Import `createTodoWriteTool` from `"../tools/todo.js"`
   - After the memory tools section (step 7), add step 8:
     ```
     // 8. Add todo tracking tool (always available, auto-approved)
     if (options.onTodoUpdate) {
       const todoWrite = createTodoWriteTool(options.onTodoUpdate);
       tools.todo_write = todoWrite;
       // Todo tracking is informational, no approval needed
       if (approvalPolicy) {
         approvalPolicy.perTool.todo_write = "auto";
       }
     }
     ```
   - Note: Do NOT wrap with wrapToolWithApproval -- the auto policy on perTool is sufficient and wrapping would add unnecessary overhead for an informational tool.

2. Update `packages/gateway/src/ws/handlers.ts`:
   - In the `handleChatSend` function, where `buildToolRegistry()` is called (around line 366), add `onTodoUpdate` to the options:
     ```
     onTodoUpdate: (todos) => {
       connState.activeTodos = todos;
       transport.send({
         type: "todo.update",
         requestId: msg.id,
         todos: todos.map(t => ({
           id: t.id,
           content: t.content,
           status: t.status,
           ...(t.activeForm ? { activeForm: t.activeForm } : {}),
         })),
       });
     },
     ```
   - In the `handleChatSend` function, right after `connState.streaming = true` and `connState.streamRequestId = msg.id` (around line 423-424), add:
     ```
     connState.activeTodos = [];  // Clear stale todos from previous request
     ```
   - Also in `handlePreflightApproval` function, in the section where it resumes after preflight approval and calls `runAgentLoop`, apply the same pattern: clear `connState.activeTodos = []` before streaming starts. Find where `transport.send({ type: "chat.stream.start" ...})` is called in that function and add the clear before it.

3. Update `packages/gateway/src/context/assembler.ts`:
   - In the `RESPONSE_FORMAT_PROMPT` array, before the closing `].join("\n")`, add a new line:
     `"- For complex multi-step tasks (3+ steps), use the todo_write tool to track your progress and update task status as you work"`
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` to verify all types compile.
    Grep tool-registry.ts for "todo_write" to confirm registration.
    Grep handlers.ts for "todo.update" to confirm relay wiring.
    Grep handlers.ts for "activeTodos = \[\]" to confirm clearing on stream start.
    Grep assembler.ts for "todo_write" to confirm system prompt instruction.
  </verify>
  <done>
    todo_write tool registered in buildToolRegistry with auto approval policy.
    handlers.ts relays todo updates to transport as todo.update messages.
    activeTodos cleared on each new chat.stream.start.
    System prompt instructs agent to use todo_write for complex tasks.
    All gateway TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/gateway/tsconfig.json` passes
2. `grep -r "todo.update" packages/gateway/src/` shows hits in protocol.ts and handlers.ts
3. `grep -r "todo_write" packages/gateway/src/` shows hits in todo.ts, tool-registry.ts, and assembler.ts
4. `grep -r "activeTodos" packages/gateway/src/` shows hits in connection.ts and handlers.ts
</verification>

<success_criteria>
- Gateway compiles without errors
- todo_write tool defined and exported
- Protocol has todo.update server message type
- Tool registered in registry with auto-approval
- Handler relays todo updates to transport
- Connection state tracks and clears activeTodos
- System prompt includes todo_write instruction
</success_criteria>

<output>
After completion, create `.planning/phases/33-todo-system-display-in-cli-and-desktop/33-01-SUMMARY.md`
</output>
