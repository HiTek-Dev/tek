---
phase: 19-desktop-integration-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/commands/init.ts
  - apps/desktop/src/lib/config.ts
  - apps/desktop/src/pages/SettingsPage.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "After running `tek init` with a user name and agent name, chat sessions use those names in responses"
    - "Desktop settings page renders without crashing regardless of config format"
    - "Model aliases display correctly whether stored as array or record format"
  artifacts:
    - path: "packages/cli/src/commands/init.ts"
      provides: "Writing userDisplayName to USER.md and agentName to SOUL.md during init onComplete"
      contains: "writeFileSync.*USER.md"
    - path: "apps/desktop/src/lib/config.ts"
      provides: "Config normalization for modelAliases (array to record conversion)"
      contains: "Array.isArray.*modelAliases"
    - path: "apps/desktop/src/pages/SettingsPage.tsx"
      provides: "Crash-proof settings rendering"
  key_links:
    - from: "packages/cli/src/commands/init.ts"
      to: "packages/db/memory-files/USER.md"
      via: "writeFileSync in onComplete"
      pattern: "writeFileSync.*USER\\.md"
    - from: "apps/desktop/src/lib/config.ts"
      to: "apps/desktop/src/pages/SettingsPage.tsx"
      via: "loadConfig returns normalized AppConfig"
      pattern: "loadConfig"
---

<objective>
Fix chat identity loading from init and settings page crash.

Purpose: Two critical bugs: (1) `tek init` saves agentName/userDisplayName to config.json but never writes to identity .md files that the memory system reads, so chat has no personality context; (2) SettingsPage crashes because it treats `modelAliases` as `Record<string, string>` but core stores it as `Array<{alias, modelId}>`.

Output: Init writes identity data to USER.md/SOUL.md; desktop config normalizes modelAliases format; settings page renders without crashes.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/cli/src/commands/init.ts
@apps/desktop/src/lib/config.ts
@apps/desktop/src/pages/SettingsPage.tsx
@packages/core/src/config/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write identity files during init onComplete</name>
  <files>packages/cli/src/commands/init.ts</files>
  <action>
In `packages/cli/src/commands/init.ts`, in the `onComplete` handler (around line 79), after the personality preset handling (lines 91-96) and before saving config (line 98), add code to write `userDisplayName` and `agentName` into their respective identity files.

Add these imports at the top of the file:
```typescript
import { writeFileSync, existsSync, readFileSync, mkdirSync } from "node:fs";
import { join } from "node:path";
import { CONFIG_DIR } from "@tek/core";
```

Note: `resolve` and `homedir` are already imported. Check if `CONFIG_DIR` is exported from `@tek/core` — if not, derive it: `const configDir = resolve(homedir(), ".config", "tek");`. Check if `join` from `node:path` is already imported (it's not — `resolve` is imported but `join` is not; you can use `resolve` instead).

After the personality preset handling block (line 96) and before `// Save config` (line 98), add:

```typescript
// Write identity data to memory files for the memory system to read
const memoryDir = resolve(homedir(), ".config", "tek", "memory");
if (!existsSync(memoryDir)) {
  mkdirSync(memoryDir, { recursive: true });
}

// Inject userDisplayName into USER.md
if (result.userDisplayName) {
  const userPath = resolve(memoryDir, "USER.md");
  const existing = existsSync(userPath) ? readFileSync(userPath, "utf-8") : "";
  if (!existing.includes(result.userDisplayName)) {
    const content = `# About the User\n\nName: ${result.userDisplayName}\n`;
    writeFileSync(userPath, content, "utf-8");
  }
}

// Inject agentName into SOUL.md header if not already present
if (result.agentName) {
  const soulPath = resolve(memoryDir, "SOUL.md");
  if (existsSync(soulPath)) {
    const existing = readFileSync(soulPath, "utf-8");
    if (!existing.includes(`name is ${result.agentName}`) && !existing.includes(`Name: ${result.agentName}`)) {
      // Prepend agent name context to SOUL.md
      const nameSection = `<!-- Agent Name: ${result.agentName} -->\n# ${result.agentName}\n\n`;
      const updated = existing.startsWith("#") ? nameSection + existing.replace(/^#[^\n]*\n/, "") : nameSection + existing;
      writeFileSync(soulPath, updated, "utf-8");
    }
  }
}
```

Important: `writeFileSync`, `existsSync`, `readFileSync`, `mkdirSync` need to be imported from `node:fs`. Check existing imports — `createInterface` is imported from `node:readline` but fs functions are NOT imported. Add the import.
  </action>
  <verify>Build the CLI package: `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/cli/tsconfig.json --noEmit` — should compile without errors.</verify>
  <done>Running `tek init` with a userDisplayName writes it to `~/.config/tek/memory/USER.md`. Running with an agentName injects the name into `~/.config/tek/memory/SOUL.md`.</done>
</task>

<task type="auto">
  <name>Task 2: Fix settings crash with config normalization</name>
  <files>apps/desktop/src/lib/config.ts, apps/desktop/src/pages/SettingsPage.tsx</files>
  <action>
**Part A — Config normalization in `apps/desktop/src/lib/config.ts`:**

In the `loadConfig()` function, after `const content = await readTextFile(configPath);` and before `return JSON.parse(content) as AppConfig;`, add normalization logic:

```typescript
const raw = JSON.parse(content);

// Normalize modelAliases: core stores as Array<{alias, modelId}>, desktop expects Record<string, string>
if (Array.isArray(raw.modelAliases)) {
  const record: Record<string, string> = {};
  for (const entry of raw.modelAliases) {
    if (entry && typeof entry === 'object' && entry.alias && entry.modelId) {
      record[entry.alias] = entry.modelId;
    }
  }
  raw.modelAliases = record;
}

return raw as AppConfig;
```

Replace the existing `return JSON.parse(content) as AppConfig;` with this block.

**Part B — Also normalize when saving back in `saveConfig()`:**

In `saveConfig()`, before writing, convert the `modelAliases` back to array format for core compatibility. After `const merged = { ...existing, ...config };`, add:

```typescript
// Normalize modelAliases back to array format for core schema compatibility
if (merged.modelAliases && !Array.isArray(merged.modelAliases)) {
  const record = merged.modelAliases as Record<string, string>;
  merged.modelAliases = Object.entries(record).map(([alias, modelId]) => ({ alias, modelId }));
}
```

**Part C — Add error boundary in `apps/desktop/src/pages/SettingsPage.tsx`:**

Wrap the aliases section in a try-catch-safe pattern. Change line 66 from:
```typescript
const aliases = config?.modelAliases ?? {};
```
to:
```typescript
const aliases: Record<string, string> = (config?.modelAliases && typeof config.modelAliases === 'object' && !Array.isArray(config.modelAliases))
  ? config.modelAliases
  : {};
```

This provides a safety net in case normalization is bypassed.
  </action>
  <verify>Build the desktop app: `cd /Users/hitekmedia/Documents/GitHub/tek/apps/desktop && npx tsc --noEmit` — should compile without errors. Verify that `loadConfig` normalizes array-format modelAliases to record format.</verify>
  <done>Settings page renders without crashes. Model aliases display correctly regardless of whether config stores them as array or record. Saving from desktop writes back in core-compatible array format.</done>
</task>

</tasks>

<verification>
1. Build CLI package without errors
2. Build desktop app without errors
3. Verify init.ts writes to USER.md and SOUL.md
4. Verify config.ts normalizes modelAliases in both directions
5. Verify SettingsPage has defensive aliases extraction
</verification>

<success_criteria>
- `tek init` with userDisplayName creates/updates `~/.config/tek/memory/USER.md` with the name
- `tek init` with agentName injects the name into `~/.config/tek/memory/SOUL.md`
- Desktop config normalizes `modelAliases` from array to record on load, and record to array on save
- SettingsPage renders without crash when `modelAliases` is in any format
- Both packages compile without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-desktop-integration-polish/19-02-SUMMARY.md`
</output>
