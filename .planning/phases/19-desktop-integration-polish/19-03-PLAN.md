---
phase: 19-desktop-integration-polish
plan: 03
type: execute
wave: 2
depends_on: ["19-01", "19-02"]
files_modified:
  - apps/desktop/src/pages/AgentsPage.tsx
  - apps/desktop/src/hooks/useIdentityFiles.ts
  - apps/desktop/src/lib/files.ts
  - packages/core/src/config/schema.ts
  - apps/desktop/src/lib/config.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Desktop agents page shows a list of configured agents"
    - "User can create a new agent with name, description, and access mode through a form"
    - "Creating an agent creates the agent directory and identity files at ~/.config/tek/agents/{id}/"
    - "Each agent has an isolated workspace directory with configurable access mode"
    - "Selecting an agent shows and allows editing its identity files"
  artifacts:
    - path: "apps/desktop/src/pages/AgentsPage.tsx"
      provides: "Agent list view + create agent form + per-agent identity editor"
      contains: "AgentsPage"
    - path: "packages/core/src/config/schema.ts"
      provides: "accessMode field on AgentDefinitionSchema"
      contains: "accessMode"
    - path: "apps/desktop/src/lib/config.ts"
      provides: "AgentDefinition type with accessMode for desktop"
      contains: "accessMode"
  key_links:
    - from: "apps/desktop/src/pages/AgentsPage.tsx"
      to: "apps/desktop/src/hooks/useIdentityFiles.ts"
      via: "useIdentityFiles hook with agentId parameter"
      pattern: "useIdentityFiles"
    - from: "apps/desktop/src/pages/AgentsPage.tsx"
      to: "apps/desktop/src/lib/config.ts"
      via: "loadConfig/saveConfig for agents list"
      pattern: "agents.*list"
---

<objective>
Redesign Agents page as agent list + create agent flow with workspace isolation.

Purpose: The current AgentsPage is just a file editor for global identity files. Users need to see configured agents, create new agents with their own identity files and access modes, and manage per-agent settings. The core schema also needs an `accessMode` field.

Output: Agent list view, create-agent form, per-agent identity file editing, accessMode on schema.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/desktop/src/pages/AgentsPage.tsx
@apps/desktop/src/hooks/useIdentityFiles.ts
@apps/desktop/src/lib/files.ts
@apps/desktop/src/lib/config.ts
@packages/core/src/config/schema.ts
@packages/db/src/memory/agent-resolver.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accessMode to core schema and update desktop types</name>
  <files>packages/core/src/config/schema.ts, apps/desktop/src/lib/config.ts</files>
  <action>
**Part A — Core schema (`packages/core/src/config/schema.ts`):**

Add `accessMode` to `AgentDefinitionSchema`. Current schema (line 44-49):
```typescript
export const AgentDefinitionSchema = z.object({
  id: z.string(),
  name: z.string().optional(),
  model: z.string().optional(),
  description: z.string().optional(),
});
```

Add `accessMode`:
```typescript
export const AgentDefinitionSchema = z.object({
  id: z.string(),
  name: z.string().optional(),
  model: z.string().optional(),
  description: z.string().optional(),
  accessMode: z.enum(["full", "limited"]).default("full"),
});
```

**Part B — Desktop types (`apps/desktop/src/lib/config.ts`):**

Add an `AgentDefinition` interface and update `AppConfig` to include `agents`:

```typescript
export interface AgentDefinition {
  id: string;
  name?: string;
  model?: string;
  description?: string;
  accessMode?: 'full' | 'limited';
}

export interface AgentsConfig {
  list: AgentDefinition[];
  defaultAgentId: string;
}
```

Add `agents?: AgentsConfig;` to the `AppConfig` interface, and add `agentName?: string;` and `userDisplayName?: string;` if not already present.

Also add to `AppConfig`:
```typescript
agentName?: string;
userDisplayName?: string;
agents?: AgentsConfig;
```
  </action>
  <verify>Build core: `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/core/tsconfig.json --noEmit`. Build desktop: `cd /Users/hitekmedia/Documents/GitHub/tek/apps/desktop && npx tsc --noEmit`.</verify>
  <done>AgentDefinitionSchema has `accessMode` field. Desktop has matching `AgentDefinition` and `AgentsConfig` types.</done>
</task>

<task type="auto">
  <name>Task 2: Redesign AgentsPage with agent list, create form, and per-agent identity editing</name>
  <files>apps/desktop/src/pages/AgentsPage.tsx, apps/desktop/src/hooks/useIdentityFiles.ts, apps/desktop/src/lib/files.ts</files>
  <action>
**Part A — Update `useIdentityFiles` hook to support per-agent directories:**

In `apps/desktop/src/hooks/useIdentityFiles.ts`, add an optional `agentId` parameter. When `agentId` is provided and is not `"default"`, read/write identity files from `~/.config/tek/agents/{agentId}/` instead of `~/.config/tek/`. The "default" agent (or no agentId) uses the existing `~/.config/tek/memory/` paths for backward compatibility.

Add a function parameter: `export function useIdentityFiles(agentId?: string)`. Inside, compute the base directory:
```typescript
const getBaseDir = async () => {
  const home = await homeDir();
  if (agentId && agentId !== 'default') {
    return join(home, '.config', 'tek', 'agents', agentId);
  }
  return join(home, '.config', 'tek', 'memory');
};
```

Update all file path computations to use `getBaseDir()` instead of hardcoded paths. Ensure the directory is created (via `mkdir`) if it doesn't exist when saving.

**Part B — Redesign `AgentsPage.tsx`:**

Replace the current file-editor-only page with a three-view layout:

1. **Agent List View** (default): Shows all agents from `config.agents.list`. Each agent card shows name, description, accessMode badge ("Full"/"Limited"). Include a "default" agent entry that maps to the global memory directory. Add a "+ Create Agent" button.

2. **Create Agent View**: A form with fields:
   - Name (required text input)
   - Description (optional textarea)
   - Access Mode (radio: "Full Control" / "Limited")
   - On submit: generate `id` from name (lowercase, replace spaces with hyphens), add to `config.agents.list` via `saveConfig`, create agent directory at `~/.config/tek/agents/{id}/`, seed with template identity files (copy from global or use defaults).

3. **Agent Detail View**: When an agent is selected from the list, show the existing identity file editor (tabs for SOUL.md, IDENTITY.md, USER.md, STYLE.md) but loading from the agent-specific directory. Include a back button to return to list. Show agent name and access mode at top.

Use `useState` for view state: `'list' | 'create' | 'detail'`. Store `selectedAgentId` in state.

For creating agent directories and seeding files, use Tauri FS:
```typescript
import { mkdir, writeTextFile, exists } from '@tauri-apps/plugin-fs';
```

Load the agent list from `config.agents?.list ?? []` using the existing `useConfig` hook.

Keep the UI consistent with existing page styles: dark theme, `bg-gray-800` cards, `text-blue-400` accents, same button styles as SettingsPage.

**Part C — Update `files.ts` if needed:**

If `IDENTITY_FILES` has hardcoded paths, ensure they are filename-only (not full paths) so the hook can prepend the correct base directory.
  </action>
  <verify>Build desktop app: `cd /Users/hitekmedia/Documents/GitHub/tek/apps/desktop && npx tsc --noEmit`. Verify AgentsPage has three views (list, create, detail). Verify useIdentityFiles accepts agentId parameter.</verify>
  <done>Agents page shows agent list from config. Users can create new agents with name/description/accessMode. Each agent gets its own directory at `~/.config/tek/agents/{id}/` with identity files. Agent detail view shows per-agent identity file editor.</done>
</task>

</tasks>

<verification>
1. Core schema compiles with accessMode on AgentDefinitionSchema
2. Desktop compiles with updated types and AgentsPage
3. AgentsPage renders agent list from config
4. Create agent form generates directory and seeds identity files
5. Agent detail view loads identity files from agent-specific directory
6. Default agent uses global memory directory for backward compatibility
</verification>

<success_criteria>
- `accessMode` field exists on `AgentDefinitionSchema` in core with `z.enum(["full", "limited"]).default("full")`
- Desktop `AgentsPage` shows list of agents from config with create and detail views
- Creating an agent writes to `~/.config/tek/agents/{id}/` and adds entry to config
- Default agent maps to `~/.config/tek/memory/` (backward compatible)
- All packages compile without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-desktop-integration-polish/19-03-SUMMARY.md`
</output>
