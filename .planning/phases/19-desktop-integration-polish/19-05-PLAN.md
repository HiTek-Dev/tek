---
phase: 19-desktop-integration-polish
plan: 05
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - packages/telegram/src/bot.ts
  - packages/gateway/src/index.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Telegram bot starts without punycode deprecation crash on Node.js v24"
    - "Gateway optionally auto-starts Telegram bot when token is configured"
  artifacts:
    - path: "packages/telegram/src/bot.ts"
      provides: "Bot startup with punycode workaround"
    - path: "packages/gateway/src/index.ts"
      provides: "Optional Telegram bot startup on gateway start"
      contains: "telegram"
  key_links:
    - from: "packages/gateway/src/index.ts"
      to: "packages/telegram/src/bot.ts"
      via: "startTelegramBot import and call"
      pattern: "startTelegramBot"
---

<objective>
Fix Telegram bot startup and wire into gateway lifecycle.

Purpose: The Telegram bot crashes on Node.js v24 due to the `punycode` deprecation warning. Additionally, the bot has no auto-start mechanism — it's not started by the gateway, so users must manually run it. This plan fixes the crash and wires bot startup into the gateway.

Output: Telegram bot starts reliably, optionally auto-started by gateway when a token is configured.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/telegram/src/bot.ts
@packages/telegram/src/index.ts
@packages/gateway/src/index.ts
@packages/gateway/src/key-server/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Telegram bot punycode crash and wire auto-start into gateway</name>
  <files>packages/telegram/src/bot.ts, packages/gateway/src/index.ts</files>
  <action>
**Part A — Fix punycode deprecation in Telegram bot (`packages/telegram/src/bot.ts`):**

The punycode deprecation warning from Node.js v24 may cause the bot to crash if `--throw-deprecation` is set or if it triggers an unhandled rejection.

First, read the actual bot.ts file to understand the current `startTelegramBot` implementation. Then add a try-catch wrapper around `bot.start()` with error logging. Also, suppress the punycode deprecation warning by checking if the error contains "punycode" and treating it as non-fatal.

Before `bot.start()`, add a global handler to catch the punycode warning specifically:
```typescript
// Suppress Node.js v24 punycode deprecation warning (triggered by grammY's URL handling)
const originalEmit = process.emit;
// @ts-expect-error - overriding emit for deprecation suppression
process.emit = function (event: string, ...args: unknown[]) {
  if (event === 'warning' && typeof args[0] === 'object' && args[0] !== null && (args[0] as { name?: string }).name === 'DeprecationWarning' && String((args[0] as { message?: string }).message).includes('punycode')) {
    return false;
  }
  return originalEmit.apply(process, [event, ...args] as Parameters<typeof originalEmit>);
};
```

Place this before the `bot.start()` call. This is the standard pattern used by many projects to handle this Node.js v24 issue.

Also wrap `bot.start()` in a try-catch that logs errors but doesn't crash the parent process:
```typescript
try {
  bot.start({
    onStart: () => { logger.info("Telegram bot started"); }
  });
} catch (err) {
  logger.error(`Telegram bot failed to start: ${err}`);
}
```

**Part B — Wire Telegram auto-start into gateway (`packages/gateway/src/index.ts`):**

Read the gateway's main entry point (`packages/gateway/src/index.ts`). After the server starts, check if a Telegram bot token is available in the keychain. If so, dynamically import and start the Telegram bot.

Look at how the vault/keychain is accessed in the gateway context. The gateway may use `@tek/core`'s vault functions or its own key-serving API. Find the pattern for checking if a telegram key exists.

Add a conditional startup block after the server listen:
```typescript
// Optionally start Telegram bot if token is configured
try {
  // Check for telegram token via the vault or config
  const telegramToken = /* get from vault */;
  if (telegramToken) {
    const { startTelegramBot } = await import("@tek/telegram");
    await startTelegramBot(telegramToken);
    logger.info("Telegram bot auto-started");
  }
} catch (err) {
  logger.warn(`Telegram bot not started: ${err instanceof Error ? err.message : err}`);
}
```

Use dynamic import so the telegram package is only loaded when needed. If the vault function to retrieve keys isn't accessible from the gateway, check if there's a config field or environment variable pattern. If no straightforward access exists, skip auto-start wiring and just document that the user needs to start it separately.

**Important:** Do NOT break the gateway startup if Telegram fails. Always wrap in try-catch with a warning log.
  </action>
  <verify>Build telegram package: `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/telegram/tsconfig.json --noEmit`. Build gateway: `npx tsc -p packages/gateway/tsconfig.json --noEmit`.</verify>
  <done>Telegram bot does not crash due to punycode deprecation. Gateway optionally starts Telegram bot when token is available. Failures are logged as warnings without crashing the gateway.</done>
</task>

</tasks>

<verification>
1. Telegram package compiles without errors
2. Gateway package compiles without errors
3. Bot startup has punycode deprecation suppression
4. Bot startup wrapped in try-catch
5. Gateway has optional Telegram auto-start with dynamic import
</verification>

<success_criteria>
- Telegram bot starts without crashing on Node.js v24
- Gateway auto-starts Telegram bot when token is configured
- Telegram startup failure does not crash the gateway
- Both packages compile without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-desktop-integration-polish/19-05-SUMMARY.md`
</output>
