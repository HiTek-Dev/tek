---
phase: 31-desktop-chat-app-rebuild
plan: 05
type: execute
wave: 4
depends_on: ["31-04"]
files_modified:
  - apps/desktop/src/components/ToolCallCard.tsx
  - apps/desktop/src/components/ToolApprovalModal.tsx
  - apps/desktop/src/components/SessionList.tsx
  - apps/desktop/src/views/ChatView.tsx
  - apps/desktop/src/components/Layout.tsx
  - apps/desktop/src/App.tsx
autonomous: false
requirements:
  - DESK-07
  - DESK-08

must_haves:
  truths:
    - "Tool approval modal shows tool name, arguments preview, and approve/deny/session-approve buttons"
    - "Tool call results display inline in the message stream with expandable details"
    - "Past sessions are listed in a collapsible side panel with preview and timestamp"
    - "User can click a past session to resume it"
    - "Complete desktop app functions end-to-end: launch, see status, connect, chat, approve tools, switch sessions"
  artifacts:
    - path: "apps/desktop/src/components/ToolApprovalModal.tsx"
      provides: "Tool approval dialog with approve/deny/session-approve"
      min_lines: 30
    - path: "apps/desktop/src/components/ToolCallCard.tsx"
      provides: "Expandable tool call display with result/error"
      min_lines: 25
    - path: "apps/desktop/src/components/SessionList.tsx"
      provides: "Past session list panel"
      min_lines: 30
  key_links:
    - from: "apps/desktop/src/components/ToolApprovalModal.tsx"
      to: "apps/desktop/src/hooks/useChat.ts"
      via: "approveToolCall callback"
      pattern: "approveToolCall"
    - from: "apps/desktop/src/components/SessionList.tsx"
      to: "apps/desktop/src/lib/gateway-client.ts"
      via: "createSessionList message factory"
      pattern: "createSessionList"
---

<objective>
Complete the desktop app with tool approval flow, session history panel, and end-to-end verification. Tool calls need approval modals and inline result display. Sessions need a browsable list for resuming past conversations.

Purpose: Tool approval and session management are the remaining interactive features that make the app fully functional beyond basic chat.
Output: Complete desktop chat app with tool approval modal, session list panel, and visual verification of the full flow.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-desktop-chat-app-rebuild/31-RESEARCH.md
@.planning/phases/31-desktop-chat-app-rebuild/31-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ToolCallCard, ToolApprovalModal, and SessionList components</name>
  <files>
    apps/desktop/src/components/ToolCallCard.tsx
    apps/desktop/src/components/ToolApprovalModal.tsx
    apps/desktop/src/components/SessionList.tsx
  </files>
  <action>
    1. **src/components/ToolCallCard.tsx**: Create expandable tool call display:
       - Accept props: { toolName: string; args: unknown; result?: unknown; error?: string; status: 'pending' | 'running' | 'completed' | 'error' }
       - Use shadcn Card with compact styling (smaller padding than message cards)
       - Header row: tool name (bold, monospace), status icon (Loader2 spinning for pending/running, CheckCircle green for completed, XCircle red for error)
       - Collapsed state: show only tool name + status + first line of args preview
       - Expanded state (click to toggle): show full JSON.stringify(args, null, 2) in a pre/code block, and if result/error exists, show that too in a separate section
       - Use Collapsible pattern (just useState toggle, not a library)
       - Style: muted background, border-left accent color (blue for running, green for completed, red for error)

    2. **src/components/ToolApprovalModal.tsx**: Create tool approval dialog:
       - Accept props: { toolName: string; toolCallId: string; args: unknown; risk?: string; onApprove: (toolCallId: string, sessionApprove: boolean) => void; onDeny: (toolCallId: string) => void; open: boolean }
       - Use shadcn Dialog component
       - Dialog content:
         - Title: "Tool Approval Required"
         - Tool name displayed prominently with risk badge if risk is 'medium' or 'high' (yellow/red Badge)
         - Arguments displayed in scrollable code block (JSON.stringify with 2-space indent)
         - Three action buttons at bottom:
           - "Deny" (variant="outline", left side) -> calls onDeny(toolCallId)
           - "Approve Once" (variant="default") -> calls onApprove(toolCallId, false)
           - "Approve for Session" (variant="default") -> calls onApprove(toolCallId, true)
       - Close dialog on any action

    3. **src/components/SessionList.tsx**: Create session history panel:
       - Accept props: { port: number | null; currentSessionId: string | null; onSelectSession: (sessionId: string) => void }
       - On mount (when port available): send session.list request via a local WebSocket call or fetch
       - Actually, use a simpler approach: accept sessions as a prop from ChatView (which fetches via useChat/useWebSocket)
       - Revised props: { sessions: SessionSummary[]; currentSessionId: string | null; onSelectSession: (sessionId: string) => void }
       - SessionSummary: { sessionId: string; sessionKey: string; model: string; createdAt: string; messageCount: number }
       - Display as a vertical list using shadcn Card items:
         - Each session: show truncated sessionKey (or "Session" + last 4 chars of sessionId), model badge, message count, relative timestamp (e.g., "2h ago", "Yesterday")
         - Current session highlighted with accent border
         - Click to call onSelectSession(sessionId)
       - If no sessions: show "No previous sessions" text
       - Add a "New Chat" button at top that calls onSelectSession with empty string (signals new session)
  </action>
  <verify>
    - `grep "ToolCallCard" apps/desktop/src/components/ToolCallCard.tsx` matches
    - `grep "Dialog" apps/desktop/src/components/ToolApprovalModal.tsx` matches
    - `grep "SessionList" apps/desktop/src/components/SessionList.tsx` matches
    - `grep "Approve for Session" apps/desktop/src/components/ToolApprovalModal.tsx` matches
  </verify>
  <done>
    ToolCallCard shows expandable tool execution details with status indicators. ToolApprovalModal presents approve/deny/session-approve options with argument preview. SessionList displays past sessions with timestamps and allows switching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate tool approval and sessions into ChatView and Layout</name>
  <files>
    apps/desktop/src/views/ChatView.tsx
    apps/desktop/src/components/Layout.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
    1. **Update src/views/ChatView.tsx**:
       - Add ToolApprovalModal: watch messages for tool_approval type with status 'pending', show modal for the first pending approval
       - Wire modal onApprove/onDeny to useChat's approveToolCall function
       - Add session fetching: on mount (when connected), send session.list request via WebSocket, store response in local state
       - Add SessionList to a collapsible side panel:
         - Use a flex layout: side panel (when open) + chat content
         - Side panel: fixed width 280px, collapsible via toggle button in header
         - Pass sessions, currentSessionId, onSelectSession handler
         - onSelectSession: update sessionId in app store (this causes useChat to reconnect to that session)
       - Add "New Chat" handler: clear sessionId from store, clear messages in useChat
       - Update MessageCard rendering to use ToolCallCard for tool_call type messages
       - Show usage/cost info in a subtle footer bar below the message list (inputTokens, outputTokens, totalCost formatted)

    2. **Update src/components/Layout.tsx**:
       - Add a toggle button in header for session sidebar (lucide PanelLeftOpen/PanelLeftClose icon)
       - Pass sidebar open state down via prop or context
       - Ensure layout accommodates the side panel when on chat view

    3. **Update src/App.tsx**:
       - Ensure ChatView receives all necessary props from app store
       - Add keyboard shortcut: Cmd+N (Mac) for new chat
  </action>
  <verify>
    - `grep "ToolApprovalModal" apps/desktop/src/views/ChatView.tsx` matches
    - `grep "SessionList" apps/desktop/src/views/ChatView.tsx` matches
    - `grep "ToolCallCard\|tool_call" apps/desktop/src/views/ChatView.tsx` matches
    - `grep "PanelLeft" apps/desktop/src/components/Layout.tsx` matches
  </verify>
  <done>
    ChatView integrates tool approval modal (auto-shows on pending approvals), session list side panel (collapsible, shows past sessions), and tool call cards inline in the message stream. Layout header has sidebar toggle. Full chat functionality is wired end-to-end.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete desktop app end-to-end</name>
  <files>apps/desktop/</files>
  <action>
    Human verification checkpoint. What was built: Complete Tauri desktop chat app with gateway status landing, agent selection, streaming chat with Streamdown markdown, tool approval modal, and session history panel.

    Steps to verify:
    1. Start the gateway: `tek gateway start`
    2. Launch the desktop app: `cd apps/desktop && pnpm tauri dev`
    3. Verify landing page shows gateway status (should show green "Connected")
    4. Click "Start Chat" or wait for auto-transition to chat view
    5. Verify agent is auto-selected (if only one agent configured)
    6. Type a message and press Enter -- verify it appears right-aligned
    7. Verify streaming response appears with markdown rendering (code blocks, bold, lists)
    8. If a tool call occurs, verify the approval modal appears with approve/deny buttons
    9. Click the sidebar toggle -- verify session list panel opens
    10. Verify the current session appears in the session list
    11. Check that the window title is "Tek" and the app looks polished (dark theme, consistent typography)
  </action>
  <verify>User confirms the desktop app is functional and visually correct</verify>
  <done>User types "approved" confirming the desktop app works end-to-end</done>
</task>

</tasks>

<verification>
- Tool approval modal shows on pending tool.approval.request with correct tool name and args
- Approve/Deny/Session-approve all send correct protocol messages
- Tool call results show inline with expandable details
- Session list shows past sessions with relative timestamps
- Session switching works (click session -> messages load from that session)
- New chat button clears session and starts fresh
- Sidebar collapses and expands smoothly
- Full app works end-to-end: launch -> landing -> chat -> message -> stream -> tool -> sessions
</verification>

<success_criteria>
The desktop chat app is a complete, functional Tauri application. Users can launch it, see gateway status, chat with agents, approve tool calls, and manage sessions. The UI is polished with shadcn/ui components, dark theme, and streaming markdown rendering.
</success_criteria>

<output>
After completion, create `.planning/phases/31-desktop-chat-app-rebuild/31-05-SUMMARY.md`
</output>
