---
phase: 31-desktop-chat-app-rebuild
plan: 04
type: execute
wave: 3
depends_on: ["31-02", "31-03"]
files_modified:
  - apps/desktop/src/components/MessageCard.tsx
  - apps/desktop/src/components/MessageList.tsx
  - apps/desktop/src/components/StreamingMessage.tsx
  - apps/desktop/src/components/ChatInput.tsx
  - apps/desktop/src/components/AgentSelector.tsx
  - apps/desktop/src/views/ChatView.tsx
  - apps/desktop/src/App.tsx
autonomous: true
requirements:
  - DESK-04
  - DESK-05
  - DESK-06

must_haves:
  truths:
    - "User sees a chat interface with message history and input area"
    - "User messages appear right-aligned, assistant messages left-aligned"
    - "Assistant streaming text renders with Streamdown (flicker-free markdown)"
    - "User can type in auto-resizing textarea and send with Enter"
    - "Agent selector dropdown shows available agents (or auto-selects if only one)"
    - "Message list auto-scrolls to bottom on new content unless user scrolled up"
  artifacts:
    - path: "apps/desktop/src/views/ChatView.tsx"
      provides: "Full chat interface combining all chat components"
      min_lines: 40
    - path: "apps/desktop/src/components/MessageCard.tsx"
      provides: "Individual message bubble (user/assistant/tool)"
      min_lines: 25
    - path: "apps/desktop/src/components/StreamingMessage.tsx"
      provides: "Active streaming message with Streamdown rendering"
      min_lines: 15
    - path: "apps/desktop/src/components/ChatInput.tsx"
      provides: "Auto-resizing textarea with send button"
      min_lines: 25
    - path: "apps/desktop/src/components/AgentSelector.tsx"
      provides: "Agent picker dropdown"
      min_lines: 15
  key_links:
    - from: "apps/desktop/src/views/ChatView.tsx"
      to: "apps/desktop/src/hooks/useChat.ts"
      via: "useChat hook providing messages, sendMessage, streaming state"
      pattern: "useChat"
    - from: "apps/desktop/src/components/StreamingMessage.tsx"
      to: "streamdown"
      via: "Streamdown component for streaming markdown"
      pattern: "streamdown"
    - from: "apps/desktop/src/views/ChatView.tsx"
      to: "apps/desktop/src/hooks/useConfig.ts"
      via: "useConfig hook for agent list"
      pattern: "useConfig"
---

<objective>
Build the complete chat view with message rendering, streaming display, input area, and agent selection. This is the primary user interaction surface of the desktop app.

Purpose: The chat view is where users spend most of their time. It must feel responsive (streaming), polished (shadcn cards), and intuitive (auto-scroll, auto-resize input).
Output: A fully functional chat interface that sends messages, shows streaming responses with markdown, and allows agent selection.
</objective>

<execution_context>
@/Users/drew-mini/.claude/get-shit-done/workflows/execute-plan.md
@/Users/drew-mini/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-desktop-chat-app-rebuild/31-RESEARCH.md
@.planning/phases/31-desktop-chat-app-rebuild/31-02-SUMMARY.md
@.planning/phases/31-desktop-chat-app-rebuild/31-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessageCard, StreamingMessage, and MessageList components</name>
  <files>
    apps/desktop/src/components/MessageCard.tsx
    apps/desktop/src/components/StreamingMessage.tsx
    apps/desktop/src/components/MessageList.tsx
  </files>
  <action>
    1. **src/components/MessageCard.tsx**: Create message display component:
       - Accept props: { message: ChatMessage; model?: string | null }
       - For text messages (message.type === 'text'):
         - Use shadcn Card component
         - User messages: right-aligned (ml-auto), max-w-[80%], plain text with whitespace-pre-wrap
         - Assistant messages: left-aligned (mr-auto), max-w-[80%], render content via Streamdown for completed messages (isAnimating=false)
         - Show model badge (shadcn Badge, variant="secondary") below assistant messages when model is provided
         - Show timestamp (HH:MM) dimmed at bottom-right of card
       - For tool_call messages (message.type === 'tool_call'):
         - Render a compact card showing tool name, status indicator (spinner for pending/running, check for completed, x for error)
         - Show truncated args preview (first 100 chars, JSON.stringify)
         - Expandable: click to toggle full args and result display
         - Use lucide icons: Loader2 (spinning) for pending, Check for completed, X for error
       - For tool_approval messages: skip rendering here (handled by ToolApprovalModal in Plan 05)

    2. **src/components/StreamingMessage.tsx**: Create active streaming message component:
       - Accept props: { text: string; isStreaming: boolean; model?: string | null }
       - Use Streamdown with @streamdown/code plugin (CodePlugin) for syntax highlighting
       - Pass isAnimating={isStreaming} to Streamdown
       - Wrap in shadcn Card (same styling as assistant MessageCard)
       - Show pulsing dot indicator when isStreaming is true
       - Show model badge when available

    3. **src/components/MessageList.tsx**: Create scrollable message container:
       - Accept props: { messages: ChatMessage[]; streamingText: string; isStreaming: boolean; model?: string | null }
       - Use shadcn ScrollArea for scrollable container
       - Render each message via MessageCard
       - If isStreaming && streamingText, render StreamingMessage at bottom
       - **Smart auto-scroll logic:**
         - Track whether user is near bottom (within 100px of bottom)
         - If user is near bottom, auto-scroll on new messages or streaming content
         - If user scrolled up, do NOT auto-scroll
         - Show floating "Scroll to bottom" button when user is scrolled up and new content arrives
         - Use useRef for scroll container and useEffect for scroll management
       - Empty state: show centered message "Start a conversation" with subtle icon
  </action>
  <verify>
    - `grep "MessageCard" apps/desktop/src/components/MessageCard.tsx` matches
    - `grep "Streamdown" apps/desktop/src/components/StreamingMessage.tsx` matches
    - `grep "MessageList" apps/desktop/src/components/MessageList.tsx` matches
    - `grep "ScrollArea" apps/desktop/src/components/MessageList.tsx` matches
    - `grep "auto-scroll\|scrollTo\|scrollHeight" apps/desktop/src/components/MessageList.tsx` matches (smart scroll logic)
  </verify>
  <done>
    Message rendering components display user messages (right-aligned, plain text), assistant messages (left-aligned, Streamdown markdown), and tool calls (expandable cards). Smart auto-scroll follows new content unless user scrolled up.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChatInput, AgentSelector, and ChatView</name>
  <files>
    apps/desktop/src/components/ChatInput.tsx
    apps/desktop/src/components/AgentSelector.tsx
    apps/desktop/src/views/ChatView.tsx
    apps/desktop/src/App.tsx
  </files>
  <action>
    1. **src/components/ChatInput.tsx**: Create chat input component:
       - Accept props: { onSend: (content: string) => void; disabled?: boolean }
       - Use shadcn Textarea component
       - Auto-resize: adjust height as user types (min 1 row, max 6 rows)
       - Submit: Enter sends message (Shift+Enter for newline)
       - Clear input after send
       - Disable when disabled prop is true (during streaming)
       - Show Send button (lucide Send icon) at right side of input area
       - Send button disabled when input is empty or disabled
       - Focus textarea on mount

    2. **src/components/AgentSelector.tsx**: Create agent picker:
       - Accept props: { agents: Agent[]; selectedId: string | null; onSelect: (id: string) => void }
       - If only one agent: show agent name as text (no dropdown), auto-select via useEffect
       - If multiple agents: use shadcn DropdownMenu with agent names
       - Show selected agent name with lucide Bot icon
       - Agent type: { id: string; name?: string; description?: string }

    3. **src/views/ChatView.tsx**: Compose the full chat view:
       - Use useChat(port, agentId) hook to get messages, streaming state, sendMessage, approveToolCall
       - Use useConfig() hook to get agent list
       - Use useAppStore for gateway port and selectedAgentId
       - Layout: flex column, full height
         - Top bar: AgentSelector + model/token info (from useChat currentModel, usage)
         - Middle: MessageList (flex-1, overflow)
         - Bottom: ChatInput (fixed at bottom)
       - Agent auto-selection logic:
         - If config has one agent, auto-select it (set selectedAgentId in store)
         - If config has multiple agents with defaultAgentId, auto-select default
         - Otherwise show AgentSelector for user to pick
       - Pass sendMessage to ChatInput's onSend
       - Pass messages, streamingText, isStreaming to MessageList
       - Show WebSocket connection status indicator (from useChat wsStatus)

    4. **Update src/App.tsx**: Replace chat placeholder:
       - Import ChatView
       - In the view switch, render ChatView instead of placeholder div
       - Add a "back to landing" button/link in the Layout header when on chat view
  </action>
  <verify>
    - `grep "ChatInput" apps/desktop/src/components/ChatInput.tsx` matches
    - `grep "AgentSelector" apps/desktop/src/components/AgentSelector.tsx` matches
    - `grep "ChatView" apps/desktop/src/views/ChatView.tsx` matches
    - `grep "useChat" apps/desktop/src/views/ChatView.tsx` matches
    - `grep "ChatView" apps/desktop/src/App.tsx` matches
    - `grep "onSend\|sendMessage" apps/desktop/src/views/ChatView.tsx` matches
  </verify>
  <done>
    ChatView assembles all chat components: agent selector at top, scrollable message list in middle, auto-resizing input at bottom. Messages stream in real-time via useChat hook. Agent auto-selects when only one exists. User can type, send (Enter), and see streaming responses with markdown rendering.
  </done>
</task>

</tasks>

<verification>
- MessageCard renders user messages right-aligned and assistant messages left-aligned
- StreamingMessage uses Streamdown with CodePlugin for flicker-free streaming markdown
- MessageList auto-scrolls only when user is at bottom
- ChatInput auto-resizes and submits on Enter (Shift+Enter for newline)
- AgentSelector auto-selects single agent, shows dropdown for multiple
- ChatView wires useChat hook to all components correctly
- App.tsx renders ChatView when currentView === 'chat'
</verification>

<success_criteria>
The chat interface is fully functional: users can select an agent, type messages, see streaming markdown responses, and view tool calls. The UX feels polished with auto-scroll, auto-resize input, and smooth streaming rendering.
</success_criteria>

<output>
After completion, create `.planning/phases/31-desktop-chat-app-rebuild/31-04-SUMMARY.md`
</output>
