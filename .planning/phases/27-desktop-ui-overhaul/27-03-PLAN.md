---
phase: 27-desktop-ui-overhaul
plan: 03
type: execute
wave: 3
depends_on: ["27-01", "27-02"]
files_modified:
  - apps/desktop/src/components/modals/ToolApprovalModal.tsx
  - apps/desktop/src/hooks/useChat.ts
  - apps/desktop/src/pages/ChatPage.tsx
  - apps/desktop/src/components/ChatMessage.tsx
autonomous: true
requirements:
  - DSKV-03
  - DSKV-08

must_haves:
  truths:
    - "When gateway sends tool.approval.request, a modal appears showing tool name, arguments preview, and risk level"
    - "User can approve, deny, or session-approve from the modal and the response is sent to gateway"
    - "Multiple concurrent approval requests are queued and shown in order"
    - "Tool call messages are expandable/collapsible with chevron toggle"
    - "Assistant messages show a model badge"
  artifacts:
    - path: "apps/desktop/src/components/modals/ToolApprovalModal.tsx"
      provides: "Tool approval modal with approve/deny/session-approve buttons"
      exports: ["ToolApprovalModal"]
    - path: "apps/desktop/src/hooks/useChat.ts"
      provides: "Extended chat hook with pendingApprovals queue and handleApproval callback"
    - path: "apps/desktop/src/components/ChatMessage.tsx"
      provides: "Redesigned chat cards with expandable tool calls and model badge"
  key_links:
    - from: "apps/desktop/src/hooks/useChat.ts"
      to: "apps/desktop/src/lib/gateway-client.ts"
      via: "createToolApprovalResponse factory on approval"
      pattern: "createToolApprovalResponse"
    - from: "apps/desktop/src/pages/ChatPage.tsx"
      to: "apps/desktop/src/components/modals/ToolApprovalModal.tsx"
      via: "renders modal when pendingApprovals[0] exists"
      pattern: "ToolApprovalModal"
---

<objective>
Add tool approval modal and redesign chat message cards.

Purpose: Users currently have no way to approve or deny tool calls from the desktop app. This plan adds a modal for tool approval with queue support, and redesigns chat messages as polished cards with expandable tool calls and model badges.
Output: ToolApprovalModal component, extended useChat with approval queue, redesigned ChatMessage cards.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-desktop-ui-overhaul/27-RESEARCH.md
@.planning/phases/27-desktop-ui-overhaul/27-01-SUMMARY.md
@apps/desktop/src/hooks/useChat.ts
@apps/desktop/src/lib/gateway-client.ts
@apps/desktop/src/components/ChatMessage.tsx
@apps/desktop/src/pages/ChatPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ToolApprovalModal and extend useChat with approval queue</name>
  <files>apps/desktop/src/components/modals/ToolApprovalModal.tsx, apps/desktop/src/hooks/useChat.ts</files>
  <action>
**ToolApprovalModal.tsx:** Create `apps/desktop/src/components/modals/ToolApprovalModal.tsx`.
Props: `toolName: string`, `toolCallId: string`, `args: unknown`, `risk?: string`, `queueSize: number`, `onResponse: (approved: boolean, sessionApprove?: boolean) => void`
- Full-screen overlay with `fixed inset-0 bg-black/50 flex items-center justify-center z-50`
- Card: `bg-surface-elevated border border-surface-overlay rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl`
- Header: "Tool Approval Required" (text-lg font-semibold text-text-primary)
- Tool name in Brand badge: `text-sm font-mono text-brand-400 bg-brand-400/10 px-2 py-0.5 rounded`
- Risk indicator: high=text-red-400, medium=text-yellow-400, low=text-green-400
- If queueSize > 1, show `"1 of {queueSize}"` indicator
- Args preview: `<pre>` in `bg-surface-primary rounded-lg p-3 max-h-48 overflow-y-auto` with `text-xs text-text-secondary font-mono whitespace-pre-wrap`. Stringify args if object.
- Three buttons in a row:
  - Approve: `bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg text-sm font-medium`
  - Deny: `bg-red-600 hover:bg-red-500 text-white py-2 rounded-lg text-sm font-medium`
  - Session Approve: `bg-brand-600 hover:bg-brand-500 text-white py-2 rounded-lg text-sm font-medium`

**useChat.ts:** Extend the hook:
1. Add a `ToolApprovalRequest` type: `{ toolCallId: string; toolName: string; args: unknown; risk?: string }`
2. Add state: `pendingApprovals` as `ToolApprovalRequest[]` (array/queue, NOT single value — see pitfall #3 in research)
3. In the message handler switch, add `case "tool.approval.request"`: push a new ToolApprovalRequest into the pendingApprovals array
4. Add `handleApproval` callback: takes `(approved: boolean, sessionApprove?: boolean)`. Sends `createToolApprovalResponse(pendingApprovals[0].toolCallId, approved, sessionApprove)` via `opts.send`, then removes the first item from the queue.
5. Export `pendingApprovals` and `handleApproval` from the hook's return type (update UseChatReturn interface)
  </action>
  <verify>
Run `pnpm build` from apps/desktop — no TypeScript errors. Verify useChat exports pendingApprovals and handleApproval.
  </verify>
  <done>
ToolApprovalModal renders with approve/deny/session-approve buttons. useChat handles tool.approval.request messages in a FIFO queue. handleApproval sends response and dequeues.
  </done>
</task>

<task type="auto">
  <name>Task 2: Redesign ChatMessage cards and wire ToolApprovalModal into ChatPage</name>
  <files>apps/desktop/src/components/ChatMessage.tsx, apps/desktop/src/pages/ChatPage.tsx</files>
  <action>
**ChatMessage.tsx:** Redesign message rendering:
1. **Assistant text messages:** Add model badge after the "Assistant" label. Accept optional `model` prop on ChatMessageProps. Show `<Badge variant="brand">{model}</Badge>` next to "Assistant" when model is provided. Import Badge from `./ui/Badge`.
2. **Tool call messages:** Make expandable/collapsible. Add local `useState` for `expanded` (default: false for completed, true for pending). Add a chevron toggle button (SVG rotates 90deg when expanded). Show tool name and status always. Input/output pre blocks only visible when expanded. Use `transition-all duration-200` on the collapsible container. Use `overflow-hidden` and `max-h-0`/`max-h-96` for smooth expand.
3. **User messages:** Keep right-aligned. Already using brand tokens from plan 02.
4. Update ChatMessageProps to accept optional `model?: string | null` prop

**ChatPage.tsx:**
1. Import ToolApprovalModal from `../components/modals/ToolApprovalModal`
2. Destructure `pendingApprovals` and `handleApproval` from `useChat` return
3. Render `<ToolApprovalModal>` when `pendingApprovals.length > 0`, passing `pendingApprovals[0]` props and `queueSize={pendingApprovals.length}`
4. Pass `model={chat.model}` to each `<ChatMessage>` for assistant messages (pass null for non-assistant to avoid showing badge on user messages)
  </action>
  <verify>
Run `pnpm build` from apps/desktop — no TypeScript errors. ChatPage renders ToolApprovalModal when pendingApprovals exist. ChatMessage shows model badge for assistant messages and expandable tool calls.
  </verify>
  <done>
Tool approval modal appears for gateway approval requests with queue support. Chat messages display as polished cards: assistant with model badge, tool calls expandable with chevron toggle.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` in apps/desktop succeeds
- ToolApprovalModal exists and handles approve/deny/session-approve
- useChat handles tool.approval.request in FIFO queue
- ChatMessage shows model badge for assistant messages
- Tool call cards are expandable/collapsible
- ChatPage renders modal when approvals are pending
</verification>

<success_criteria>
Users can approve, deny, or session-approve tool calls from a desktop modal that shows tool name, argument preview, and risk level. Multiple concurrent requests are queued. Chat messages display as polished cards with model badges and expandable tool calls.
</success_criteria>

<output>
After completion, create `.planning/phases/27-desktop-ui-overhaul/27-03-SUMMARY.md`
</output>
