---
phase: 27-desktop-ui-overhaul
plan: 04
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - apps/desktop/src/components/Sidebar.tsx
  - apps/desktop/src/components/sidebar/SessionList.tsx
  - apps/desktop/src/hooks/useSessions.ts
  - apps/desktop/src/components/Layout.tsx
  - apps/desktop/src/stores/app-store.ts
  - apps/desktop/src/App.tsx
autonomous: true
requirements:
  - DSKV-05
  - DSKV-09
  - DSKV-10

must_haves:
  truths:
    - "Sidebar collapses to icon-only mode with a toggle button and smooth width transition"
    - "Conversation history panel lists past sessions with metadata (model, session key), timestamp, and message count (gateway has no preview/lastMessage field; shows identifiers, not message content)"
    - "Clicking a past session navigates to chat and sets sessionId to resume that conversation"
    - "Page transitions have a subtle fade-in animation when switching pages"
  artifacts:
    - path: "apps/desktop/src/components/Sidebar.tsx"
      provides: "Collapsible sidebar with session list integration"
    - path: "apps/desktop/src/components/sidebar/SessionList.tsx"
      provides: "Past session list with preview and click-to-resume"
      exports: ["SessionList"]
    - path: "apps/desktop/src/hooks/useSessions.ts"
      provides: "Hook to fetch/manage session list from gateway"
      exports: ["useSessions"]
    - path: "apps/desktop/src/stores/app-store.ts"
      provides: "Extended store with sidebarCollapsed state"
    - path: "apps/desktop/src/components/Layout.tsx"
      provides: "Updated layout with page fade transition and collapsed sidebar support"
  key_links:
    - from: "apps/desktop/src/hooks/useSessions.ts"
      to: "apps/desktop/src/lib/gateway-client.ts"
      via: "createSessionListMessage to request sessions"
      pattern: "createSessionListMessage"
    - from: "apps/desktop/src/components/sidebar/SessionList.tsx"
      to: "apps/desktop/src/stores/app-store.ts"
      via: "setCurrentPage('chat') on session click"
      pattern: "setCurrentPage"
    - from: "apps/desktop/src/components/Layout.tsx"
      to: "animate-fade-in"
      via: "CSS class keyed on currentPage for re-trigger"
      pattern: "animate-fade-in"
---

<objective>
Add collapsible sidebar with conversation history and page transition animations.

Purpose: The sidebar is currently fixed-width with no session history. This plan makes it collapsible to icon-only mode, adds a past sessions panel for conversation resume, and applies subtle fade animations on page navigation.
Output: Collapsible Sidebar, SessionList component, useSessions hook, page fade transitions in Layout.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-desktop-ui-overhaul/27-RESEARCH.md
@.planning/phases/27-desktop-ui-overhaul/27-01-SUMMARY.md
@apps/desktop/src/components/Sidebar.tsx
@apps/desktop/src/components/Layout.tsx
@apps/desktop/src/stores/app-store.ts
@apps/desktop/src/App.tsx
@apps/desktop/src/lib/gateway-client.ts
@apps/desktop/src/hooks/useWebSocket.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSessions hook and SessionList component</name>
  <files>apps/desktop/src/hooks/useSessions.ts, apps/desktop/src/components/sidebar/SessionList.tsx</files>
  <action>
**useSessions.ts:** Create `apps/desktop/src/hooks/useSessions.ts` following the research pattern:
- Define `Session` type: `{ sessionId: string; sessionKey: string; model: string; createdAt: string; messageCount: number }`
- Accept params: `send`, `addMessageHandler`, `removeMessageHandler`, `connected` (same pattern as useChat)
- State: `sessions: Session[]`, `loading: boolean`
- `refresh` callback: sends `createSessionListMessage()` via `send`, sets `loading = true`
- Message handler: listens for `type === "session.list.response"` (check gateway protocol — may also be `"session.list"`) with `Array.isArray(m.sessions)`, sets sessions and loading=false
- Auto-fetch on mount when connected
- Export: `{ sessions, loading, refresh }`

**SessionList.tsx:** Create `apps/desktop/src/components/sidebar/SessionList.tsx`.
Props: `sessions: Session[]`, `loading: boolean`, `collapsed: boolean`, `onSelectSession: (sessionId: string) => void`
- If collapsed, show nothing (return null)
- If loading, show 3 Skeleton items (import from `../ui/Skeleton`)
- If no sessions, show "No sessions yet" muted text
- For each session (sorted by createdAt descending, show max 10):
  - Clickable button, full width
  - Show session key or first 20 chars of sessionId as title (text-xs text-text-primary truncate)
  - Show model name (text-xs text-text-muted)
  - Show relative time (e.g., "2h ago", "yesterday") — write a simple `timeAgo(dateStr)` helper inline
  - Show message count badge using Badge component
  - Hover: bg-surface-elevated
- Section header: "Recent Sessions" in text-xs font-semibold text-text-muted uppercase tracking-wider, with a refresh button icon
  </action>
  <verify>
Run `pnpm build` from apps/desktop. Confirm useSessions exports the hook and SessionList exports the component.
  </verify>
  <done>
useSessions fetches session list from gateway. SessionList displays past sessions with preview, timestamp, message count, and click handler.
  </done>
</task>

<task type="auto">
  <name>Task 2: Make Sidebar collapsible, wire SessionList, add page fade transitions</name>
  <files>apps/desktop/src/stores/app-store.ts, apps/desktop/src/components/Sidebar.tsx, apps/desktop/src/components/Layout.tsx, apps/desktop/src/App.tsx</files>
  <action>
**app-store.ts:** Add `sidebarCollapsed: boolean` (default false) and `toggleSidebar: () => void` to AppState. Implement toggleSidebar as `set((s) => ({ sidebarCollapsed: !s.sidebarCollapsed }))`.

**Sidebar.tsx:** Refactor to accept `collapsed` and `onToggle` props:
1. Change width from fixed `w-56` to conditional: `collapsed ? 'w-14' : 'w-56'`
2. Add `transition-all duration-200` for smooth width animation
3. Replace hardcoded `bg-[#1a1a1a]` with `bg-surface-secondary`, `border-[#2a2a2a]` with `border-surface-overlay`
4. When collapsed, hide text labels (`{!collapsed && <span>{label}</span>}`), center icons (`collapsed ? 'justify-center' : ''`)
5. Add collapse toggle button in the header area (chevron-left icon when expanded, chevron-right when collapsed). Place after the "Tek" title.
6. When collapsed, hide "Tek" text, show only the toggle button centered
7. Update active nav item colors: replace `bg-blue-500/20 text-blue-400` with `bg-brand-500/20 text-brand-400`
8. Replace hover `bg-[#252525]` with `bg-surface-elevated`
9. Add a section divider after nav items, then render `<SessionList>` below the nav. The SessionList needs WebSocket connection — accept `sessions`, `sessionsLoading`, `collapsed`, and `onSelectSession` as additional props and pass them through.

**Layout.tsx:**
1. Import `useAppStore` from stores
2. Read `sidebarCollapsed` and `toggleSidebar` from store
3. Pass `collapsed` and `onToggle` to Sidebar
4. Add `key={currentPage}` and `className="animate-fade-in"` to the `<main>` element to trigger fade animation on page change (uses keyframes from 27-01)

**App.tsx:** The App needs to provide WebSocket context for SessionList in the Sidebar. Since WebSocket is currently only created inside ChatPage, we need to think about this carefully.

Approach: Create the WebSocket connection at the App level (or Layout level) so both Sidebar's SessionList and ChatPage can share it. However, this is a significant refactor. Simpler approach: Have the Sidebar call useSessions only when on non-chat pages. When on the chat page, ChatPage already has the WS connection.

Simplest approach for now: Add a `sessions` prop to Sidebar from ChatPage when on the chat page. For other pages, sessions list shows cached data from the store.

Actually, simplest: Add `sessions: Session[]` state to app-store. ChatPage populates it when connected. Sidebar reads from store. SessionList just displays what's in the store.

Implementation:
1. In app-store.ts, add `sessions: Session[]` (default []), `setSessions: (sessions: Session[]) => void`
2. In ChatPage, use useSessions hook and call `setSessions` from the store whenever sessions update (useEffect)
3. In Sidebar, read sessions from store and pass to SessionList
4. When user clicks a session in SessionList: call `onSelectSession` which sets `currentPage` to 'chat' and stores the selected sessionId. Add `resumeSessionId: string | null` and `setResumeSessionId` to app-store. ChatPage reads this and uses it when sending the first message.
  </action>
  <verify>
Run `pnpm build` from apps/desktop. Test that Sidebar renders with collapse toggle. Layout applies fade animation class with currentPage key.
  </verify>
  <done>
Sidebar collapses to icon-only mode with smooth transition. Session list displays in sidebar below nav items. Page transitions fade in when switching pages. Clicking a session navigates to chat with resume intent.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` in apps/desktop succeeds
- Sidebar has collapse toggle and transitions between w-56 and w-14
- SessionList displays sessions from store with timestamps and message counts
- Layout applies animate-fade-in keyed on currentPage
- app-store has sidebarCollapsed, sessions, resumeSessionId state
</verification>

<success_criteria>
Sidebar is collapsible to icon-only mode with smooth CSS transition. Past sessions are listed with metadata (model, session key), timestamps, and message counts. Clicking a session navigates to chat to resume it. Page transitions have a subtle fade-in animation.
</success_criteria>

<output>
After completion, create `.planning/phases/27-desktop-ui-overhaul/27-04-SUMMARY.md`
</output>
