---
phase: 27-desktop-ui-overhaul
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - apps/desktop/src/components/chat/MarkdownRenderer.tsx
  - apps/desktop/src/components/chat/CodeBlock.tsx
  - apps/desktop/src/components/ChatMessage.tsx
  - apps/desktop/package.json
autonomous: true
requirements:
  - DSKV-01
  - DSKV-02

must_haves:
  truths:
    - "Completed assistant messages render headers, lists, tables, inline code, links, and fenced code blocks as formatted markdown"
    - "Fenced code blocks display syntax-highlighted code with a copy-to-clipboard button"
    - "Streaming text remains plain whitespace-pre-wrap (no markdown parsing during streaming)"
  artifacts:
    - path: "apps/desktop/src/components/chat/MarkdownRenderer.tsx"
      provides: "react-markdown wrapper with remark-gfm and custom component overrides"
      exports: ["MarkdownRenderer"]
    - path: "apps/desktop/src/components/chat/CodeBlock.tsx"
      provides: "Shiki-highlighted code block with copy button"
      exports: ["CodeBlock"]
    - path: "apps/desktop/src/components/ChatMessage.tsx"
      provides: "Updated assistant message rendering using MarkdownRenderer"
  key_links:
    - from: "apps/desktop/src/components/ChatMessage.tsx"
      to: "apps/desktop/src/components/chat/MarkdownRenderer.tsx"
      via: "import and render for assistant text messages"
      pattern: "MarkdownRenderer"
    - from: "apps/desktop/src/components/chat/MarkdownRenderer.tsx"
      to: "apps/desktop/src/components/chat/CodeBlock.tsx"
      via: "react-markdown components.code override"
      pattern: "code.*CodeBlock"
---

<objective>
Add markdown rendering with syntax highlighting to assistant messages.

Purpose: Assistant messages currently display as plain pre-wrapped text. This plan makes them render full markdown (headers, lists, tables, code blocks with syntax highlighting and copy button) using react-markdown and react-shiki, matching the quality of Claude Code's CLI output.
Output: MarkdownRenderer and CodeBlock components, updated ChatMessage to use MarkdownRenderer for completed assistant text.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-desktop-ui-overhaul/27-RESEARCH.md
@.planning/phases/27-desktop-ui-overhaul/27-01-SUMMARY.md
@apps/desktop/src/components/ChatMessage.tsx
@apps/desktop/src/components/StreamingText.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install markdown dependencies and create CodeBlock + MarkdownRenderer</name>
  <files>apps/desktop/package.json, apps/desktop/src/components/chat/CodeBlock.tsx, apps/desktop/src/components/chat/MarkdownRenderer.tsx</files>
  <action>
Install dependencies:
```bash
cd apps/desktop && pnpm add react-markdown remark-gfm react-shiki
```

**CodeBlock.tsx:** Create `apps/desktop/src/components/chat/CodeBlock.tsx`.
- Accept props: `className?: string`, `children?: React.ReactNode`
- Extract language from `className` via regex `/language-(\w+)/`
- If no language match (inline code): render `<code className="bg-surface-elevated px-1.5 py-0.5 rounded text-sm font-mono text-brand-400">{children}</code>`
- If language match (fenced code block): render a wrapper `<div className="relative group my-3">` containing:
  - A copy button: `<button>` with absolute positioning (top-2 right-2), opacity-0 group-hover:opacity-100, onClick calls `navigator.clipboard.writeText(code)`. Show "Copied!" text for 2 seconds after click using local state.
  - `<ShikiHighlighter language={lang} theme="github-dark">{code}</ShikiHighlighter>` from `react-shiki`
  - Extract code string: `String(children).replace(/\n$/, '')`
- Language list to support (same as CLI): typescript, javascript, json, bash, python, css, html, yaml, markdown, tsx, jsx. react-shiki lazy-loads by default, so just pass the detected language string.

**MarkdownRenderer.tsx:** Create `apps/desktop/src/components/chat/MarkdownRenderer.tsx`.
- Accept props: `content: string`
- Use `ReactMarkdown` from `react-markdown` with `remarkPlugins={[remarkGfm]}`
- Override `components`:
  - `code`: delegate to `CodeBlock`
  - `table`: wrap in `<div className="overflow-x-auto my-3"><table className="min-w-full border-collapse text-sm">...</table></div>`
  - `th`: `<th className="border-b border-surface-overlay px-3 py-2 text-left text-text-secondary font-medium">...</th>`
  - `td`: `<td className="border-b border-surface-overlay px-3 py-2 text-text-primary">...</td>`
  - `a`: `<a href={href} target="_blank" rel="noopener noreferrer" className="text-brand-400 hover:underline">...</a>`
  - `h1` through `h4`: appropriate text sizes with `font-semibold text-text-primary` and `mt-4 mb-2`
  - `ul`: `<ul className="list-disc list-inside space-y-1 my-2 text-text-primary">...</ul>`
  - `ol`: `<ol className="list-decimal list-inside space-y-1 my-2 text-text-primary">...</ol>`
  - `blockquote`: `<blockquote className="border-l-2 border-brand-400 pl-4 my-2 text-text-secondary italic">...</blockquote>`
  - `p`: `<p className="my-1.5 text-text-primary leading-relaxed">...</p>`
  - `hr`: `<hr className="border-surface-overlay my-4" />`

IMPORTANT: Do NOT render streaming text through MarkdownRenderer. Only completed assistant messages use it. StreamingText.tsx remains unchanged (plain whitespace-pre-wrap).
  </action>
  <verify>
Run `pnpm build` from apps/desktop — confirm no TypeScript errors, react-markdown + remark-gfm + react-shiki resolve correctly.
  </verify>
  <done>
CodeBlock renders syntax-highlighted code with copy button. MarkdownRenderer wraps react-markdown with GFM support and styled component overrides for all markdown elements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate MarkdownRenderer into ChatMessage for assistant text</name>
  <files>apps/desktop/src/components/ChatMessage.tsx</files>
  <action>
Update `ChatMessage.tsx`:
1. Import `MarkdownRenderer` from `./chat/MarkdownRenderer`
2. In the assistant text message branch (where `message.role === "assistant"`), replace the plain `whitespace-pre-wrap` div content `{message.content}` with `<MarkdownRenderer content={message.content} />`
3. Remove `whitespace-pre-wrap` from that div's className (markdown renderer handles its own spacing)
4. Keep the outer card structure (bg-gray-800/50, border-l-2, rounded-lg, etc.) but update colors to use design tokens: `bg-surface-elevated/50 border-l-2 border-surface-overlay`
5. While touching ChatMessage, update user message colors too: replace `bg-blue-600/20 border-blue-500` with `bg-brand-600/20 border-brand-500`
6. Update tool_call badge: replace `text-purple-400 bg-purple-400/10` with `text-brand-400 bg-brand-400/10`
7. Do NOT touch StreamingText.tsx — it remains plain text during streaming
  </action>
  <verify>
Run `pnpm build` from apps/desktop — no errors. Verify ChatMessage imports MarkdownRenderer and uses it for assistant messages.
  </verify>
  <done>
Assistant messages render full markdown with syntax highlighting. User messages and tool calls use brand tokens. Streaming text remains plain pre-wrapped text.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` in apps/desktop succeeds
- react-markdown, remark-gfm, react-shiki are in package.json
- MarkdownRenderer and CodeBlock exist in components/chat/
- ChatMessage uses MarkdownRenderer for assistant text messages
- StreamingText.tsx is unchanged (no markdown during streaming)
</verification>

<success_criteria>
Completed assistant messages render headers, lists, tables, inline code, links, and syntax-highlighted code blocks with copy buttons. Streaming text remains plain. All colors use brand design tokens.
</success_criteria>

<output>
After completion, create `.planning/phases/27-desktop-ui-overhaul/27-02-SUMMARY.md`
</output>
