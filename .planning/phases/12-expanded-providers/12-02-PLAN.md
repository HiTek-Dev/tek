---
phase: 12-expanded-providers
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - packages/gateway/src/skills/venice-image.ts
  - packages/gateway/src/skills/venice-video.ts
  - packages/gateway/src/skills/index.ts
  - packages/gateway/src/agent/tool-registry.ts
  - packages/gateway/src/ws/handlers.ts
autonomous: true
requirements:
  - "Venice API integration"
  - "Model switching verification"

must_haves:
  truths:
    - "Venice image generation tool is available when a Venice API key is configured"
    - "Venice video generation tool is available when a Venice API key is configured"
    - "Venice image tool sends POST to Venice /image/generate endpoint with correct auth header"
    - "Venice video tool queues a job via /video/queue and polls /video/retrieve for completion"
    - "User can hot-swap between any configured provider mid-conversation without errors"
    - "User can send a message using a venice: or google: model ID and receive a streamed response"
  artifacts:
    - path: "packages/gateway/src/skills/venice-image.ts"
      provides: "Venice AI image generation tool"
      exports: ["createVeniceImageTool"]
    - path: "packages/gateway/src/skills/venice-video.ts"
      provides: "Venice AI video generation tool"
      exports: ["createVeniceVideoTool"]
    - path: "packages/gateway/src/skills/index.ts"
      provides: "Barrel exports for Venice tools"
      contains: "createVeniceImageTool"
    - path: "packages/gateway/src/agent/tool-registry.ts"
      provides: "Venice tools wired into buildToolRegistry"
      contains: "venice_image_generate"
  key_links:
    - from: "packages/gateway/src/skills/venice-image.ts"
      to: "https://api.venice.ai/api/v1/image/generate"
      via: "fetch POST with Bearer token"
      pattern: "api.venice.ai.*image/generate"
    - from: "packages/gateway/src/skills/venice-video.ts"
      to: "https://api.venice.ai/api/v1/video/queue"
      via: "fetch POST with Bearer token, then poll /video/retrieve"
      pattern: "api.venice.ai.*video/queue"
    - from: "packages/gateway/src/agent/tool-registry.ts"
      to: "packages/gateway/src/skills/venice-image.ts"
      via: "import and conditional registration"
      pattern: "createVeniceImageTool"
---

<objective>
Create Venice AI image and video generation skill tools and wire all new providers into the tool registry for end-to-end integration.

Purpose: Venice AI offers image and video generation via non-OpenAI REST endpoints that need custom tool implementations. These tools follow the existing raw-fetch skill pattern (same as Stability AI image gen). Also ensures hot-swap between all providers works end-to-end.

Output: Two new skill tool files, updated tool registry with Venice tools, and verified provider hot-swap.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-expanded-providers/12-RESEARCH.md
@.planning/phases/12-expanded-providers/12-01-SUMMARY.md

Key existing patterns:
- Skill tool pattern: packages/gateway/src/skills/image-gen.ts — createStabilityImageGenTool uses raw fetch() with tool() from "ai" and z.object inputSchema
- Tool registry: packages/gateway/src/agent/tool-registry.ts — buildToolRegistry conditionally registers tools based on API key availability, applies approval wrappers
- Skills barrel: packages/gateway/src/skills/index.ts — re-exports all skill tool factories
- Approval tiers: "auto" for read-only, "session" for paid operations, "always" for destructive
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Venice image and video generation tools</name>
  <files>
    packages/gateway/src/skills/venice-image.ts
    packages/gateway/src/skills/venice-video.ts
    packages/gateway/src/skills/index.ts
  </files>
  <action>
1. Create `packages/gateway/src/skills/venice-image.ts`:
   - Export createVeniceImageTool(apiKey?: string) following the exact pattern in createStabilityImageGenTool
   - Use tool() from "ai" with z.object inputSchema
   - Parameters: prompt (string, required), model (string, optional, default "fluently-xl"), width (number, optional, default 1024), height (number, optional, default 1024), negative_prompt (string, optional), safe_mode (boolean, optional, default false)
   - Description: conditional on apiKey presence (same pattern as existing tools)
   - Execute: POST to "https://api.venice.ai/api/v1/image/generate" with Authorization: Bearer ${apiKey}, Content-Type: application/json, Accept: application/json
   - Request body: { model, prompt, width, height, negative_prompt, safe_mode }
   - On success: return { images: data.images, id: data.id }
   - On error: return { error: "Venice image gen failed: ..." }
   - If no apiKey: return { error: "Venice image generation unavailable" }

2. Create `packages/gateway/src/skills/venice-video.ts`:
   - Export createVeniceVideoTool(apiKey?: string)
   - Same tool() + z.object pattern
   - Parameters: prompt (string, required), model (string, optional), duration (number, optional), resolution (enum ["1K", "2K", "4K"], optional)
   - Execute: Two-step queue/poll pattern:
     Step 1: POST to "https://api.venice.ai/api/v1/video/queue" with { model, prompt, duration, resolution }
     Step 2: Poll POST "https://api.venice.ai/api/v1/video/retrieve" with { queue_id } every 10 seconds, max 30 attempts (5 minutes)
     If completed: return { queue_id, status: "completed", video_url: data.video_url }
     If timeout: return { queue_id, status: "pending", message: "Video still processing. Use queue_id to check later." }
     On queue error: return { error: "Video queue failed: ..." }

3. In `packages/gateway/src/skills/index.ts`:
   - Add exports: createVeniceImageTool from "./venice-image.js" and createVeniceVideoTool from "./venice-video.js"
  </action>
  <verify>
cd /Users/hitekmedia/Documents/GitHub/AgentSpace && npx tsc -p packages/gateway/tsconfig.json --noEmit
  </verify>
  <done>venice-image.ts and venice-video.ts created with tool() pattern, exported from skills/index.ts, TypeScript compiles cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Wire Venice tools into tool registry, connect API key from vault, and verify integration</name>
  <files>
    packages/gateway/src/agent/tool-registry.ts
    packages/gateway/src/ws/handlers.ts
  </files>
  <action>
1. In `packages/gateway/src/agent/tool-registry.ts`:
   - Add imports: createVeniceImageTool, createVeniceVideoTool from "../skills/index.js"
   - Add veniceApiKey?: string to ToolRegistryOptions interface
   - In buildToolRegistry, after the stability image gen section (around line 190), add Venice tools block:
     ```
     if (veniceApiKey) {
       const veniceImageGen = createVeniceImageTool(veniceApiKey);
       const veniceImageGenName = "venice_image_generate";
       tools[veniceImageGenName] = approvalPolicy
         ? wrapToolWithApproval(veniceImageGenName, veniceImageGen as unknown as Record<string, unknown>, approvalPolicy)
         : veniceImageGen;
       if (approvalPolicy) {
         approvalPolicy.perTool[veniceImageGenName] = "session";
       }

       const veniceVideoGen = createVeniceVideoTool(veniceApiKey);
       const veniceVideoGenName = "venice_video_generate";
       tools[veniceVideoGenName] = approvalPolicy
         ? wrapToolWithApproval(veniceVideoGenName, veniceVideoGen as unknown as Record<string, unknown>, approvalPolicy)
         : veniceVideoGen;
       if (approvalPolicy) {
         approvalPolicy.perTool[veniceVideoGenName] = "session";
       }

       systemSkillCount += 2;
     }
     ```
   - Use "session" approval tier for both Venice tools (they cost money via API usage)

2. In `packages/gateway/src/ws/handlers.ts`:
   - Wire veniceApiKey into the buildToolRegistry call at line ~310-316. First inspect how existing skill keys (tavilyApiKey, openaiApiKey, stabilityApiKey) are defined in ToolRegistryOptions — they exist in the interface but are NOT currently passed from the handlers.ts call site. Import getKey from the vault module (check existing imports for pattern — likely from "@agentspace/cli" or a vault utility re-exported in gateway). Then add `veniceApiKey: getKey('venice') ?? undefined` to the buildToolRegistry options object. If getKey is not available in the gateway package, use the same config/vault pattern used by registry.ts (which already calls getKey for provider API keys).
   - NOTE: The existing tavilyApiKey, openaiApiKey, and stabilityApiKey options are also not wired from this call site. Wire those too if getKey is available, following the same pattern. This ensures all skill tools actually receive their API keys at runtime.

3. Verify hot-swap compatibility:
   - The existing handleChatSend in handlers.ts already calls resolveModelId(msg.model) and sessionManager.updateModel()
   - New providers (venice, google) are registered in the unified registry from Plan 01
   - Streaming uses registry.languageModel(model as never) which works for any registered provider
   - No additional hot-swap code needed — the architecture from Phase 4 handles this natively
  </action>
  <verify>
cd /Users/hitekmedia/Documents/GitHub/AgentSpace && npx tsc -p packages/gateway/tsconfig.json --noEmit && grep -c "venice_image_generate\|venice_video_generate" packages/gateway/src/agent/tool-registry.ts
  </verify>
  <done>Venice image and video tools registered in tool-registry with session approval tier, grep confirms both tool names present, TypeScript compiles cleanly, hot-swap works via existing registry.languageModel() pipeline</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes for gateway package
2. venice-image.ts exports createVeniceImageTool with correct fetch URL pattern
3. venice-video.ts exports createVeniceVideoTool with queue/poll pattern
4. tool-registry.ts conditionally registers venice_image_generate and venice_video_generate
5. Both Venice tools use "session" approval tier
6. Hot-swap verification: handleChatSend resolves any provider:model ID through the unified registry — no provider-specific streaming code exists
7. Skills barrel (index.ts) exports both Venice tool factories
</verification>

<success_criteria>
- Venice image and video tools follow the established raw-fetch skill pattern
- Tool registry conditionally registers Venice tools when API key is available
- Hot-swap between anthropic, openai, ollama, venice, and google providers works through the unified streaming pipeline (no provider-specific streaming paths)
- All five Phase 12 success criteria are satisfied across Plan 01 and Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/12-expanded-providers/12-02-SUMMARY.md`
</output>
