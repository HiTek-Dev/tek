---
phase: 21-init-agent-onboarding-rework
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - packages/cli/src/commands/chat.ts
  - packages/cli/src/components/Chat.tsx
  - packages/cli/src/lib/gateway-client.ts
  - packages/gateway/src/ws/protocol.ts
  - packages/gateway/src/ws/handlers.ts
  - packages/gateway/src/agent/tool-registry.ts
autonomous: true
requirements:
  - "tek chat prompts for agent selection when multiple agents exist"
  - "Gateway manages identity injection and memory for the active agent"

must_haves:
  truths:
    - "tek chat --agent <id> selects a specific agent without prompting"
    - "tek chat with multiple agents shows an interactive picker"
    - "tek chat with one agent auto-selects it without prompting"
    - "tek chat with zero agents works in legacy mode (backward compatible)"
    - "Gateway uses agentId from chat.send message for identity injection"
    - "Tool registry uses agentId from message for memory tools"
  artifacts:
    - path: "packages/gateway/src/ws/protocol.ts"
      provides: "ChatSendSchema with optional agentId field"
      contains: "agentId"
    - path: "packages/gateway/src/ws/handlers.ts"
      provides: "Per-message agentId resolution instead of global config default"
      contains: "msg.agentId"
    - path: "packages/cli/src/commands/chat.ts"
      provides: "Agent selection logic with --agent flag and interactive picker"
      contains: "--agent"
  key_links:
    - from: "packages/cli/src/commands/chat.ts"
      to: "packages/cli/src/components/Chat.tsx"
      via: "agentId prop"
      pattern: "agentId"
    - from: "packages/cli/src/components/Chat.tsx"
      to: "packages/cli/src/lib/gateway-client.ts"
      via: "createChatSendMessage with agentId"
      pattern: "agentId"
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "packages/gateway/src/agent/tool-registry.ts"
      via: "options.agentId passed from msg.agentId"
      pattern: "agentId.*msg"
---

<objective>
Add agent selection to `tek chat` (--agent flag + interactive picker) and wire per-session agentId through the WS protocol so the gateway injects the correct agent's identity and memory context per chat message.

Purpose: Enable multi-agent workflows where each chat session targets a specific agent, and the gateway resolves identity files for that agent rather than always using the global default.

Output: Agent picker in chat command, agentId in WS protocol, per-message identity resolution in gateway.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-init-agent-onboarding-rework/21-RESEARCH.md
@.planning/phases/21-init-agent-onboarding-rework/21-01-SUMMARY.md
@packages/cli/src/commands/chat.ts
@packages/cli/src/components/Chat.tsx
@packages/cli/src/lib/gateway-client.ts
@packages/gateway/src/ws/protocol.ts
@packages/gateway/src/ws/handlers.ts
@packages/gateway/src/agent/tool-registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent selection to tek chat command and CLI components</name>
  <files>
    packages/cli/src/commands/chat.ts
    packages/cli/src/components/Chat.tsx
    packages/cli/src/lib/gateway-client.ts
  </files>
  <action>
1. **Update chat.ts** at `packages/cli/src/commands/chat.ts`:
   - Add `--agent <id>` option: `.option("-a, --agent <id>", "Agent to chat with")`
   - Import `loadConfig, configExists` from `@tek/core` and `Select` from `@inkjs/ui` (for agent picker)
   - Before rendering Chat, resolve the agentId:
     a. Load config. Get `agents.list` (default to `[]`).
     b. If `options.agent` is provided: try exact ID match first, then case-insensitive name match against agents list. If found, use that agent's ID. If not found, print error listing available agents and exit(1).
     c. If no `--agent` flag and agents list has 0 entries: set agentId to `undefined` (legacy mode, backward compatible).
     d. If agents list has exactly 1 entry: auto-select that agent's ID, print "Using agent: {name}".
     e. If agents list has 2+ entries: render a temporary Ink component with a `Select` picker showing agent names. On select, store the agentId. Use a Promise wrapper to await the selection before rendering Chat.
   - Pass the resolved `agentId` to the Chat component as a prop.

   For the agent picker, create a small inline component or use a Promise-based pattern:
   ```typescript
   async function pickAgent(agents: AgentDefinition[]): Promise<string> {
     return new Promise((resolve) => {
       const { unmount } = render(
         React.createElement(AgentPicker, {
           agents,
           onSelect: (id: string) => { unmount(); resolve(id); }
         })
       );
     });
   }
   ```

   Create a simple `AgentPicker` component (can be in the same file or a small separate file) that renders a `Select` with agent options formatted as `{name} — {purpose || description || id}`.

2. **Update Chat.tsx** at `packages/cli/src/components/Chat.tsx`:
   - Add `agentId?: string` to `ChatProps` interface.
   - In the `useChat` hook call or wherever `createChatSendMessage` is called, pass `agentId` through.
   - Find where `createChatSendMessage(content, { sessionId, model })` is called and add `agentId` to the options: `createChatSendMessage(content, { sessionId, model, agentId })`.

3. **Update gateway-client.ts** at `packages/cli/src/lib/gateway-client.ts`:
   - Update `createChatSendMessage` signature to accept `agentId` in the opts:
     ```typescript
     export function createChatSendMessage(
       content: string,
       opts?: { sessionId?: string; model?: string; agentId?: string },
     ): ClientMessage { ... }
     ```
   - The spread `...opts` already handles passing it through to the message object.

   Build with `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/cli/tsconfig.json --noEmit` to verify.
  </action>
  <verify>
    Run `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/cli/tsconfig.json --noEmit` — must pass.
    Grep chat.ts for "--agent" — must find the option definition.
    Grep Chat.tsx for "agentId" — must find prop and usage.
    Grep gateway-client.ts for "agentId" — must find in createChatSendMessage.
  </verify>
  <done>
    `tek chat --agent <id>` resolves agent from config. Multi-agent picker shown when needed. agentId flows from chat command through Chat component to createChatSendMessage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add agentId to WS protocol and wire gateway per-message identity</name>
  <files>
    packages/gateway/src/ws/protocol.ts
    packages/gateway/src/ws/handlers.ts
    packages/gateway/src/agent/tool-registry.ts
  </files>
  <action>
1. **Update protocol.ts** at `packages/gateway/src/ws/protocol.ts`:
   - Add `agentId: z.string().optional()` to `ChatSendSchema`:
     ```typescript
     const ChatSendSchema = z.object({
       type: z.literal("chat.send"),
       id: z.string(),
       sessionId: z.string().optional(),
       content: z.string(),
       model: z.string().optional(),
       agentId: z.string().optional(),
     });
     ```

2. **Update handlers.ts** at `packages/gateway/src/ws/handlers.ts`:
   - Find the line `const agentId = loadConfig()?.agents?.defaultAgentId ?? "default";` (around line 247).
   - Replace with: `const agentId = msg.agentId ?? loadConfig()?.agents?.defaultAgentId ?? "default";`
   - This uses the per-message agentId when provided, falling back to config default, falling back to "default".
   - Also check if the tool registry needs to be rebuilt when agentId changes. Currently the tool registry is cached on `connState.tools`. If the agentId from the message differs from the agentId used to build the cached tools, the tools should be rebuilt. Add logic:
     ```typescript
     // Invalidate cached tools if agentId changed
     if (connState.tools && connState.lastAgentId !== agentId) {
       connState.tools = undefined;
     }
     connState.lastAgentId = agentId;
     ```
     Add `lastAgentId?: string` to the ConnectionState type (in the file where ConnectionState is defined — likely `packages/gateway/src/ws/server.ts` or similar).

3. **Update tool-registry.ts** at `packages/gateway/src/agent/tool-registry.ts`:
   - Find where `agentConfig?.agents?.defaultAgentId` is read (around line 277).
   - The `buildToolRegistry` function likely has an `options` parameter. Add `agentId?: string` to the options interface if not already present.
   - Replace the hardcoded config read:
     ```typescript
     // OLD:
     const agentConfig = loadConfig();
     const currentAgentId = agentConfig?.agents?.defaultAgentId;

     // NEW:
     const currentAgentId = options.agentId ?? loadConfig()?.agents?.defaultAgentId;
     ```
   - In handlers.ts, where `buildToolRegistry` is called, pass `agentId` in the options object.

   Build gateway: `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/gateway/tsconfig.json --noEmit` to verify.
  </action>
  <verify>
    Run `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/gateway/tsconfig.json --noEmit` — must pass.
    Grep protocol.ts for "agentId" — must find in ChatSendSchema.
    Grep handlers.ts for "msg.agentId" — must find the per-message resolution.
    Grep tool-registry.ts for "options.agentId" — must find the parameterized resolution.
  </verify>
  <done>
    ChatSendSchema accepts optional agentId. Gateway resolves agentId from message (with config fallback). Tool registry accepts agentId as parameter. Cached tools invalidate when agentId changes between messages.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -p packages/cli/tsconfig.json --noEmit` passes
2. `npx tsc -p packages/gateway/tsconfig.json --noEmit` passes
3. `tek chat --agent` flag exists in help output
4. ChatSendSchema in protocol.ts includes agentId field
5. handlers.ts uses msg.agentId with config fallback
6. tool-registry.ts accepts agentId from options, not just global config
</verification>

<success_criteria>
- Agent selection works: --agent flag, auto-select for single agent, picker for multiple
- Zero agents = backward compatible legacy mode
- Gateway uses per-message agentId for identity injection and memory tool creation
- Tool registry cache invalidated when agent changes
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-init-agent-onboarding-rework/21-02-SUMMARY.md`
</output>
