---
phase: 21-init-agent-onboarding-rework
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/config/schema.ts
  - packages/cli/src/components/Onboarding.tsx
  - packages/cli/src/commands/init.ts
  - packages/cli/src/commands/onboard.ts
  - packages/cli/src/components/AgentOnboarding.tsx
  - packages/cli/src/index.ts
autonomous: true
requirements:
  - "Separate app-level init from agent onboarding"
  - "tek onboard creates named agent with model, workspace scope, purpose, personality"
  - "tek init handles keys and global config only"

must_haves:
  truths:
    - "tek init no longer asks for agent name, personality preset, or workspace directory"
    - "tek init ends with a prompt to run tek onboard"
    - "tek onboard creates a named agent entry in config.agents.list"
    - "tek onboard writes agent identity files to per-agent directory"
    - "tek onboard sets the first created agent as defaultAgentId"
    - "tek onboard refuses to run if tek init has not been completed"
  artifacts:
    - path: "packages/cli/src/commands/onboard.ts"
      provides: "tek onboard command entry point"
      min_lines: 40
    - path: "packages/cli/src/components/AgentOnboarding.tsx"
      provides: "Agent creation wizard UI"
      min_lines: 100
    - path: "packages/core/src/config/schema.ts"
      provides: "Extended AgentDefinitionSchema with workspaceDir, purpose, personalityPreset, createdAt"
      contains: "workspaceDir"
  key_links:
    - from: "packages/cli/src/commands/onboard.ts"
      to: "packages/cli/src/components/AgentOnboarding.tsx"
      via: "React.createElement render"
      pattern: "AgentOnboarding"
    - from: "packages/cli/src/index.ts"
      to: "packages/cli/src/commands/onboard.ts"
      via: "program.addCommand"
      pattern: "onboardCommand"
    - from: "packages/cli/src/commands/onboard.ts"
      to: "@tek/core saveConfig"
      via: "config.agents.list push + saveConfig"
      pattern: "saveConfig"
---

<objective>
Separate tek init from agent onboarding by slimming Onboarding.tsx (remove hatch-ask, hatch-name, workspace steps) and creating a new `tek onboard` command with AgentOnboarding.tsx that handles agent name, personality preset, workspace scope, purpose description, and model override.

Purpose: Cleanly separate app infrastructure setup (API keys, security mode, model selection) from per-agent identity creation (name, personality, workspace, purpose). This enables users to create multiple agents independently after initial setup.

Output: Slimmed init flow, new `tek onboard` command, extended AgentDefinitionSchema.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-init-agent-onboarding-rework/21-RESEARCH.md
@packages/core/src/config/schema.ts
@packages/cli/src/components/Onboarding.tsx
@packages/cli/src/commands/init.ts
@packages/cli/src/index.ts
@packages/db/src/memory/ensure-memory.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Slim tek init and extend AgentDefinitionSchema</name>
  <files>
    packages/core/src/config/schema.ts
    packages/cli/src/components/Onboarding.tsx
    packages/cli/src/commands/init.ts
  </files>
  <action>
1. **Extend AgentDefinitionSchema** in `packages/core/src/config/schema.ts`:
   Add these optional fields to the existing schema:
   - `workspaceDir: z.string().optional()` — per-agent workspace directory
   - `personalityPreset: z.string().optional()` — which preset was used
   - `purpose: z.string().optional()` — agent purpose description
   - `createdAt: z.string().datetime().optional()` — creation timestamp
   Export the updated type.

2. **Strip agent-specific steps from Onboarding.tsx** in `packages/cli/src/components/Onboarding.tsx`:
   - Remove `"hatch-ask"`, `"hatch-name"`, and `"workspace"` from the `OnboardingStep` type union
   - Remove all JSX blocks that render these steps (the personality preset picker, agent name input, user display name input, workspace directory input)
   - Remove state variables: `personalityPreset`, `agentName`, `userDisplayName`, `workspaceDir`, `hatchSubStep`
   - Remove these fields from `OnboardingResult`: `personalityPreset`, `agentName`, `userDisplayName`, `workspaceDir`
   - Remove from `existingConfig` props: `agentName`, `userDisplayName`, `workspaceDir`
   - Update step transitions: after the last model alias step (or model-select if no aliases), go directly to `"summary"` instead of `"hatch-ask"`
   - Update the summary step to only show app-level config (security mode, providers, default model, aliases)
   - In the "done" step, add text: `Run '${CLI_COMMAND} onboard' to create your first agent.`

3. **Update init.ts** in `packages/cli/src/commands/init.ts`:
   - Remove all agent-specific persistence logic: personality preset application, USER.md writing, SOUL.md agent name injection
   - Remove `agentName`, `userDisplayName`, `workspaceDir` from the saved AppConfig object
   - Remove the `ensureMemoryFile` and `applyPersonalityPreset` imports and calls
   - Remove the `resolve`, `homedir`, `writeFileSync`, `existsSync`, `readFileSync`, `mkdirSync` imports that were only used for identity file writing
   - Remove `existingConfig` props that are no longer in OnboardingResult (`agentName`, `userDisplayName`, `workspaceDir`)
   - Keep: security mode, API keys, telegram token, model config, audit event, auth token generation

  Build with `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/core/tsconfig.json --noEmit && npx tsc -p packages/cli/tsconfig.json --noEmit` to verify no type errors.
  </action>
  <verify>
    Run `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/core/tsconfig.json --noEmit && npx tsc -p packages/cli/tsconfig.json --noEmit` — must pass with no errors.
    Grep Onboarding.tsx for "hatch" and "workspace" — should find zero matches (excluding comments about the migration).
  </verify>
  <done>
    AgentDefinitionSchema has workspaceDir, purpose, personalityPreset, createdAt fields. Onboarding.tsx has no agent-specific steps. init.ts writes no identity files and saves no agent-specific config fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tek onboard command and AgentOnboarding component</name>
  <files>
    packages/cli/src/commands/onboard.ts
    packages/cli/src/components/AgentOnboarding.tsx
    packages/cli/src/index.ts
  </files>
  <action>
1. **Create AgentOnboarding.tsx** at `packages/cli/src/components/AgentOnboarding.tsx`:
   An Ink component with these steps (state machine pattern matching Onboarding.tsx):

   - **agent-name**: TextInput for agent name. Default suggestion based on `--name` option if provided.
   - **user-display-name**: TextInput for user's display name. Skip if config already has `userDisplayName` set. Ask "What should {agentName} call you?"
   - **personality-preset**: Select with options: Professional, Friendly, Technical, Opinionated, Custom, Skip. Same presets as Phase 15.
   - **model-override**: Optional. Select from available models (use `buildModelOptions` from `../lib/models.js`). Add a "Use global default" option. If selected, store as agent's model override.
   - **workspace-scope**: Select with two options: "Full Control — Agent can access the entire system" (value: "full") and "Limited Control — Agent restricted to a workspace directory" (value: "limited").
   - **workspace-dir**: Only shown if workspace-scope is "limited". TextInput for workspace directory path. Default: `~/{agent-name-slugified}-workspace`.
   - **purpose**: TextInput for agent purpose description. Prompt: "Describe this agent's purpose in a few words (e.g., 'coding assistant', 'research helper')".
   - **summary**: Show all configured values.
   - **done**: Display success message with agent name.

   Interface `AgentOnboardingResult`:
   ```typescript
   {
     agentName: string;
     userDisplayName?: string;
     personalityPreset: string;
     modelOverride?: string;
     accessMode: "full" | "limited";
     workspaceDir?: string;
     purpose?: string;
   }
   ```

   Props: `{ onComplete: (result: AgentOnboardingResult) => void; initialName?: string; configuredProviders?: string[] }`

   Use the same UI patterns as Onboarding.tsx: `Select` for choices, `TextInput` for freeform, `Box`/`Text` for layout. Use `key` prop on TextInput instances to force remount between steps (Phase 15 pattern).

2. **Create onboard.ts** at `packages/cli/src/commands/onboard.ts`:
   ```typescript
   export const onboardCommand = new Command("onboard")
     .description("Create and configure a new agent")
     .option("-n, --name <name>", "Agent name")
     .action(async (options) => { ... });
   ```

   In the action:
   - Check `configExists()` — if false, print error "Run 'tek init' first to set up API keys and global config." and exit(1).
   - Load existing config to get `configuredProviders` list from vault's `listProviders()`.
   - Render `AgentOnboarding` component with `initialName` from `--name` option.
   - On complete callback:
     a. Generate agent ID: lowercase the name, replace spaces/special chars with hyphens, trim (same pattern as AgentsPage.tsx in desktop: `name.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "")`).
     b. Apply personality preset if not "custom" and not "skip": call `applyPersonalityPreset(preset, agentId)` from `@tek/db`. If "custom", call `ensureMemoryFile("BOOTSTRAP.md", "BOOTSTRAP.md", agentId)`.
     c. Write identity files:
        - If `result.userDisplayName`: write USER.md to agent's memory dir (`~/.config/tek/agents/{agentId}/USER.md`) with `# About the User\n\nName: {userDisplayName}\n`.
        - If `result.agentName`: write SOUL.md header with agent name to agent's dir (same pattern as current init.ts but targeting agent dir).
     d. Build `AgentDefinition` object:
        ```typescript
        { id: agentId, name: result.agentName, model: result.modelOverride, description: result.purpose, accessMode: result.accessMode, workspaceDir: result.workspaceDir ? resolvePath(result.workspaceDir) : undefined, personalityPreset: result.personalityPreset, purpose: result.purpose, createdAt: new Date().toISOString() }
        ```
     e. Load config, push agent to `config.agents.list` (initialize to `[]` if undefined), set `config.agents.defaultAgentId` to agentId if this is the first agent. Also set `config.userDisplayName` if provided and not already set. Save config.
     f. If `result.userDisplayName` provided, also set `config.userDisplayName` on the global config (so it persists for future agents).

3. **Register in index.ts** at `packages/cli/src/index.ts`:
   - Import `onboardCommand` from `./commands/onboard.js`
   - Add `program.addCommand(onboardCommand)` after the existing commands

   Build with `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/cli/tsconfig.json --noEmit` to verify no type errors.
  </action>
  <verify>
    Run `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc -p packages/cli/tsconfig.json --noEmit` — must pass with no errors.
    Verify `packages/cli/src/commands/onboard.ts` exists and imports AgentOnboarding.
    Verify `packages/cli/src/index.ts` includes `onboardCommand`.
    Grep `AgentOnboarding.tsx` for all step names: agent-name, user-display-name, personality-preset, model-override, workspace-scope, workspace-dir, purpose, summary, done.
  </verify>
  <done>
    `tek onboard` command exists, registered in CLI. AgentOnboarding.tsx implements the full agent creation wizard. Running `tek onboard` writes agent to config.agents.list, creates agent identity directory with personality files, and sets defaultAgentId on first agent creation.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -p packages/core/tsconfig.json --noEmit` passes
2. `npx tsc -p packages/cli/tsconfig.json --noEmit` passes
3. `grep -r "hatch" packages/cli/src/components/Onboarding.tsx` returns no matches
4. `grep -r "workspace" packages/cli/src/components/Onboarding.tsx` returns no matches (except possibly in comments)
5. `packages/cli/src/commands/onboard.ts` exists with `onboardCommand` export
6. `packages/cli/src/components/AgentOnboarding.tsx` exists with step state machine
7. `packages/cli/src/index.ts` includes `onboardCommand`
</verification>

<success_criteria>
- tek init Onboarding.tsx is stripped of agent-specific steps (no hatch, no workspace, no agent name)
- tek onboard command exists and creates agents with full wizard flow
- AgentDefinitionSchema extended with workspaceDir, purpose, personalityPreset, createdAt
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-init-agent-onboarding-rework/21-01-SUMMARY.md`
</output>
