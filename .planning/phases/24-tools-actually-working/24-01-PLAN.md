---
phase: 24-tools-actually-working
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/tools/filesystem.ts
  - packages/gateway/src/agent/tool-registry.ts
autonomous: true
requirements:
  - SC-1
  - SC-4

must_haves:
  truths:
    - "Agent can write files to workspace on first use without ENOENT errors"
    - "write_file to nested paths (e.g. subdir/file.txt) creates parent directories automatically"
    - "Workspace directory is ensured before any tool attempts to use it"
  artifacts:
    - path: "packages/gateway/src/tools/filesystem.ts"
      provides: "write_file with parent directory creation via mkdir"
      contains: "mkdir(dirname(path)"
    - path: "packages/gateway/src/agent/tool-registry.ts"
      provides: "Workspace directory auto-creation at tool registry build time"
      contains: "mkdir(workspaceDir"
  key_links:
    - from: "packages/gateway/src/agent/tool-registry.ts"
      to: "packages/gateway/src/tools/filesystem.ts"
      via: "workspaceDir passed to createFilesystemTools"
      pattern: "createFilesystemTools\\(securityMode, workspaceDir\\)"
---

<objective>
Fix workspace directory never being created (Root Cause 1). The config stores a workspaceDir path but mkdir is never called, causing ENOENT on first file write. Also, write_file doesn't create parent directories within the workspace.

Purpose: Agent file operations fail silently on first use because the workspace directory doesn't exist on disk.
Output: Workspace directory auto-created at tool registry build time; write_file creates parent dirs before writing.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/gateway/src/tools/filesystem.ts
@packages/gateway/src/agent/tool-registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mkdir to write_file and workspace ensurance to tool-registry</name>
  <files>packages/gateway/src/tools/filesystem.ts, packages/gateway/src/agent/tool-registry.ts</files>
  <action>
In `packages/gateway/src/tools/filesystem.ts`:
1. Add `mkdir` to the imports from `node:fs/promises` (alongside readFile, writeFile, readdir, unlink)
2. Add `dirname` to the imports from `node:path` (alongside join, resolve, isAbsolute)
3. In the `write_file` tool's `execute` function, add `await mkdir(dirname(path), { recursive: true });` AFTER the `checkWorkspace` call and BEFORE the `writeFile` call. This ensures parent directories exist for nested paths like "subdir/file.txt".

In `packages/gateway/src/agent/tool-registry.ts`:
1. Add `import { mkdir } from "node:fs/promises";` at the top of the file
2. At the start of the `buildToolRegistry` function body (after destructuring options), add:
```typescript
// Ensure workspace directory exists on disk (config stores path but never creates it)
if (workspaceDir) {
  await mkdir(workspaceDir, { recursive: true });
}
```
This goes BEFORE the filesystem tools are created (before `const fsTools = createFilesystemTools(...)`).

Note: `mkdir({ recursive: true })` is idempotent â€” safe to call multiple times, handles "already exists" gracefully.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` to verify TypeScript compiles without errors. Grep for `mkdir` in both files to confirm the changes are present.
  </verify>
  <done>
filesystem.ts write_file calls `mkdir(dirname(path), { recursive: true })` before writeFile. tool-registry.ts calls `mkdir(workspaceDir, { recursive: true })` at the start of buildToolRegistry when workspaceDir is set. Both files compile cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/gateway/tsconfig.json` passes
2. `grep -n "mkdir" packages/gateway/src/tools/filesystem.ts` shows mkdir import and usage in write_file
3. `grep -n "mkdir" packages/gateway/src/agent/tool-registry.ts` shows mkdir import and workspace creation
</verification>

<success_criteria>
- write_file creates parent directories before writing (no ENOENT for nested paths)
- Workspace directory is auto-created when tool registry is built (no ENOENT on first use)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/24-tools-actually-working/24-01-SUMMARY.md`
</output>
