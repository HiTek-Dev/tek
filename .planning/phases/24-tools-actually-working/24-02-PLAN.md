---
phase: 24-tools-actually-working
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/gateway/src/agent/tool-loop.ts
  - packages/gateway/src/ws/handlers.ts
autonomous: true
requirements:
  - SC-2
  - SC-3
  - SC-5

must_haves:
  truths:
    - "Agent remembers conversation history across tool-using turns (no re-introduction)"
    - "When all tools fail, agent responds with error explanation instead of going silent"
    - "Agent tool loop saves assistant response to session after tool execution completes"
  artifacts:
    - path: "packages/gateway/src/agent/tool-loop.ts"
      provides: "Text accumulation from text-delta events and return of collected text; fallback text when empty"
      contains: "fullText"
    - path: "packages/gateway/src/ws/handlers.ts"
      provides: "Session persistence of assistant response after agent loop"
      contains: "sessionManager.addMessage"
  key_links:
    - from: "packages/gateway/src/agent/tool-loop.ts"
      to: "packages/gateway/src/ws/handlers.ts"
      via: "runAgentLoop returns Promise<string> with collected text"
      pattern: "runAgentLoop.*Promise<string>"
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "sessionManager"
      via: "addMessage call after agent loop completes"
      pattern: "sessionManager\\.addMessage.*assistant.*agentResponse"
---

<objective>
Fix agent tool loop not saving assistant responses to session history (Root Cause 2) and tool failures causing silent agent (Root Cause 3). The agent re-introduces itself every turn because prior responses aren't persisted to session. When all tools fail, the agent produces zero text deltas and the user sees an empty response.

Purpose: Agent conversation continuity and error recovery — the two most user-visible bugs in tool-using chat sessions.
Output: Agent loop returns collected text, handler persists it, fallback text sent when agent produces no output.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/gateway/src/agent/tool-loop.ts
@packages/gateway/src/ws/handlers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make runAgentLoop accumulate text and return it with fallback</name>
  <files>packages/gateway/src/agent/tool-loop.ts</files>
  <action>
Modify `runAgentLoop` in `packages/gateway/src/agent/tool-loop.ts`:

1. **Change return type** from `Promise<void>` to `Promise<string>`. Update the function signature.

2. **Add text accumulation variable** at the start of the try block (before `const result = streamText(...)`):
```typescript
let fullText = "";
```

3. **Accumulate text in the text-delta case** — add `fullText += part.text;` right after the existing `transport.send(...)` call in the `case "text-delta"` block (or before it, either works).

4. **Add fallback text after the fullStream loop** — after the `for await (const part of result.fullStream)` loop completes (still inside the try block), add:
```typescript
// Guarantee a response when agent produced no text (e.g. all tools failed)
if (!fullText || fullText.trim().length === 0) {
  const fallback = "I attempted to use tools to help with your request, but encountered errors. Could you try rephrasing or providing more details?";
  transport.send({
    type: "chat.stream.delta",
    requestId,
    delta: fallback,
  });
  fullText = fallback;
}
```

5. **Return fullText** — add `return fullText;` at the end of the try block (after the fallback check).

6. **Return empty string in catch block** — after the existing error handling in the catch block, add `return "";` at the end.

The function should now return the accumulated text in all code paths.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` to verify TypeScript compiles. Grep for `fullText` and `Promise<string>` in tool-loop.ts.
  </verify>
  <done>
runAgentLoop returns Promise<string> with the accumulated text from all text-delta events. When the agent produces no text (empty fullText), a fallback message is sent as a delta and returned. The catch block returns empty string.
  </done>
</task>

<task type="auto">
  <name>Task 2: Persist agent response to session history in handlers</name>
  <files>packages/gateway/src/ws/handlers.ts</files>
  <action>
Modify `handleChatSend` in `packages/gateway/src/ws/handlers.ts`:

1. **Capture the return value** from `runAgentLoop`. In the agent mode branch (around line 431), change:
```typescript
await runAgentLoop({
```
to:
```typescript
const agentResponse = await runAgentLoop({
```

2. **Add session persistence after the agent loop** — after the `await runAgentLoop(...)` call completes (still inside the try block, right after the closing `});`), add:
```typescript
// Persist assistant message to session (matches streamToClient pattern)
if (agentResponse) {
  sessionManager.addMessage(sessionId, "assistant", agentResponse);
}
```

3. **Do the same in `handlePreflightApproval`** — the preflight handler also calls `runAgentLoop` (around line 844). Apply the same two changes:
   - Capture: `const agentResponse = await runAgentLoop({`
   - Persist: add `if (agentResponse) { sessionManager.addMessage(sessionId, "assistant", agentResponse); }` after the agent loop call, inside the try block.

This matches the existing pattern from `streamToClient` (line 200) where `sessionManager.addMessage(sessionId, "assistant", fullResponse)` is called after streaming completes.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/gateway/tsconfig.json` to verify TypeScript compiles. Grep for `agentResponse` and `addMessage.*assistant.*agentResponse` in handlers.ts to confirm persistence wiring.
  </verify>
  <done>
Both `handleChatSend` and `handlePreflightApproval` capture the text returned from `runAgentLoop` and call `sessionManager.addMessage(sessionId, "assistant", agentResponse)` to persist it. Agent conversation history now includes assistant responses from tool-using turns.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/gateway/tsconfig.json` passes
2. `grep -n "fullText" packages/gateway/src/agent/tool-loop.ts` shows text accumulation and fallback
3. `grep -n "Promise<string>" packages/gateway/src/agent/tool-loop.ts` shows updated return type
4. `grep -n "agentResponse" packages/gateway/src/ws/handlers.ts` shows capture and persistence in both handlers
5. `grep -n "addMessage.*assistant" packages/gateway/src/ws/handlers.ts` shows persistence in streamToClient AND agent loop paths
</verification>

<success_criteria>
- runAgentLoop returns collected text as Promise<string>
- Agent responses are persisted to session history after tool-using turns
- Empty agent responses trigger a fallback text delta visible to the user
- TypeScript compiles without errors
- Both handleChatSend and handlePreflightApproval persist agent responses
</success_criteria>

<output>
After completion, create `.planning/phases/24-tools-actually-working/24-02-SUMMARY.md`
</output>
