---
phase: 22-agent-first-contact-dashboard-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/config/schema.ts
  - packages/db/src/memory/agent-resolver.ts
  - packages/db/src/memory/soul-manager.ts
  - packages/db/src/memory/identity-manager.ts
  - packages/gateway/src/ws/handlers.ts
  - packages/gateway/src/agent/tool-registry.ts
  - packages/gateway/src/session/manager.ts
  - packages/cli/src/commands/onboard.ts
  - packages/cli/src/commands/chat.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "No 'default' string sentinel appears as agent ID in any runtime code path"
    - "Undefined/empty agentId falls back to global memory directory (backward compat)"
    - "tek chat with zero agents prompts user to run tek onboard"
    - "Existing single-agent setups continue working without migration"
    - "tek onboard sets first agent as defaultAgentId"
  artifacts:
    - path: "packages/core/src/config/schema.ts"
      provides: "AgentsConfigSchema with empty string default for defaultAgentId"
      contains: 'defaultAgentId: z.string().default("")'
    - path: "packages/db/src/memory/agent-resolver.ts"
      provides: "Cascade resolution without 'default' sentinel"
      contains: "!agentId"
    - path: "packages/gateway/src/ws/handlers.ts"
      provides: "agentId resolution without 'default' fallback"
      contains: "msg.agentId"
  key_links:
    - from: "packages/gateway/src/ws/handlers.ts"
      to: "packages/db/src/memory/agent-resolver.ts"
      via: "agentId passed to identity resolution"
      pattern: "agentId.*undefined"
    - from: "packages/cli/src/commands/chat.ts"
      to: "packages/cli/src/commands/onboard.ts"
      via: "zero-agent detection prompts onboard"
      pattern: "tek onboard"
---

<objective>
Remove the "default" agent sentinel value from the entire codebase. Replace all `=== "default"` checks with falsy checks (`!agentId`). Undefined/empty agentId falls back to global memory directory for backward compatibility. Zero-agent state in tek chat prompts the user to run tek onboard.

Purpose: Only user-created agents from `tek onboard` should appear in listings. The "default" agent concept was a scaffold for single-agent setups that is now replaced by explicit agent onboarding.

Output: 9 files modified to remove "default" sentinel, backward-compatible fallback preserved.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-agent-first-contact-dashboard-polish/22-RESEARCH.md
@packages/core/src/config/schema.ts
@packages/db/src/memory/agent-resolver.ts
@packages/db/src/memory/soul-manager.ts
@packages/db/src/memory/identity-manager.ts
@packages/gateway/src/ws/handlers.ts
@packages/gateway/src/agent/tool-registry.ts
@packages/gateway/src/session/manager.ts
@packages/cli/src/commands/onboard.ts
@packages/cli/src/commands/chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove "default" sentinel from config schema and db layer</name>
  <files>
    packages/core/src/config/schema.ts
    packages/db/src/memory/agent-resolver.ts
    packages/db/src/memory/soul-manager.ts
    packages/db/src/memory/identity-manager.ts
  </files>
  <action>
1. In `packages/core/src/config/schema.ts` (line 58):
   - Change `defaultAgentId: z.string().default("default")` to `defaultAgentId: z.string().default("")`
   - This means new configs start with no default agent; onboard sets it to the first agent's ID

2. In `packages/db/src/memory/agent-resolver.ts`:
   - Line 29: Change `if (agentId && agentId !== "default")` to `if (agentId)` in `resolveIdentityFile()`
   - Line 51: Change `if (!agentId || agentId === "default")` to `if (!agentId)` in `resolveAgentDir()`
   - Update the JSDoc comment on line 48 to say "Returns the global memory directory when no agentId is provided" (remove mention of "default agent")

3. In `packages/db/src/memory/soul-manager.ts`:
   - Line 27: Change `if (agentId && agentId !== "default")` to `if (agentId)` in `loadSoul()`
   - Update the JSDoc comment on line 22 to remove "default" mention

4. In `packages/db/src/memory/identity-manager.ts`:
   - Line 26: Change `if (agentId && agentId !== "default")` to `if (agentId)` in `loadIdentity()`
   - Line 43: Change `if (agentId && agentId !== "default")` to `if (agentId)` in `loadStyle()`

Note: Do NOT change SQL defaults in schema/sessions.ts or connection.ts -- existing database rows may have "default" and that's fine. The SQL default is for database-level fallback, not application logic.
  </action>
  <verify>
TypeScript compiles for core: `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc --noEmit -p packages/core/tsconfig.json 2>&1 | head -10`

TypeScript compiles for db: `npx tsc --noEmit -p packages/db/tsconfig.json 2>&1 | head -10`

Verify no remaining "default" sentinel in modified files:
`grep -n '"default"' packages/core/src/config/schema.ts packages/db/src/memory/agent-resolver.ts packages/db/src/memory/soul-manager.ts packages/db/src/memory/identity-manager.ts`
  </verify>
  <done>
Config schema defaults to empty string for defaultAgentId. All db layer identity resolution uses falsy checks (`!agentId`) instead of `=== "default"` comparisons. Global memory directory remains the fallback for undefined agentId.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove "default" sentinel from gateway, session manager, and CLI</name>
  <files>
    packages/gateway/src/ws/handlers.ts
    packages/gateway/src/agent/tool-registry.ts
    packages/gateway/src/session/manager.ts
    packages/cli/src/commands/onboard.ts
    packages/cli/src/commands/chat.ts
  </files>
  <action>
1. In `packages/gateway/src/ws/handlers.ts`:
   - Line 247: Change `const agentId = msg.agentId ?? loadConfig()?.agents?.defaultAgentId ?? "default"` to `const agentId = msg.agentId || loadConfig()?.agents?.defaultAgentId || undefined`
     - Use `||` not `??` so empty string ("") from config also falls through to undefined
   - Line 298: Change `sessionManager.create("default", requestedModel)` to `sessionManager.create(agentId, requestedModel)` — pass the resolved agentId instead of hardcoded "default"

2. In `packages/gateway/src/agent/tool-registry.ts`:
   - Line 278: Find any `"default"` check and replace with falsy check. If the pattern is `agentId === "default"` change to `!agentId`.

3. In `packages/gateway/src/session/manager.ts`:
   - Line 23: Change `create(agentId: string = "default", model?: string)` to `create(agentId?: string, model?: string)`
   - In the session key format, use `agentId ?? "global"` for the transparent key prefix so existing key format is preserved: `agent:${agentId ?? "global"}:${id}`

4. In `packages/cli/src/commands/onboard.ts`:
   - Line 128: Change `config.agents = { list: [], defaultAgentId: "default" }` to `config.agents = { list: [], defaultAgentId: "" }`
   - Line 135: Change `config.agents.defaultAgentId === "default"` to `!config.agents.defaultAgentId` — set first agent as default when no default is configured

5. In `packages/cli/src/commands/chat.ts`:
   - Find the `resolveAgentId` function or equivalent zero-agents handling
   - When agents list is empty (length === 0), instead of returning undefined for legacy mode, print a message: `"No agents configured. Run 'tek onboard' to create your first agent."` and exit the process (`process.exit(0)`)
   - This replaces the silent fallback to legacy/global mode with a clear prompt to onboard

Note: This is a controlled migration. Existing users with "default" in their config will get empty string on next save. The db layer's falsy check handles both "default" (from old configs read before re-save) and "" (from new configs). The key insight: `"default"` is truthy but `""` is falsy, and the old `=== "default"` guards prevented cascade resolution. Now `"default"` will be treated as a valid agent ID (which is fine -- it just won't match any real agent directory, so cascade falls through to shared/global).
  </action>
  <verify>
TypeScript compiles for gateway: `cd /Users/hitekmedia/Documents/GitHub/tek && npx tsc --noEmit -p packages/gateway/tsconfig.json 2>&1 | head -20`

TypeScript compiles for cli: `npx tsc --noEmit -p packages/cli/tsconfig.json 2>&1 | head -20`

Verify no remaining hardcoded "default" agent sentinel:
`grep -rn '"default"' packages/gateway/src/ws/handlers.ts packages/gateway/src/session/manager.ts packages/cli/src/commands/onboard.ts | grep -v "// " | grep -v "default(" | grep -v "defaultModel" | grep -v "defaultAgentId"`
  </verify>
  <done>
Gateway resolves agentId without "default" fallback. Session manager accepts optional agentId. CLI onboard initializes defaultAgentId as empty string and sets first agent. tek chat with zero agents prompts user to run tek onboard instead of silently falling back to legacy mode.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn '=== "default"' packages/core/ packages/db/src/memory/ packages/gateway/src/ packages/cli/src/` returns no matches in modified files
2. `grep -n 'defaultAgentId' packages/core/src/config/schema.ts` shows empty string default
3. All packages compile: core, db, gateway, cli
4. Backward compatibility: undefined agentId still resolves to global memory directory
</verification>

<success_criteria>
- No "default" string sentinel used as agent ID in application logic
- Config schema defaults to empty string
- tek chat with zero agents shows "Run tek onboard" message
- tek onboard sets first created agent as defaultAgentId
- Existing users with agents in global memory dir still work (undefined agentId fallback)
- Session creation accepts optional agentId
</success_criteria>

<output>
After completion, create `.planning/phases/22-agent-first-contact-dashboard-polish/22-02-SUMMARY.md`
</output>
