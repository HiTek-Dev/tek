---
phase: 22-agent-first-contact-dashboard-polish
plan: 03
type: execute
wave: 2
depends_on: ["02"]
files_modified:
  - apps/desktop/src/lib/gateway-client.ts
  - apps/desktop/src/lib/files.ts
  - apps/desktop/src/hooks/useChat.ts
  - apps/desktop/src/hooks/useIdentityFiles.ts
  - apps/desktop/src/stores/app-store.ts
  - apps/desktop/src/pages/ChatPage.tsx
  - apps/desktop/src/pages/AgentsPage.tsx
  - apps/desktop/src/components/Layout.tsx
  - apps/desktop/src/components/Sidebar.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "Desktop chat sends agentId in every chat.send message"
    - "Agent selector dropdown in chat header shows configured agents"
    - "No DEFAULT_AGENT constant or 'default' card in agents page"
    - "Dashboard layout has consistent padding and spacing"
    - "Agents page shows empty state when no agents exist"
  artifacts:
    - path: "apps/desktop/src/lib/gateway-client.ts"
      provides: "agentId in createChatSendMessage opts"
      contains: "agentId"
    - path: "apps/desktop/src/pages/ChatPage.tsx"
      provides: "Agent selector dropdown in chat header"
      contains: "selectedAgent"
    - path: "apps/desktop/src/pages/AgentsPage.tsx"
      provides: "Agents list without DEFAULT_AGENT constant"
    - path: "apps/desktop/src/components/Layout.tsx"
      provides: "Content area with proper spacing"
  key_links:
    - from: "apps/desktop/src/pages/ChatPage.tsx"
      to: "apps/desktop/src/stores/app-store.ts"
      via: "selectedAgentId state in store"
      pattern: "selectedAgentId"
    - from: "apps/desktop/src/hooks/useChat.ts"
      to: "apps/desktop/src/lib/gateway-client.ts"
      via: "agentId passed to createChatSendMessage"
      pattern: "agentId"
---

<objective>
Wire agent selection into desktop chat (send agentId in WS messages), remove the DEFAULT_AGENT constant from the agents page, and polish the dashboard layout with consistent spacing.

Purpose: Desktop users need to select which agent they're chatting with, and the UI should only show agents they've explicitly created via onboarding. Layout polish makes the app feel production-ready.

Output: Desktop chat with agent selector, clean agents page, polished layout spacing.
</objective>

<execution_context>
@/Users/hitekmedia/.claude/get-shit-done/workflows/execute-plan.md
@/Users/hitekmedia/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-agent-first-contact-dashboard-polish/22-RESEARCH.md
@.planning/phases/22-agent-first-contact-dashboard-polish/22-02-SUMMARY.md
@apps/desktop/src/lib/gateway-client.ts
@apps/desktop/src/lib/files.ts
@apps/desktop/src/hooks/useChat.ts
@apps/desktop/src/hooks/useIdentityFiles.ts
@apps/desktop/src/stores/app-store.ts
@apps/desktop/src/pages/ChatPage.tsx
@apps/desktop/src/pages/AgentsPage.tsx
@apps/desktop/src/components/Layout.tsx
@apps/desktop/src/components/Sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agentId to desktop chat flow and agent selector UI</name>
  <files>
    apps/desktop/src/lib/gateway-client.ts
    apps/desktop/src/hooks/useChat.ts
    apps/desktop/src/stores/app-store.ts
    apps/desktop/src/pages/ChatPage.tsx
  </files>
  <action>
1. In `apps/desktop/src/lib/gateway-client.ts`:
   - Add `agentId?: string` to the opts parameter of `createChatSendMessage`:
     ```typescript
     export function createChatSendMessage(
       content: string,
       opts?: { sessionId?: string; model?: string; agentId?: string },
     ): ClientMessage {
     ```
   - The spread `...opts` already handles including it in the message

2. In `apps/desktop/src/stores/app-store.ts`:
   - Add `selectedAgentId: string | null` to AppState interface
   - Add `setSelectedAgentId: (id: string | null) => void` to AppState interface
   - Initialize `selectedAgentId: null` in the store
   - Add setter: `setSelectedAgentId: (id) => set({ selectedAgentId: id })`

3. In `apps/desktop/src/hooks/useChat.ts`:
   - Add `agentId?: string` to `UseChatOptions` interface
   - In `sendMessage` callback, pass agentId to `createChatSendMessage`:
     ```typescript
     const wsMsg = createChatSendMessage(text, {
       sessionId: sessionId ?? undefined,
       agentId: optsRef.current.agentId,
     });
     ```

4. In `apps/desktop/src/pages/ChatPage.tsx`:
   - Import `useConfig` from `../hooks/useConfig`
   - Import `useAppStore` (already imported)
   - Read agents list from config: `const { config } = useConfig()`
   - Read `selectedAgentId` and `setSelectedAgentId` from app store
   - Derive agents array: `const agents = config?.agents?.list ?? []`
   - Auto-select: If `selectedAgentId` is null and agents.length > 0, set it to the first agent's id (or config's defaultAgentId if set)
   - Pass `agentId: selectedAgentId ?? undefined` to the `useChat` hook opts
   - Add an agent selector dropdown in the header bar, between the "Chat" title and the connection dot:
     ```tsx
     {agents.length > 0 && (
       <select
         value={selectedAgentId ?? ''}
         onChange={(e) => setSelectedAgentId(e.target.value || null)}
         className="bg-gray-800 border border-gray-700 rounded px-2 py-1 text-sm text-gray-200 focus:border-blue-500 focus:outline-none"
       >
         {agents.map((a) => (
           <option key={a.id} value={a.id}>{a.name ?? a.id}</option>
         ))}
       </select>
     )}
     ```
   - When no agents exist, show a prompt in the empty state: "Create an agent with 'tek onboard' in the terminal to start chatting"
  </action>
  <verify>
Verify agentId in gateway-client: `grep -n "agentId" apps/desktop/src/lib/gateway-client.ts`

Verify selectedAgentId in store: `grep -n "selectedAgentId" apps/desktop/src/stores/app-store.ts`

Verify agentId in useChat: `grep -n "agentId" apps/desktop/src/hooks/useChat.ts`

Verify agent selector in ChatPage: `grep -n "selectedAgentId\|select" apps/desktop/src/pages/ChatPage.tsx`
  </verify>
  <done>
Desktop chat sends agentId in every chat.send WS message. Agent selector dropdown in chat header allows switching agents. selectedAgentId persisted in app store. Auto-selects first/default agent on load. Empty state shows onboard prompt when no agents exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove DEFAULT_AGENT from agents page and polish layout spacing</name>
  <files>
    apps/desktop/src/pages/AgentsPage.tsx
    apps/desktop/src/lib/files.ts
    apps/desktop/src/hooks/useIdentityFiles.ts
    apps/desktop/src/components/Layout.tsx
    apps/desktop/src/components/Sidebar.tsx
  </files>
  <action>
1. In `apps/desktop/src/pages/AgentsPage.tsx`:
   - Remove the `DEFAULT_AGENT` constant entirely (lines 13-18)
   - Remove the `{/* Default agent card */}` line and `<AgentCard agent={DEFAULT_AGENT} ... />` (line 137)
   - In the detail view conditional (line 107), remove the `selectedAgentId === 'default'` check. Change:
     ```typescript
     const agent = selectedAgentId === 'default'
       ? DEFAULT_AGENT
       : agents.find((a) => a.id === selectedAgentId);
     ```
     to simply:
     ```typescript
     const agent = agents.find((a) => a.id === selectedAgentId);
     ```
   - In `handleCreate`, change the fallback `defaultAgentId` from `'default'` to `''`:
     ```typescript
     const currentAgents = config?.agents ?? { list: [], defaultAgentId: '' };
     ```
   - Update the empty state message (line 144-148) to:
     ```tsx
     {agents.length === 0 && (
       <p className="text-sm text-gray-500 text-center py-8">
         No agents yet. Create one above or run <code className="text-gray-400">tek onboard</code> in the terminal.
       </p>
     )}
     ```
   - In `DetailView`, remove the `agent.id === 'default'` checks (lines 306, 318):
     - Line 306: Change `const agentId = agent.id === 'default' ? undefined : agent.id;` to `const agentId = agent.id;`
     - Line 318: Change the `basePath` ternary to always use agent path: `const basePath = \`~/.config/tek/agents/${agent.id}\`;`

2. In `apps/desktop/src/lib/files.ts`:
   - Line 24: Change `if (agentId && agentId !== 'default')` to `if (agentId)` in `getIdentityDir()`
   - This aligns with the backend db layer changes from plan 22-02

3. In `apps/desktop/src/hooks/useIdentityFiles.ts`:
   - Line 15: Change `const agentKey = agentId ?? 'default'` to `const agentKey = agentId ?? 'global'`
   - This is just a cache key string; "global" is more accurate than "default" for the no-agent case

4. In `apps/desktop/src/components/Layout.tsx`:
   - Add a subtle left border/separator between sidebar and content:
     ```tsx
     <main className="flex-1 overflow-y-auto border-l border-gray-800">
       {children}
     </main>
     ```

5. In `apps/desktop/src/components/Sidebar.tsx`:
   - Add more vertical spacing between nav items (if using `space-y-1`, change to `space-y-2`)
   - Add top/bottom padding to the nav section if not present
   - Add a subtle app name or logo area at the top of the sidebar with "tek" text
   - Ensure the active page indicator has proper left padding alignment
  </action>
  <verify>
Verify no DEFAULT_AGENT: `grep -n "DEFAULT_AGENT\|=== 'default'" apps/desktop/src/pages/AgentsPage.tsx`

Verify files.ts updated: `grep -n "'default'" apps/desktop/src/lib/files.ts`

Verify useIdentityFiles updated: `grep -n "'default'" apps/desktop/src/hooks/useIdentityFiles.ts`

Verify Layout border: `grep -n "border-l" apps/desktop/src/components/Layout.tsx`
  </verify>
  <done>
No DEFAULT_AGENT constant or "default" card in agents page. Only user-created agents shown. Empty state shows helpful "tek onboard" prompt. Layout has proper border between sidebar and content. Sidebar has improved spacing. Desktop files.ts and useIdentityFiles.ts aligned with backend "default" removal.
  </done>
</task>

</tasks>

<verification>
1. No "default" agent card appears in desktop agents page
2. Desktop chat includes agentId in WS messages
3. Agent selector dropdown visible in chat header
4. Layout has consistent spacing and border between sidebar/content
5. Empty agents state shows helpful message
</verification>

<success_criteria>
- Desktop chat sends agentId in every chat.send message
- Agent selector in chat header shows all configured agents
- Switching agents in dropdown changes the agentId in subsequent messages
- No DEFAULT_AGENT or "default" card in agents page
- Agents page shows "No agents yet" empty state when list is empty
- Layout has border-l between sidebar and content area
- Sidebar nav items have improved vertical spacing
</success_criteria>

<output>
After completion, create `.planning/phases/22-agent-first-contact-dashboard-polish/22-03-SUMMARY.md`
</output>
